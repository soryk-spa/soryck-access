5599d920f2d418e594d4bef9a5ba0fe1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cache = exports.CacheService = void 0;
const ioredis_1 = require("ioredis");
const logger_1 = require("./logger");
// Redis configuration - supports both REDIS_URL (Vercel/Upstash) and individual env vars
const getRedisConfig = () => {
    // If REDIS_URL is provided (Vercel/Upstash format)
    if (process.env.REDIS_URL) {
        return {
            connectionName: 'vercel-redis',
            lazyConnect: true,
            retryDelayOnFailover: 100,
            enableReadyCheck: false,
            maxRetriesPerRequest: 3,
            // Optimizaciones de rendimiento
            connectTimeout: 60000,
            commandTimeout: 5000,
            keepAlive: 30000,
            // Pool de conexiones
            family: 4,
            // Configuraci√≥n de pipeline
            enableAutoPipelining: true,
            // Configuraci√≥n de compresi√≥n
            compression: 'gzip',
        };
    }
    // Fallback to individual environment variables
    return {
        host: process.env.REDIS_HOST || 'localhost',
        port: parseInt(process.env.REDIS_PORT || '6379'),
        password: process.env.REDIS_PASSWORD,
        db: parseInt(process.env.REDIS_DB || '0'),
        retryDelayOnFailover: 100,
        enableReadyCheck: false,
        maxRetriesPerRequest: 3,
        lazyConnect: true,
        // Optimizaciones de rendimiento
        connectTimeout: 60000,
        commandTimeout: 5000,
        keepAlive: 30000,
        // Pool de conexiones
        family: 4,
        // Configuraci√≥n de pipeline
        enableAutoPipelining: true,
    };
};
// Configuraci√≥n de Redis
const redis = process.env.REDIS_URL
    ? new ioredis_1.Redis(process.env.REDIS_URL, getRedisConfig())
    : new ioredis_1.Redis(getRedisConfig());
// Event listeners para logging
redis.on('connect', () => {
    logger_1.logger.info('‚úÖ Redis connected successfully');
});
redis.on('error', (error) => {
    logger_1.logger.error('‚ùå Redis connection error', error);
});
redis.on('close', () => {
    logger_1.logger.info('üîå Redis connection closed');
});
// Cache utilities
class CacheService {
    constructor() {
        this.redis = redis;
    }
    static getInstance() {
        if (!CacheService.instance) {
            CacheService.instance = new CacheService();
        }
        return CacheService.instance;
    }
    // M√©todos b√°sicos de cach√©
    async get(key) {
        try {
            const cached = await this.redis.get(key);
            return cached ? JSON.parse(cached) : null;
        }
        catch (error) {
            logger_1.logger.error(`Error getting cache key ${key}`, error);
            return null;
        }
    }
    async set(key, value, ttlSeconds) {
        try {
            const serialized = JSON.stringify(value);
            if (ttlSeconds) {
                await this.redis.setex(key, ttlSeconds, serialized);
            }
            else {
                await this.redis.set(key, serialized);
            }
        }
        catch (error) {
            logger_1.logger.error(`Error setting cache key ${key}`, error);
        }
    }
    async del(key) {
        try {
            await this.redis.del(key);
        }
        catch (error) {
            logger_1.logger.error(`Error deleting cache key ${key}`, error);
        }
    }
    async invalidatePattern(pattern) {
        try {
            const keys = await this.redis.keys(pattern);
            if (keys.length > 0) {
                await this.redis.del(...keys);
            }
        }
        catch (error) {
            logger_1.logger.error(`Error invalidating pattern ${pattern}`, error);
        }
    }
    // M√©todos espec√≠ficos para la aplicaci√≥n
    async getUserRole(clerkId) {
        return this.get(`user:role:${clerkId}`);
    }
    async setUserRole(clerkId, role, ttl = 3600) {
        await this.set(`user:role:${clerkId}`, role, ttl);
    }
    async getUserProfile(clerkId) {
        return this.get(`user:profile:${clerkId}`);
    }
    async setUserProfile(clerkId, profile, ttl = 1800) {
        await this.set(`user:profile:${clerkId}`, profile, ttl);
    }
    // Nuevos m√©todos optimizados para roles y permisos
    async getUserFullData(clerkId) {
        return this.get(`user:full:${clerkId}`);
    }
    async setUserFullData(clerkId, userData, ttl = 3600) {
        await this.set(`user:full:${clerkId}`, userData, ttl);
    }
    async getUserPermissions(clerkId) {
        return this.get(`user:permissions:${clerkId}`);
    }
    async setUserPermissions(clerkId, permissions, ttl = 3600) {
        await this.set(`user:permissions:${clerkId}`, permissions, ttl);
    }
    // Batch operations para mejorar rendimiento
    async setUserBatch(clerkId, userData, ttl = 3600) {
        const pipeline = this.redis.pipeline();
        pipeline.setex(`user:full:${clerkId}`, ttl, JSON.stringify(userData));
        pipeline.setex(`user:role:${clerkId}`, ttl, userData.role);
        pipeline.setex(`user:profile:${clerkId}`, ttl, JSON.stringify(userData));
        await pipeline.exec();
    }
    async invalidateUserCache(clerkId) {
        await this.invalidatePattern(`user:*:${clerkId}`);
    }
    async getEvents(query) {
        return this.get(`events:${query}`);
    }
    async setEvents(query, events, ttl = 600) {
        await this.set(`events:${query}`, events, ttl);
    }
    async invalidateEventsCache() {
        await this.invalidatePattern('events:*');
    }
    async getDashboardStats(userId) {
        return this.get(`dashboard:stats:${userId}`);
    }
    async setDashboardStats(userId, stats, ttl = 300) {
        await this.set(`dashboard:stats:${userId}`, stats, ttl);
    }
    async invalidateDashboardStats(userId) {
        if (userId) {
            await this.del(`dashboard:stats:${userId}`);
        }
        else {
            await this.invalidatePattern('dashboard:stats:*');
        }
    }
    // Contador de rate limiting
    async incrementRateLimit(key, windowSeconds, limit) {
        try {
            const current = await this.redis.incr(key);
            if (current === 1) {
                await this.redis.expire(key, windowSeconds);
            }
            return {
                allowed: current <= limit,
                remaining: Math.max(0, limit - current)
            };
        }
        catch (error) {
            logger_1.logger.error(`Error checking rate limit for ${key}`, error);
            return { allowed: true, remaining: limit };
        }
    }
    // Session cache (para datos temporales de sesi√≥n)
    async setSession(sessionId, data, ttl = 86400) {
        await this.set(`session:${sessionId}`, data, ttl);
    }
    async getSession(sessionId) {
        return this.get(`session:${sessionId}`);
    }
    async deleteSession(sessionId) {
        await this.del(`session:${sessionId}`);
    }
    // Health check
    async ping() {
        try {
            const response = await this.redis.ping();
            return response === 'PONG';
        }
        catch (error) {
            logger_1.logger.error('Redis ping failed', error);
            return false;
        }
    }
    // Graceful shutdown
    async disconnect() {
        try {
            await this.redis.quit();
        }
        catch (error) {
            logger_1.logger.error('Error disconnecting from Redis:', error);
        }
    }
}
exports.CacheService = CacheService;
// Export singleton instance
exports.cache = CacheService.getInstance();
exports.default = redis;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxsaWJcXHJlZGlzLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFnQztBQUNoQyxxQ0FBa0M7QUEyQ2xDLHlGQUF5RjtBQUN6RixNQUFNLGNBQWMsR0FBRyxHQUFHLEVBQUU7SUFDMUIsbURBQW1EO0lBQ25ELElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMxQixPQUFPO1lBQ0wsY0FBYyxFQUFFLGNBQWM7WUFDOUIsV0FBVyxFQUFFLElBQUk7WUFDakIsb0JBQW9CLEVBQUUsR0FBRztZQUN6QixnQkFBZ0IsRUFBRSxLQUFLO1lBQ3ZCLG9CQUFvQixFQUFFLENBQUM7WUFDdkIsZ0NBQWdDO1lBQ2hDLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLGNBQWMsRUFBRSxJQUFJO1lBQ3BCLFNBQVMsRUFBRSxLQUFLO1lBQ2hCLHFCQUFxQjtZQUNyQixNQUFNLEVBQUUsQ0FBQztZQUNULDRCQUE0QjtZQUM1QixvQkFBb0IsRUFBRSxJQUFJO1lBQzFCLDhCQUE4QjtZQUM5QixXQUFXLEVBQUUsTUFBTTtTQUNwQixDQUFDO0lBQ0osQ0FBQztJQUVELCtDQUErQztJQUMvQyxPQUFPO1FBQ0wsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVc7UUFDM0MsSUFBSSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUM7UUFDaEQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztRQUNwQyxFQUFFLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQztRQUN6QyxvQkFBb0IsRUFBRSxHQUFHO1FBQ3pCLGdCQUFnQixFQUFFLEtBQUs7UUFDdkIsb0JBQW9CLEVBQUUsQ0FBQztRQUN2QixXQUFXLEVBQUUsSUFBSTtRQUNqQixn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Q0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsU0FBaUI7UUFDaEMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxTQUFpQjtRQUNuQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxlQUFlO0lBQ2YsS0FBSyxDQUFDLElBQUk7UUFDUixJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDekMsT0FBTyxRQUFRLEtBQUssTUFBTSxDQUFDO1FBQzdCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ25CLGVBQU0sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsS0FBYyxDQUFDLENBQUM7WUFDOUMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUVELG9CQUFvQjtJQUNwQixLQUFLLENBQUMsVUFBVTtRQUNkLElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQWMsQ0FBQyxDQUFDO1FBQzlELENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF2TEQsb0NBdUxDO0FBRUQsNEJBQTRCO0FBQ2YsUUFBQSxLQUFLLEdBQUcsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ2hELGtCQUFlLEtBQUssQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEJpbHVyXFxEb2N1bWVudHNcXERldmVsb3BtZW50XFxOZXh0XFxzb3J5Y2stYWNjZXNzXFxzcmNcXGxpYlxccmVkaXMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVkaXMgfSBmcm9tICdpb3JlZGlzJztcclxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xyXG5cclxuLy8gVHlwZXNcclxuZXhwb3J0IGludGVyZmFjZSBVc2VyUHJvZmlsZSB7XHJcbiAgaWQ6IHN0cmluZztcclxuICBjbGVya0lkOiBzdHJpbmc7XHJcbiAgZW1haWw6IHN0cmluZztcclxuICBmaXJzdE5hbWU/OiBzdHJpbmc7XHJcbiAgbGFzdE5hbWU/OiBzdHJpbmc7XHJcbiAgYmlvPzogc3RyaW5nO1xyXG4gIHByb2R1Y2VyTmFtZT86IHN0cmluZztcclxuICB3ZWJzaXRlVXJsPzogc3RyaW5nO1xyXG4gIHR3aXR0ZXJVcmw/OiBzdHJpbmc7XHJcbiAgaW5zdGFncmFtVXJsPzogc3RyaW5nO1xyXG4gIHJvbGU6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBVc2VyUGVybWlzc2lvbnMge1xyXG4gIGNhbkNyZWF0ZUV2ZW50czogYm9vbGVhbjtcclxuICBjYW5BY2Nlc3NBZG1pbjogYm9vbGVhbjtcclxuICBjYW5TY2FuVGlja2V0czogYm9vbGVhbjtcclxuICBjYW5NYW5hZ2VVc2VyczogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBNb250aGx5U3RhdHMge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICBpbmdyZXNvczogbnVtYmVyO1xyXG4gIGV2ZW50b3M6IG51bWJlcjtcclxuICB0aWNrZXRzOiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIERhc2hib2FyZFN0YXRzID0gTW9udGhseVN0YXRzW107XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50RGF0YSB7XHJcbiAgaWQ6IHN0cmluZztcclxuICB0aXRsZTogc3RyaW5nO1xyXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xyXG4gIHN0YXJ0RGF0ZTogRGF0ZTtcclxuICBlbmREYXRlOiBEYXRlO1xyXG4gIGNhdGVnb3J5SWQ6IHN0cmluZztcclxuICBvcmdhbml6ZXJJZDogc3RyaW5nO1xyXG59XHJcblxyXG4vLyBSZWRpcyBjb25maWd1cmF0aW9uIC0gc3VwcG9ydHMgYm90aCBSRURJU19VUkwgKFZlcmNlbC9VcHN0YXNoKSBhbmQgaW5kaXZpZHVhbCBlbnYgdmFyc1xyXG5jb25zdCBnZXRSZWRpc0NvbmZpZyA9ICgpID0+IHtcclxuICAvLyBJZiBSRURJU19VUkwgaXMgcHJvdmlkZWQgKFZlcmNlbC9VcHN0YXNoIGZvcm1hdClcclxuICBpZiAocHJvY2Vzcy5lbnYuUkVESVNfVVJMKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBjb25uZWN0aW9uTmFtZTogJ3ZlcmNlbC1yZWRpcycsXHJcbiAgICAgIGxhenlDb25uZWN0OiB0cnVlLFxyXG4gICAgICByZXRyeURlbGF5T25GYWlsb3ZlcjogMTAwLFxyXG4gICAgICBlbmFibGVSZWFkeUNoZWNrOiBmYWxzZSxcclxuICAgICAgbWF4UmV0cmllc1BlclJlcXVlc3Q6IDMsXHJcbiAgICAgIC8vIE9wdGltaXphY2lvbmVzIGRlIHJlbmRpbWllbnRvXHJcbiAgICAgIGNvbm5lY3RUaW1lb3V0OiA2MDAwMCxcclxuICAgICAgY29tbWFuZFRpbWVvdXQ6IDUwMDAsXHJcbiAgICAgIGtlZXBBbGl2ZTogMzAwMDAsXHJcbiAgICAgIC8vIFBvb2wgZGUgY29uZXhpb25lc1xyXG4gICAgICBmYW1pbHk6IDQsXHJcbiAgICAgIC8vIENvbmZpZ3VyYWNpw7NuIGRlIHBpcGVsaW5lXHJcbiAgICAgIGVuYWJsZUF1dG9QaXBlbGluaW5nOiB0cnVlLFxyXG4gICAgICAvLyBDb25maWd1cmFjacOzbiBkZSBjb21wcmVzacOzblxyXG4gICAgICBjb21wcmVzc2lvbjogJ2d6aXAnLFxyXG4gICAgfTtcclxuICB9XHJcbiAgXHJcbiAgLy8gRmFsbGJhY2sgdG8gaW5kaXZpZHVhbCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcclxuICByZXR1cm4ge1xyXG4gICAgaG9zdDogcHJvY2Vzcy5lbnYuUkVESVNfSE9TVCB8fCAnbG9jYWxob3N0JyxcclxuICAgIHBvcnQ6IHBhcnNlSW50KHByb2Nlc3MuZW52LlJFRElTX1BPUlQgfHwgJzYzNzknKSxcclxuICAgIHBhc3N3b3JkOiBwcm9jZXNzLmVudi5SRURJU19QQVNTV09SRCxcclxuICAgIGRiOiBwYXJzZUludChwcm9jZXNzLmVudi5SRURJU19EQiB8fCAnMCcpLFxyXG4gICAgcmV0cnlEZWxheU9uRmFpbG92ZXI6IDEwMCxcclxuICAgIGVuYWJsZVJlYWR5Q2hlY2s6IGZhbHNlLFxyXG4gICAgbWF4UmV0cmllc1BlclJlcXVlc3Q6IDMsXHJcbiAgICBsYXp5Q29ubmVjdDogdHJ1ZSxcclxuICAgIC8vIE9wdGltaXphY2lvbmVzIGRlIHJlbmRpbWllbnRvXHJcbiAgICBjb25uZWN0VGltZW91dDogNjAwMDAsXHJcbiAgICBjb21tYW5kVGltZW91dDogNTAwMCxcclxuICAgIGtlZXBBbGl2ZTogMzAwMDAsXHJcbiAgICAvLyBQb29sIGRlIGNvbmV4aW9uZXNcclxuICAgIGZhbWlseTogNCxcclxuICAgIC8vIENvbmZpZ3VyYWNpw7NuIGRlIHBpcGVsaW5lXHJcbiAgICBlbmFibGVBdXRvUGlwZWxpbmluZzogdHJ1ZSxcclxuICB9O1xyXG59O1xyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgUmVkaXNcclxuY29uc3QgcmVkaXMgPSBwcm9jZXNzLmVudi5SRURJU19VUkwgXHJcbiAgPyBuZXcgUmVkaXMocHJvY2Vzcy5lbnYuUkVESVNfVVJMLCBnZXRSZWRpc0NvbmZpZygpKVxyXG4gIDogbmV3IFJlZGlzKGdldFJlZGlzQ29uZmlnKCkpO1xyXG5cclxuLy8gRXZlbnQgbGlzdGVuZXJzIHBhcmEgbG9nZ2luZ1xyXG5yZWRpcy5vbignY29ubmVjdCcsICgpID0+IHtcclxuICBsb2dnZXIuaW5mbygn4pyFIFJlZGlzIGNvbm5lY3RlZCBzdWNjZXNzZnVsbHknKTtcclxufSk7XHJcblxyXG5yZWRpcy5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcclxuICBsb2dnZXIuZXJyb3IoJ+KdjCBSZWRpcyBjb25uZWN0aW9uIGVycm9yJywgZXJyb3IpO1xyXG59KTtcclxuXHJcbnJlZGlzLm9uKCdjbG9zZScsICgpID0+IHtcclxuICBsb2dnZXIuaW5mbygn8J+UjCBSZWRpcyBjb25uZWN0aW9uIGNsb3NlZCcpO1xyXG59KTtcclxuXHJcbi8vIENhY2hlIHV0aWxpdGllc1xyXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIHtcclxuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogQ2FjaGVTZXJ2aWNlO1xyXG4gIHByaXZhdGUgcmVkaXM6IFJlZGlzO1xyXG5cclxuICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5yZWRpcyA9IHJlZGlzO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBDYWNoZVNlcnZpY2Uge1xyXG4gICAgaWYgKCFDYWNoZVNlcnZpY2UuaW5zdGFuY2UpIHtcclxuICAgICAgQ2FjaGVTZXJ2aWNlLmluc3RhbmNlID0gbmV3IENhY2hlU2VydmljZSgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIENhY2hlU2VydmljZS5pbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIC8vIE3DqXRvZG9zIGLDoXNpY29zIGRlIGNhY2jDqVxyXG4gIGFzeW5jIGdldDxUPihrZXk6IHN0cmluZyk6IFByb21pc2U8VCB8IG51bGw+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHRoaXMucmVkaXMuZ2V0KGtleSk7XHJcbiAgICAgIHJldHVybiBjYWNoZWQgPyBKU09OLnBhcnNlKGNhY2hlZCkgOiBudWxsO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoYEVycm9yIGdldHRpbmcgY2FjaGUga2V5ICR7a2V5fWAsIGVycm9yIGFzIEVycm9yKTtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiB1bmtub3duLCB0dGxTZWNvbmRzPzogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBzZXJpYWxpemVkID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xyXG4gICAgICBpZiAodHRsU2Vjb25kcykge1xyXG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXMuc2V0ZXgoa2V5LCB0dGxTZWNvbmRzLCBzZXJpYWxpemVkKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLnNldChrZXksIHNlcmlhbGl6ZWQpO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcihgRXJyb3Igc2V0dGluZyBjYWNoZSBrZXkgJHtrZXl9YCwgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGVsKGtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCB0aGlzLnJlZGlzLmRlbChrZXkpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoYEVycm9yIGRlbGV0aW5nIGNhY2hlIGtleSAke2tleX1gLCBlcnJvciBhcyBFcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbnZhbGlkYXRlUGF0dGVybihwYXR0ZXJuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGtleXMgPSBhd2FpdCB0aGlzLnJlZGlzLmtleXMocGF0dGVybik7XHJcbiAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLmRlbCguLi5rZXlzKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoYEVycm9yIGludmFsaWRhdGluZyBwYXR0ZXJuICR7cGF0dGVybn1gLCBlcnJvciBhcyBFcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBNw6l0b2RvcyBlc3BlY8OtZmljb3MgcGFyYSBsYSBhcGxpY2FjacOzblxyXG4gIGFzeW5jIGdldFVzZXJSb2xlKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGB1c2VyOnJvbGU6JHtjbGVya0lkfWApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2V0VXNlclJvbGUoY2xlcmtJZDogc3RyaW5nLCByb2xlOiBzdHJpbmcsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGB1c2VyOnJvbGU6JHtjbGVya0lkfWAsIHJvbGUsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRVc2VyUHJvZmlsZShjbGVya0lkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXJQcm9maWxlIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGB1c2VyOnByb2ZpbGU6JHtjbGVya0lkfWApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2V0VXNlclByb2ZpbGUoY2xlcmtJZDogc3RyaW5nLCBwcm9maWxlOiBVc2VyUHJvZmlsZSwgdHRsID0gMTgwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zZXQoYHVzZXI6cHJvZmlsZToke2NsZXJrSWR9YCwgcHJvZmlsZSwgdHRsKTtcclxuICB9XHJcblxyXG4gIC8vIE51ZXZvcyBtw6l0b2RvcyBvcHRpbWl6YWRvcyBwYXJhIHJvbGVzIHkgcGVybWlzb3NcclxuICBhc3luYyBnZXRVc2VyRnVsbERhdGEoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyUHJvZmlsZSB8IG51bGw+IHtcclxuICAgIHJldHVybiB0aGlzLmdldChgdXNlcjpmdWxsOiR7Y2xlcmtJZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldFVzZXJGdWxsRGF0YShjbGVya0lkOiBzdHJpbmcsIHVzZXJEYXRhOiBVc2VyUHJvZmlsZSwgdHRsID0gMzYwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zZXQoYHVzZXI6ZnVsbDoke2NsZXJrSWR9YCwgdXNlckRhdGEsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRVc2VyUGVybWlzc2lvbnMoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyUGVybWlzc2lvbnMgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHVzZXI6cGVybWlzc2lvbnM6JHtjbGVya0lkfWApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2V0VXNlclBlcm1pc3Npb25zKGNsZXJrSWQ6IHN0cmluZywgcGVybWlzc2lvbnM6IFVzZXJQZXJtaXNzaW9ucywgdHRsID0gMzYwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zZXQoYHVzZXI6cGVybWlzc2lvbnM6JHtjbGVya0lkfWAsIHBlcm1pc3Npb25zLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgLy8gQmF0Y2ggb3BlcmF0aW9ucyBwYXJhIG1lam9yYXIgcmVuZGltaWVudG9cclxuICBhc3luYyBzZXRVc2VyQmF0Y2goY2xlcmtJZDogc3RyaW5nLCB1c2VyRGF0YTogVXNlclByb2ZpbGUsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHBpcGVsaW5lID0gdGhpcy5yZWRpcy5waXBlbGluZSgpO1xyXG4gICAgcGlwZWxpbmUuc2V0ZXgoYHVzZXI6ZnVsbDoke2NsZXJrSWR9YCwgdHRsLCBKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpO1xyXG4gICAgcGlwZWxpbmUuc2V0ZXgoYHVzZXI6cm9sZToke2NsZXJrSWR9YCwgdHRsLCB1c2VyRGF0YS5yb2xlKTtcclxuICAgIHBpcGVsaW5lLnNldGV4KGB1c2VyOnByb2ZpbGU6JHtjbGVya0lkfWAsIHR0bCwgSlNPTi5zdHJpbmdpZnkodXNlckRhdGEpKTtcclxuICAgIGF3YWl0IHBpcGVsaW5lLmV4ZWMoKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGludmFsaWRhdGVVc2VyQ2FjaGUoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVQYXR0ZXJuKGB1c2VyOio6JHtjbGVya0lkfWApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RXZlbnRzKHF1ZXJ5OiBzdHJpbmcpOiBQcm9taXNlPEV2ZW50RGF0YVtdIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGBldmVudHM6JHtxdWVyeX1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldEV2ZW50cyhxdWVyeTogc3RyaW5nLCBldmVudHM6IEV2ZW50RGF0YVtdLCB0dGwgPSA2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGBldmVudHM6JHtxdWVyeX1gLCBldmVudHMsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbnZhbGlkYXRlRXZlbnRzQ2FjaGUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVQYXR0ZXJuKCdldmVudHM6KicpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RGFzaGJvYXJkU3RhdHModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPERhc2hib2FyZFN0YXRzIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGBkYXNoYm9hcmQ6c3RhdHM6JHt1c2VySWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXREYXNoYm9hcmRTdGF0cyh1c2VySWQ6IHN0cmluZywgc3RhdHM6IERhc2hib2FyZFN0YXRzLCB0dGwgPSAzMDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGBkYXNoYm9hcmQ6c3RhdHM6JHt1c2VySWR9YCwgc3RhdHMsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbnZhbGlkYXRlRGFzaGJvYXJkU3RhdHModXNlcklkPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAodXNlcklkKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuZGVsKGBkYXNoYm9hcmQ6c3RhdHM6JHt1c2VySWR9YCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVQYXR0ZXJuKCdkYXNoYm9hcmQ6c3RhdHM6KicpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gQ29udGFkb3IgZGUgcmF0ZSBsaW1pdGluZ1xyXG4gIGFzeW5jIGluY3JlbWVudFJhdGVMaW1pdChrZXk6IHN0cmluZywgd2luZG93U2Vjb25kczogbnVtYmVyLCBsaW1pdDogbnVtYmVyKTogUHJvbWlzZTx7IGFsbG93ZWQ6IGJvb2xlYW47IHJlbWFpbmluZzogbnVtYmVyIH0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSBhd2FpdCB0aGlzLnJlZGlzLmluY3Ioa2V5KTtcclxuICAgICAgaWYgKGN1cnJlbnQgPT09IDEpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLmV4cGlyZShrZXksIHdpbmRvd1NlY29uZHMpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGFsbG93ZWQ6IGN1cnJlbnQgPD0gbGltaXQsXHJcbiAgICAgICAgcmVtYWluaW5nOiBNYXRoLm1heCgwLCBsaW1pdCAtIGN1cnJlbnQpXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcihgRXJyb3IgY2hlY2tpbmcgcmF0ZSBsaW1pdCBmb3IgJHtrZXl9YCwgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBhbGxvd2VkOiB0cnVlLCByZW1haW5pbmc6IGxpbWl0IH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBTZXNzaW9uIGNhY2hlIChwYXJhIGRhdG9zIHRlbXBvcmFsZXMgZGUgc2VzacOzbilcclxuICBhc3luYyBzZXRTZXNzaW9uKHNlc3Npb25JZDogc3RyaW5nLCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgdHRsID0gODY0MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGBzZXNzaW9uOiR7c2Vzc2lvbklkfWAsIGRhdGEsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRTZXNzaW9uKHNlc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB8IG51bGw+IHtcclxuICAgIHJldHVybiB0aGlzLmdldChgc2Vzc2lvbjoke3Nlc3Npb25JZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuZGVsKGBzZXNzaW9uOiR7c2Vzc2lvbklkfWApO1xyXG4gIH1cclxuXHJcbiAgLy8gSGVhbHRoIGNoZWNrXHJcbiAgYXN5bmMgcGluZygpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5yZWRpcy5waW5nKCk7XHJcbiAgICAgIHJldHVybiByZXNwb25zZSA9PT0gJ1BPTkcnO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoJ1JlZGlzIHBpbmcgZmFpbGVkJywgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBHcmFjZWZ1bCBzaHV0ZG93blxyXG4gIGFzeW5jIGRpc2Nvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCB0aGlzLnJlZGlzLnF1aXQoKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgbG9nZ2VyLmVycm9yKCdFcnJvciBkaXNjb25uZWN0aW5nIGZyb20gUmVkaXM6JywgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8gRXhwb3J0IHNpbmdsZXRvbiBpbnN0YW5jZVxyXG5leHBvcnQgY29uc3QgY2FjaGUgPSBDYWNoZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuZXhwb3J0IGRlZmF1bHQgcmVkaXM7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==