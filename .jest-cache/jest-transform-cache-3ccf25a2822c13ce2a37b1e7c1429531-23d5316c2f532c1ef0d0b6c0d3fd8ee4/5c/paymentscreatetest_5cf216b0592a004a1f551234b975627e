c7b2a12b5e2dda1c8ab3824c0d7d122f
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable @typescript-eslint/no-explicit-any */
jest.mock('next/server', () => ({ NextResponse: { json: (body, opts) => ({ status: (opts === null || opts === void 0 ? void 0 : opts.status) || 200, body }) } }));
jest.mock('@/lib/auth', () => ({ requireAuth: jest.fn().mockResolvedValue(mockUser) }));
jest.mock('@/lib/transbank', () => ({ webpayPlus: mockWebpay }));
jest.mock('@/lib/commission', () => mockCalculate);
jest.mock('@/lib/discount-codes', () => mockDiscount);
jest.mock('@/lib/prisma', () => ({ prisma: mockPrisma }));
jest.mock('@/lib/qr', () => ({ generateUniqueQRCode: jest.fn().mockReturnValue('QR123') }));
jest.mock('@/lib/email', () => ({ sendTicketEmail: jest.fn() }));
// Mocks
const mockUser = { id: 'user_1', email: 'u@u.com', firstName: 'U' };
const mockWebpay = { create: jest.fn() };
const mockCalculate = {
    calculatePriceBreakdown: jest.fn(),
    calculatePriceBreakdownWithDiscount: jest.fn()
};
const mockDiscount = {
    DiscountCodeService: {
        validateDiscountCode: jest.fn(),
        applyCodeUsage: jest.fn()
    }
};
const mockPrisma = {
    ticketType: { findUnique: jest.fn() },
    ticket: { count: jest.fn() },
    order: { create: jest.fn(), update: jest.fn(), findUnique: jest.fn() },
    payment: { create: jest.fn() },
    $transaction: jest.fn()
};
describe('POST /api/payments/create', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    it('returns 400 when body is invalid', async () => {
        // requireAuth will resolve to mockUser
        const req = { json: async () => ({ quantity: 2 }) };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        expect(res.status).toBe(400);
        expect(res.body.error).toBeDefined();
    });
    it('creates a payment and returns transbank url and token for paid order', async () => {
        // Setup ticket type and event
        const ticketType = {
            id: 'tt1',
            price: 5000,
            ticketsGenerated: 1,
            capacity: 100,
            event: { id: 'e1', isPublished: true, currency: 'CLP' }
        };
        mockPrisma.ticketType.findUnique.mockResolvedValue(ticketType);
        mockPrisma.ticket.count.mockResolvedValue(0);
        // Price breakdown
        mockCalculate.calculatePriceBreakdown.mockReturnValue({ basePrice: 5000, commission: 0, totalPrice: 5000, originalAmount: 5000, discountAmount: 0 });
        // Order creation
        const createdOrder = { id: 'order_1', orderNumber: 'SP123', quantity: 1 };
        mockPrisma.order.create.mockResolvedValue(createdOrder);
        // Webpay responds
        mockWebpay.create.mockResolvedValue({ url: 'https://webpay.test/checkout', token: 'tok_123' });
        // Payment create
        mockPrisma.payment.create.mockResolvedValue({ id: 'pay_1' });
        const reqBody = { ticketTypeId: 'tt1', quantity: 1 };
        const req = { json: async () => reqBody };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        expect(res.status).toBe(200);
        expect(res.body.success).toBe(true);
        expect(res.body.paymentUrl).toBe('https://webpay.test/checkout');
        expect(res.body.token).toBe('tok_123');
        expect(mockWebpay.create).toHaveBeenCalled();
        expect(mockPrisma.payment.create).toHaveBeenCalled();
    });
    it('applies promo code for a discounted paid order', async () => {
        const ticketType = {
            id: 'tt1',
            price: 5000,
            ticketsGenerated: 1,
            capacity: 100,
            event: { id: 'e1', isPublished: true, currency: 'CLP' }
        };
        mockPrisma.ticketType.findUnique.mockResolvedValueOnce(ticketType);
        mockPrisma.ticket.count.mockResolvedValueOnce(0);
        // promo gives 1000 CLP off
        const discountAmount = 1000;
        mockDiscount.DiscountCodeService.validateDiscountCode.mockResolvedValueOnce({ isValid: true, discountAmount, code: 'PROMO1', type: 'FIXED' });
        mockCalculate.calculatePriceBreakdownWithDiscount.mockReturnValueOnce({ basePrice: 4000, commission: 0, totalPrice: 4000, originalAmount: 5000, discountAmount });
        const createdOrder = { id: 'order_2', orderNumber: 'SP124', quantity: 1 };
        mockPrisma.order.create.mockResolvedValueOnce(createdOrder);
        mockWebpay.create.mockResolvedValueOnce({ url: 'https://webpay.test/checkout2', token: 'tok_456' });
        mockPrisma.payment.create.mockResolvedValueOnce({ id: 'pay_2' });
        const reqBody = { ticketTypeId: 'tt1', quantity: 1, promoCode: 'PROMO1' };
        const req = { json: async () => reqBody };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        expect(res.status).toBe(200);
        expect(res.body.success).toBe(true);
        expect(res.body.priceBreakdown.promoCode).toBe('PROMO1');
        expect(mockDiscount.DiscountCodeService.validateDiscountCode).toHaveBeenCalled();
        expect(mockWebpay.create).toHaveBeenCalled();
    });
    it('processes free-ticket flow (final total 0) and generates tickets', async () => {
        const ticketType = {
            id: 'tt_free',
            price: 5000,
            ticketsGenerated: 1,
            capacity: 100,
            event: { id: 'e_free', isPublished: true, currency: 'CLP' }
        };
        mockPrisma.ticketType.findUnique.mockResolvedValueOnce(ticketType);
        mockPrisma.ticket.count.mockResolvedValueOnce(0);
        const baseTotal = 5000;
        // promo gives full discount so final total 0
        mockDiscount.DiscountCodeService.validateDiscountCode.mockResolvedValueOnce({ isValid: true, discountAmount: baseTotal, code: 'FREE100', type: 'FIXED' });
        mockCalculate.calculatePriceBreakdownWithDiscount.mockReturnValueOnce({ basePrice: 0, commission: 0, totalPrice: 0, originalAmount: baseTotal, discountAmount: baseTotal });
        const createdOrder = { id: 'order_free', orderNumber: 'SPFREE', quantity: 1 };
        mockPrisma.order.create.mockResolvedValueOnce(createdOrder);
        // $transaction returns [resultOfCreateMany, updatedOrder]
        const updatedOrder = { id: createdOrder.id, tickets: [{ qrCode: 'QR1' }] };
        mockPrisma.$transaction.mockResolvedValueOnce([null, updatedOrder]);
        const reqBody = { ticketTypeId: 'tt_free', quantity: 1, promoCode: 'FREE100' };
        const req = { json: async () => reqBody };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        // Mock event lookup used in handleAndGenerateTickets
        const eventWithOrganizer = {
            id: ticketType.event.id,
            title: 'Free Event',
            startDate: new Date(),
            location: 'Online',
            organizer: { id: 'org1', name: 'Org' }
        };
        // ensure prisma.event.findUnique exists on the mock
        mockPrisma.event = { findUnique: jest.fn().mockResolvedValueOnce(eventWithOrganizer) };
        expect(res.status).toBe(200);
        expect(res.body.isFree).toBe(true);
        expect(res.body.ticketsGenerated).toBeGreaterThan(0);
        expect(mockDiscount.DiscountCodeService.applyCodeUsage).toHaveBeenCalled();
        expect(mockPrisma.$transaction).toHaveBeenCalled();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxfX3Rlc3RzX19cXGFwaVxccGF5bWVudHMuY3JlYXRlLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1REFBdUQ7QUFDdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLElBQVMsRUFBRSxJQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsTUFBTSxLQUFJLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFJaEksSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFHdkYsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQU1oRSxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBUWxELElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUE7QUFTckQsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFFekQsSUFBSSxDQUFDLElB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Q3JCLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLFNBQVMsRUFBRSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRTtTQUN2QyxDQUFBO1FBQ0Qsb0RBQW9EO1FBQ3BELFVBQVUsQ0FBQyxLQUFLLEdBQUcsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQTtRQUV0RixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM5QixNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDcEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1FBQzFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtJQUNsRCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQmlsdXJcXERvY3VtZW50c1xcRGV2ZWxvcG1lbnRcXE5leHRcXHNvcnljay1hY2Nlc3NcXHNyY1xcX190ZXN0c19fXFxhcGlcXHBheW1lbnRzLmNyZWF0ZS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cclxuamVzdC5tb2NrKCduZXh0L3NlcnZlcicsICgpID0+ICh7IE5leHRSZXNwb25zZTogeyBqc29uOiAoYm9keTogYW55LCBvcHRzPzogYW55KSA9PiAoeyBzdGF0dXM6IG9wdHM/LnN0YXR1cyB8fCAyMDAsIGJvZHkgfSkgfSB9KSlcclxuXHJcbi8vIE1vY2tzXHJcbmNvbnN0IG1vY2tVc2VyID0geyBpZDogJ3VzZXJfMScsIGVtYWlsOiAndUB1LmNvbScsIGZpcnN0TmFtZTogJ1UnIH1cclxuamVzdC5tb2NrKCdAL2xpYi9hdXRoJywgKCkgPT4gKHsgcmVxdWlyZUF1dGg6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcikgfSkpXHJcblxyXG5jb25zdCBtb2NrV2VicGF5ID0geyBjcmVhdGU6IGplc3QuZm4oKSB9XHJcbmplc3QubW9jaygnQC9saWIvdHJhbnNiYW5rJywgKCkgPT4gKHsgd2VicGF5UGx1czogbW9ja1dlYnBheSB9KSlcclxuXHJcbmNvbnN0IG1vY2tDYWxjdWxhdGUgPSB7XHJcbiAgY2FsY3VsYXRlUHJpY2VCcmVha2Rvd246IGplc3QuZm4oKSxcclxuICBjYWxjdWxhdGVQcmljZUJyZWFrZG93bldpdGhEaXNjb3VudDogamVzdC5mbigpXHJcbn1cclxuamVzdC5tb2NrKCdAL2xpYi9jb21taXNzaW9uJywgKCkgPT4gbW9ja0NhbGN1bGF0ZSlcclxuXHJcbmNvbnN0IG1vY2tEaXNjb3VudCA9IHtcclxuICBEaXNjb3VudENvZGVTZXJ2aWNlOiB7XHJcbiAgICB2YWxpZGF0ZURpc2NvdW50Q29kZTogamVzdC5mbigpLFxyXG4gICAgYXBwbHlDb2RlVXNhZ2U6IGplc3QuZm4oKVxyXG4gIH1cclxufVxyXG5qZXN0Lm1vY2soJ0AvbGliL2Rpc2NvdW50LWNvZGVzJywgKCkgPT4gbW9ja0Rpc2NvdW50KVxyXG5cclxuY29uc3QgbW9ja1ByaXNtYSA9IHtcclxuICB0aWNrZXRUeXBlOiB7IGZpbmRVbmlxdWU6IGplc3QuZm4oKSB9LFxyXG4gIHRpY2tldDogeyBjb3VudDogamVzdC5mbigpIH0sXHJcbiAgb3JkZXI6IHsgY3JlYXRlOiBqZXN0LmZuKCksIHVwZGF0ZTogamVzdC5mbigpLCBmaW5kVW5pcXVlOiBqZXN0LmZuKCkgfSxcclxuICBwYXltZW50OiB7IGNyZWF0ZTogamVzdC5mbigpIH0sXHJcbiAgJHRyYW5zYWN0aW9uOiBqZXN0LmZuKClcclxufVxyXG5qZXN0Lm1vY2soJ0AvbGliL3ByaXNtYScsICgpID0+ICh7IHByaXNtYTogbW9ja1ByaXNtYSB9KSlcclxuXHJcbmplc3QubW9jaygnQC9saWIvcXInLCAoKSA9PiAoeyBnZW5lcmF0ZVVuaXF1ZVFSQ29kZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSgnUVIxMjMnKSB9KSlcclxuamVzdC5tb2NrKCdAL2xpYi9lbWFpbCcsICgpID0+ICh7IHNlbmRUaWNrZXRFbWFpbDogamVzdC5mbigpIH0pKVxyXG5cclxuaW1wb3J0IHsgcmVxdWlyZUF1dGggfSBmcm9tICdAL2xpYi9hdXRoJ1xyXG5pbXBvcnQgdHlwZSB7IE5leHRSZXF1ZXN0IH0gZnJvbSAnbmV4dC9zZXJ2ZXInXHJcblxyXG4vLyBNaW5pbWFsIHJlc3BvbnNlIHNoYXBlIHVzZWQgYnkgdGhlIG1vY2tlZCBOZXh0UmVzcG9uc2UgaW4gdGVzdHNcclxudHlwZSBSZXNwb25zZUxpa2UgPSB7IHN0YXR1czogbnVtYmVyOyBib2R5OiBhbnkgfVxyXG5cclxuZGVzY3JpYmUoJ1BPU1QgL2FwaS9wYXltZW50cy9jcmVhdGUnLCAoKSA9PiB7XHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxyXG4gIH0pXHJcblxyXG4gIGl0KCdyZXR1cm5zIDQwMCB3aGVuIGJvZHkgaXMgaW52YWxpZCcsIGFzeW5jICgpID0+IHtcclxuICAgIC8vIHJlcXVpcmVBdXRoIHdpbGwgcmVzb2x2ZSB0byBtb2NrVXNlclxyXG4gICAgY29uc3QgcmVxID0geyBqc29uOiBhc3luYyAoKSA9PiAoeyBxdWFudGl0eTogMiB9KSB9XHJcbiAgY29uc3QgeyBQT1NUIH0gPSBhd2FpdCBpbXBvcnQoJy4uLy4uLy4uL3NyYy9hcHAvYXBpL3BheW1lbnRzL2NyZWF0ZS9yb3V0ZScpXHJcbiAgY29uc3QgcmVzID0gKGF3YWl0IFBPU1QocmVxIGFzIHVua25vd24gYXMgTmV4dFJlcXVlc3QpKSBhcyB1bmtub3duIGFzIFJlc3BvbnNlTGlrZVxyXG4gIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDQwMClcclxuICBleHBlY3QocmVzLmJvZHkuZXJyb3IpLnRvQmVEZWZpbmVkKClcclxuICB9KVxyXG5cclxuICBpdCgnY3JlYXRlcyBhIHBheW1lbnQgYW5kIHJldHVybnMgdHJhbnNiYW5rIHVybCBhbmQgdG9rZW4gZm9yIHBhaWQgb3JkZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBTZXR1cCB0aWNrZXQgdHlwZSBhbmQgZXZlbnRcclxuICAgIGNvbnN0IHRpY2tldFR5cGUgPSB7XHJcbiAgICAgIGlkOiAndHQxJyxcclxuICAgICAgcHJpY2U6IDUwMDAsXHJcbiAgICAgIHRpY2tldHNHZW5lcmF0ZWQ6IDEsXHJcbiAgICAgIGNhcGFjaXR5OiAxMDAsXHJcbiAgICAgIGV2ZW50OiB7IGlkOiAnZTEnLCBpc1B1Ymxpc2hlZDogdHJ1ZSwgY3VycmVuY3k6ICdDTFAnIH1cclxuICAgIH1cclxuICAgIG1vY2tQcmlzbWEudGlja2V0VHlwZS5maW5kVW5pcXVlLm1vY2tSZXNvbHZlZFZhbHVlKHRpY2tldFR5cGUpXHJcbiAgICBtb2NrUHJpc21hLnRpY2tldC5jb3VudC5tb2NrUmVzb2x2ZWRWYWx1ZSgwKVxyXG5cclxuICAgIC8vIFByaWNlIGJyZWFrZG93blxyXG4gICAgbW9ja0NhbGN1bGF0ZS5jYWxjdWxhdGVQcmljZUJyZWFrZG93bi5tb2NrUmV0dXJuVmFsdWUoeyBiYXNlUHJpY2U6IDUwMDAsIGNvbW1pc3Npb246IDAsIHRvdGFsUHJpY2U6IDUwMDAsIG9yaWdpbmFsQW1vdW50OiA1MDAwLCBkaXNjb3VudEFtb3VudDogMCB9KVxyXG5cclxuICAgIC8vIE9yZGVyIGNyZWF0aW9uXHJcbiAgICBjb25zdCBjcmVhdGVkT3JkZXIgPSB7IGlkOiAnb3JkZXJfMScsIG9yZGVyTnVtYmVyOiAnU1AxMjMnLCBxdWFudGl0eTogMSB9XHJcbiAgICBtb2NrUHJpc21hLm9yZGVyLmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZShjcmVhdGVkT3JkZXIpXHJcblxyXG4gICAgLy8gV2VicGF5IHJlc3BvbmRzXHJcbiAgICBtb2NrV2VicGF5LmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IHVybDogJ2h0dHBzOi8vd2VicGF5LnRlc3QvY2hlY2tvdXQnLCB0b2tlbjogJ3Rva18xMjMnIH0pXHJcblxyXG4gICAgLy8gUGF5bWVudCBjcmVhdGVcclxuICAgIG1vY2tQcmlzbWEucGF5bWVudC5jcmVhdGUubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ3BheV8xJyB9KVxyXG5cclxuICAgIGNvbnN0IHJlcUJvZHkgPSB7IHRpY2tldFR5cGVJZDogJ3R0MScsIHF1YW50aXR5OiAxIH1cclxuICAgIGNvbnN0IHJlcSA9IHsganNvbjogYXN5bmMgKCkgPT4gcmVxQm9keSB9XHJcblxyXG4gICAgY29uc3QgeyBQT1NUIH0gPSBhd2FpdCBpbXBvcnQoJy4uLy4uLy4uL3NyYy9hcHAvYXBpL3BheW1lbnRzL2NyZWF0ZS9yb3V0ZScpXHJcbiAgY29uc3QgcmVzID0gKGF3YWl0IFBPU1QocmVxIGFzIHVua25vd24gYXMgTmV4dFJlcXVlc3QpKSBhcyB1bmtub3duIGFzIFJlc3BvbnNlTGlrZVxyXG5cclxuICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDApXHJcbiAgZXhwZWN0KHJlcy5ib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSlcclxuICBleHBlY3QocmVzLmJvZHkucGF5bWVudFVybCkudG9CZSgnaHR0cHM6Ly93ZWJwYXkudGVzdC9jaGVja291dCcpXHJcbiAgZXhwZWN0KHJlcy5ib2R5LnRva2VuKS50b0JlKCd0b2tfMTIzJylcclxuICBleHBlY3QobW9ja1dlYnBheS5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKVxyXG4gIGV4cGVjdChtb2NrUHJpc21hLnBheW1lbnQuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKClcclxuICB9KVxyXG5cclxuICBpdCgnYXBwbGllcyBwcm9tbyBjb2RlIGZvciBhIGRpc2NvdW50ZWQgcGFpZCBvcmRlcicsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHRpY2tldFR5cGUgPSB7XHJcbiAgICAgIGlkOiAndHQxJyxcclxuICAgICAgcHJpY2U6IDUwMDAsXHJcbiAgICAgIHRpY2tldHNHZW5lcmF0ZWQ6IDEsXHJcbiAgICAgIGNhcGFjaXR5OiAxMDAsXHJcbiAgICAgIGV2ZW50OiB7IGlkOiAnZTEnLCBpc1B1Ymxpc2hlZDogdHJ1ZSwgY3VycmVuY3k6ICdDTFAnIH1cclxuICAgIH1cclxuICAgIG1vY2tQcmlzbWEudGlja2V0VHlwZS5maW5kVW5pcXVlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh0aWNrZXRUeXBlKVxyXG4gICAgbW9ja1ByaXNtYS50aWNrZXQuY291bnQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKDApXHJcblxyXG4gICAgLy8gcHJvbW8gZ2l2ZXMgMTAwMCBDTFAgb2ZmXHJcbiAgICBjb25zdCBkaXNjb3VudEFtb3VudCA9IDEwMDBcclxuICAgIG1vY2tEaXNjb3VudC5EaXNjb3VudENvZGVTZXJ2aWNlLnZhbGlkYXRlRGlzY291bnRDb2RlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGlzVmFsaWQ6IHRydWUsIGRpc2NvdW50QW1vdW50LCBjb2RlOiAnUFJPTU8xJywgdHlwZTogJ0ZJWEVEJyB9KVxyXG4gICAgbW9ja0NhbGN1bGF0ZS5jYWxjdWxhdGVQcmljZUJyZWFrZG93bldpdGhEaXNjb3VudC5tb2NrUmV0dXJuVmFsdWVPbmNlKHsgYmFzZVByaWNlOiA0MDAwLCBjb21taXNzaW9uOiAwLCB0b3RhbFByaWNlOiA0MDAwLCBvcmlnaW5hbEFtb3VudDogNTAwMCwgZGlzY291bnRBbW91bnQgfSlcclxuXHJcbiAgICBjb25zdCBjcmVhdGVkT3JkZXIgPSB7IGlkOiAnb3JkZXJfMicsIG9yZGVyTnVtYmVyOiAnU1AxMjQnLCBxdWFudGl0eTogMSB9XHJcbiAgICBtb2NrUHJpc21hLm9yZGVyLmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoY3JlYXRlZE9yZGVyKVxyXG5cclxuICAgIG1vY2tXZWJwYXkuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IHVybDogJ2h0dHBzOi8vd2VicGF5LnRlc3QvY2hlY2tvdXQyJywgdG9rZW46ICd0b2tfNDU2JyB9KVxyXG4gICAgbW9ja1ByaXNtYS5wYXltZW50LmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyBpZDogJ3BheV8yJyB9KVxyXG5cclxuICAgIGNvbnN0IHJlcUJvZHkgPSB7IHRpY2tldFR5cGVJZDogJ3R0MScsIHF1YW50aXR5OiAxLCBwcm9tb0NvZGU6ICdQUk9NTzEnIH1cclxuICAgIGNvbnN0IHJlcSA9IHsganNvbjogYXN5bmMgKCkgPT4gcmVxQm9keSB9XHJcblxyXG4gICAgY29uc3QgeyBQT1NUIH0gPSBhd2FpdCBpbXBvcnQoJy4uLy4uLy4uL3NyYy9hcHAvYXBpL3BheW1lbnRzL2NyZWF0ZS9yb3V0ZScpXHJcbiAgY29uc3QgcmVzID0gKGF3YWl0IFBPU1QocmVxIGFzIHVua25vd24gYXMgTmV4dFJlcXVlc3QpKSBhcyB1bmtub3duIGFzIFJlc3BvbnNlTGlrZVxyXG5cclxuICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDApXHJcbiAgZXhwZWN0KHJlcy5ib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSlcclxuICBleHBlY3QocmVzLmJvZHkucHJpY2VCcmVha2Rvd24ucHJvbW9Db2RlKS50b0JlKCdQUk9NTzEnKVxyXG4gIGV4cGVjdChtb2NrRGlzY291bnQuRGlzY291bnRDb2RlU2VydmljZS52YWxpZGF0ZURpc2NvdW50Q29kZSkudG9IYXZlQmVlbkNhbGxlZCgpXHJcbiAgZXhwZWN0KG1vY2tXZWJwYXkuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKClcclxuICB9KVxyXG5cclxuICBpdCgncHJvY2Vzc2VzIGZyZWUtdGlja2V0IGZsb3cgKGZpbmFsIHRvdGFsIDApIGFuZCBnZW5lcmF0ZXMgdGlja2V0cycsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHRpY2tldFR5cGUgPSB7XHJcbiAgICAgIGlkOiAndHRfZnJlZScsXHJcbiAgICAgIHByaWNlOiA1MDAwLFxyXG4gICAgICB0aWNrZXRzR2VuZXJhdGVkOiAxLFxyXG4gICAgICBjYXBhY2l0eTogMTAwLFxyXG4gICAgICBldmVudDogeyBpZDogJ2VfZnJlZScsIGlzUHVibGlzaGVkOiB0cnVlLCBjdXJyZW5jeTogJ0NMUCcgfVxyXG4gICAgfVxyXG4gICAgbW9ja1ByaXNtYS50aWNrZXRUeXBlLmZpbmRVbmlxdWUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHRpY2tldFR5cGUpXHJcbiAgICBtb2NrUHJpc21hLnRpY2tldC5jb3VudC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoMClcclxuXHJcbiAgICBjb25zdCBiYXNlVG90YWwgPSA1MDAwXHJcbiAgICAvLyBwcm9tbyBnaXZlcyBmdWxsIGRpc2NvdW50IHNvIGZpbmFsIHRvdGFsIDBcclxuICAgIG1vY2tEaXNjb3VudC5EaXNjb3VudENvZGVTZXJ2aWNlLnZhbGlkYXRlRGlzY291bnRDb2RlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGlzVmFsaWQ6IHRydWUsIGRpc2NvdW50QW1vdW50OiBiYXNlVG90YWwsIGNvZGU6ICdGUkVFMTAwJywgdHlwZTogJ0ZJWEVEJyB9KVxyXG4gICAgbW9ja0NhbGN1bGF0ZS5jYWxjdWxhdGVQcmljZUJyZWFrZG93bldpdGhEaXNjb3VudC5tb2NrUmV0dXJuVmFsdWVPbmNlKHsgYmFzZVByaWNlOiAwLCBjb21taXNzaW9uOiAwLCB0b3RhbFByaWNlOiAwLCBvcmlnaW5hbEFtb3VudDogYmFzZVRvdGFsLCBkaXNjb3VudEFtb3VudDogYmFzZVRvdGFsIH0pXHJcblxyXG4gICAgY29uc3QgY3JlYXRlZE9yZGVyID0geyBpZDogJ29yZGVyX2ZyZWUnLCBvcmRlck51bWJlcjogJ1NQRlJFRScsIHF1YW50aXR5OiAxIH1cclxuICAgIG1vY2tQcmlzbWEub3JkZXIuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlT25jZShjcmVhdGVkT3JkZXIpXHJcblxyXG4gICAgLy8gJHRyYW5zYWN0aW9uIHJldHVybnMgW3Jlc3VsdE9mQ3JlYXRlTWFueSwgdXBkYXRlZE9yZGVyXVxyXG4gICAgY29uc3QgdXBkYXRlZE9yZGVyID0geyBpZDogY3JlYXRlZE9yZGVyLmlkLCB0aWNrZXRzOiBbeyBxckNvZGU6ICdRUjEnIH1dIH1cclxuICAgIG1vY2tQcmlzbWEuJHRyYW5zYWN0aW9uLm1vY2tSZXNvbHZlZFZhbHVlT25jZShbbnVsbCwgdXBkYXRlZE9yZGVyXSlcclxuXHJcbiAgICBjb25zdCByZXFCb2R5ID0geyB0aWNrZXRUeXBlSWQ6ICd0dF9mcmVlJywgcXVhbnRpdHk6IDEsIHByb21vQ29kZTogJ0ZSRUUxMDAnIH1cclxuICAgIGNvbnN0IHJlcSA9IHsganNvbjogYXN5bmMgKCkgPT4gcmVxQm9keSB9XHJcblxyXG4gICAgY29uc3QgeyBQT1NUIH0gPSBhd2FpdCBpbXBvcnQoJy4uLy4uLy4uL3NyYy9hcHAvYXBpL3BheW1lbnRzL2NyZWF0ZS9yb3V0ZScpXHJcbiAgY29uc3QgcmVzID0gKGF3YWl0IFBPU1QocmVxIGFzIHVua25vd24gYXMgTmV4dFJlcXVlc3QpKSBhcyB1bmtub3duIGFzIFJlc3BvbnNlTGlrZVxyXG5cclxuICAgIC8vIE1vY2sgZXZlbnQgbG9va3VwIHVzZWQgaW4gaGFuZGxlQW5kR2VuZXJhdGVUaWNrZXRzXHJcbiAgICBjb25zdCBldmVudFdpdGhPcmdhbml6ZXIgPSB7XHJcbiAgICAgIGlkOiB0aWNrZXRUeXBlLmV2ZW50LmlkLFxyXG4gICAgICB0aXRsZTogJ0ZyZWUgRXZlbnQnLFxyXG4gICAgICBzdGFydERhdGU6IG5ldyBEYXRlKCksXHJcbiAgICAgIGxvY2F0aW9uOiAnT25saW5lJyxcclxuICAgICAgb3JnYW5pemVyOiB7IGlkOiAnb3JnMScsIG5hbWU6ICdPcmcnIH1cclxuICAgIH1cclxuICAgIC8vIGVuc3VyZSBwcmlzbWEuZXZlbnQuZmluZFVuaXF1ZSBleGlzdHMgb24gdGhlIG1vY2tcclxuICAgIG1vY2tQcmlzbWEuZXZlbnQgPSB7IGZpbmRVbmlxdWU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoZXZlbnRXaXRoT3JnYW5pemVyKSB9XHJcblxyXG4gICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAwKVxyXG4gIGV4cGVjdChyZXMuYm9keS5pc0ZyZWUpLnRvQmUodHJ1ZSlcclxuICBleHBlY3QocmVzLmJvZHkudGlja2V0c0dlbmVyYXRlZCkudG9CZUdyZWF0ZXJUaGFuKDApXHJcbiAgZXhwZWN0KG1vY2tEaXNjb3VudC5EaXNjb3VudENvZGVTZXJ2aWNlLmFwcGx5Q29kZVVzYWdlKS50b0hhdmVCZWVuQ2FsbGVkKClcclxuICBleHBlY3QobW9ja1ByaXNtYS4kdHJhbnNhY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWQoKVxyXG4gIH0pXHJcbn0pXHJcbiJdLCJ2ZXJzaW9uIjozfQ==