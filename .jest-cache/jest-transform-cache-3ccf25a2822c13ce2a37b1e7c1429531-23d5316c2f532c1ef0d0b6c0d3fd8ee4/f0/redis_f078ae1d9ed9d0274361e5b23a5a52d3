d098ddbba018a7bb3948f653e079ecc3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cache = exports.CacheService = void 0;
const ioredis_1 = require("ioredis");
const logger_1 = require("./logger");
const getRedisConfig = () => {
    if (process.env.REDIS_URL) {
        return {
            connectionName: 'vercel-redis',
            lazyConnect: true,
            retryDelayOnFailover: 100,
            enableReadyCheck: false,
            maxRetriesPerRequest: 3,
            connectTimeout: 60000,
            commandTimeout: 5000,
            keepAlive: 30000,
            family: 4,
            enableAutoPipelining: true,
            compression: 'gzip',
        };
    }
    return {
        host: process.env.REDIS_HOST || 'localhost',
        port: parseInt(process.env.REDIS_PORT || '6379'),
        password: process.env.REDIS_PASSWORD,
        db: parseInt(process.env.REDIS_DB || '0'),
        retryDelayOnFailover: 100,
        enableReadyCheck: false,
        maxRetriesPerRequest: 3,
        lazyConnect: true,
        connectTimeout: 60000,
        commandTimeout: 5000,
        keepAlive: 30000,
        family: 4,
        enableAutoPipelining: true,
    };
};
const redis = process.env.REDIS_URL
    ? new ioredis_1.Redis(process.env.REDIS_URL, getRedisConfig())
    : new ioredis_1.Redis(getRedisConfig());
redis.on('connect', () => {
    logger_1.logger.info('✅ Redis connected successfully');
});
redis.on('error', (error) => {
    logger_1.logger.error('❌ Redis connection error', error);
});
redis.on('close', () => {
    logger_1.logger.info('🔌 Redis connection closed');
});
class CacheService {
    constructor() {
        this.redis = redis;
    }
    static getInstance() {
        if (!CacheService.instance) {
            CacheService.instance = new CacheService();
        }
        return CacheService.instance;
    }
    async get(key) {
        try {
            const cached = await this.redis.get(key);
            return cached ? JSON.parse(cached) : null;
        }
        catch (error) {
            logger_1.logger.error(`Error getting cache key ${key}`, error);
            return null;
        }
    }
    async set(key, value, ttlSeconds) {
        try {
            const serialized = JSON.stringify(value);
            if (ttlSeconds) {
                await this.redis.setex(key, ttlSeconds, serialized);
            }
            else {
                await this.redis.set(key, serialized);
            }
        }
        catch (error) {
            logger_1.logger.error(`Error setting cache key ${key}`, error);
        }
    }
    async del(key) {
        try {
            await this.redis.del(key);
        }
        catch (error) {
            logger_1.logger.error(`Error deleting cache key ${key}`, error);
        }
    }
    async invalidatePattern(pattern) {
        try {
            const keys = await this.redis.keys(pattern);
            if (keys.length > 0) {
                await this.redis.del(...keys);
            }
        }
        catch (error) {
            logger_1.logger.error(`Error invalidating pattern ${pattern}`, error);
        }
    }
    async getUserRole(clerkId) {
        return this.get(`user:role:${clerkId}`);
    }
    async setUserRole(clerkId, role, ttl = 3600) {
        await this.set(`user:role:${clerkId}`, role, ttl);
    }
    async getUserProfile(clerkId) {
        return this.get(`user:profile:${clerkId}`);
    }
    async setUserProfile(clerkId, profile, ttl = 1800) {
        await this.set(`user:profile:${clerkId}`, profile, ttl);
    }
    async getUserFullData(clerkId) {
        return this.get(`user:full:${clerkId}`);
    }
    async setUserFullData(clerkId, userData, ttl = 3600) {
        await this.set(`user:full:${clerkId}`, userData, ttl);
    }
    async getUserPermissions(clerkId) {
        return this.get(`user:permissions:${clerkId}`);
    }
    async setUserPermissions(clerkId, permissions, ttl = 3600) {
        await this.set(`user:permissions:${clerkId}`, permissions, ttl);
    }
    async setUserBatch(clerkId, userData, ttl = 3600) {
        const pipeline = this.redis.pipeline();
        pipeline.setex(`user:full:${clerkId}`, ttl, JSON.stringify(userData));
        pipeline.setex(`user:role:${clerkId}`, ttl, userData.role);
        pipeline.setex(`user:profile:${clerkId}`, ttl, JSON.stringify(userData));
        await pipeline.exec();
    }
    async invalidateUserCache(clerkId) {
        await this.invalidatePattern(`user:*:${clerkId}`);
    }
    async getEvents(query) {
        return this.get(`events:${query}`);
    }
    async setEvents(query, events, ttl = 600) {
        await this.set(`events:${query}`, events, ttl);
    }
    async invalidateEventsCache() {
        await this.invalidatePattern('events:*');
    }
    async getDashboardStats(userId) {
        return this.get(`dashboard:stats:${userId}`);
    }
    async setDashboardStats(userId, stats, ttl = 300) {
        await this.set(`dashboard:stats:${userId}`, stats, ttl);
    }
    async invalidateDashboardStats(userId) {
        if (userId) {
            await this.del(`dashboard:stats:${userId}`);
        }
        else {
            await this.invalidatePattern('dashboard:stats:*');
        }
    }
    async incrementRateLimit(key, windowSeconds, limit) {
        try {
            const current = await this.redis.incr(key);
            if (current === 1) {
                await this.redis.expire(key, windowSeconds);
            }
            return {
                allowed: current <= limit,
                remaining: Math.max(0, limit - current)
            };
        }
        catch (error) {
            logger_1.logger.error(`Error checking rate limit for ${key}`, error);
            return { allowed: true, remaining: limit };
        }
    }
    async setSession(sessionId, data, ttl = 86400) {
        await this.set(`session:${sessionId}`, data, ttl);
    }
    async getSession(sessionId) {
        return this.get(`session:${sessionId}`);
    }
    async deleteSession(sessionId) {
        await this.del(`session:${sessionId}`);
    }
    async ping() {
        try {
            const response = await this.redis.ping();
            return response === 'PONG';
        }
        catch (error) {
            logger_1.logger.error('Redis ping failed', error);
            return false;
        }
    }
    async disconnect() {
        try {
            await this.redis.quit();
        }
        catch (error) {
            logger_1.logger.error('Error disconnecting from Redis:', error);
        }
    }
}
exports.CacheService = CacheService;
exports.cache = CacheService.getInstance();
exports.default = redis;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxsaWJcXHJlZGlzLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFnQztBQUNoQyxxQ0FBa0M7QUE0Q2xDLE1BQU0sY0FBYyxHQUFHLEdBQUcsRUFBRTtJQUUxQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDMUIsT0FBTztZQUNMLGNBQWMsRUFBRSxjQUFjO1lBQzlCLFdBQVcsRUFBRSxJQUFJO1lBQ2pCLG9CQUFvQixFQUFFLEdBQUc7WUFDekIsZ0JBQWdCLEVBQUUsS0FBSztZQUN2QixvQkFBb0IsRUFBRSxDQUFDO1lBRXZCLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLGNBQWMsRUFBRSxJQUFJO1lBQ3BCLFNBQVMsRUFBRSxLQUFLO1lBRWhCLE1BQU0sRUFBRSxDQUFDO1lBRVQsb0JBQW9CLEVBQUUsSUFBSTtZQUUxQixXQUFXLEVBQUUsTUFBTTtTQUNwQixDQUFDO0lBQ0osQ0FBQztJQUdELE9BQU87UUFDTCxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVztRQUMzQyxJQUFJLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQztRQUNoRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1FBQ3BDLEVBQUUsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDO1FBQ3pDLG9CQUFvQixFQUFFLEdBQUc7UUFDekIsZ0JBQWdCLEVBQUUsS0FBSztRQUN2QixvQkFBb0IsRUFBRSxDQUFDO1FBQ3ZCLFdBQVcsRUFBRSxJQUFJO1FBRWpCLGNBQWMsRUFBRSxLQUFLO1FBQ3JCLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBRWhCLE1BQU0sRUFBRSxDQUFDO1FBRVQsb0JBQW9CLEVB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QUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3pDLE9BQU8sUUFBUSxLQUFLLE1BQU0sQ0FBQztRQUM3QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLEtBQWMsQ0FBQyxDQUFDO1lBQzlDLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztJQUNILENBQUM7SUFHRCxLQUFLLENBQUMsVUFBVTtRQUNkLElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQWMsQ0FBQyxDQUFDO1FBQzlELENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF2TEQsb0NBdUxDO0FBR1ksUUFBQSxLQUFLLEdBQUcsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ2hELGtCQUFlLEtBQUssQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEJpbHVyXFxEb2N1bWVudHNcXERldmVsb3BtZW50XFxOZXh0XFxzb3J5Y2stYWNjZXNzXFxzcmNcXGxpYlxccmVkaXMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVkaXMgfSBmcm9tICdpb3JlZGlzJztcclxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xyXG5cclxuXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJQcm9maWxlIHtcclxuICBpZDogc3RyaW5nO1xyXG4gIGNsZXJrSWQ6IHN0cmluZztcclxuICBlbWFpbDogc3RyaW5nO1xyXG4gIGZpcnN0TmFtZT86IHN0cmluZztcclxuICBsYXN0TmFtZT86IHN0cmluZztcclxuICBiaW8/OiBzdHJpbmc7XHJcbiAgcHJvZHVjZXJOYW1lPzogc3RyaW5nO1xyXG4gIHdlYnNpdGVVcmw/OiBzdHJpbmc7XHJcbiAgdHdpdHRlclVybD86IHN0cmluZztcclxuICBpbnN0YWdyYW1Vcmw/OiBzdHJpbmc7XHJcbiAgcm9sZTogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJQZXJtaXNzaW9ucyB7XHJcbiAgY2FuQ3JlYXRlRXZlbnRzOiBib29sZWFuO1xyXG4gIGNhbkFjY2Vzc0FkbWluOiBib29sZWFuO1xyXG4gIGNhblNjYW5UaWNrZXRzOiBib29sZWFuO1xyXG4gIGNhbk1hbmFnZVVzZXJzOiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE1vbnRobHlTdGF0cyB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIGluZ3Jlc29zOiBudW1iZXI7XHJcbiAgZXZlbnRvczogbnVtYmVyO1xyXG4gIHRpY2tldHM6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgRGFzaGJvYXJkU3RhdHMgPSBNb250aGx5U3RhdHNbXTtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnREYXRhIHtcclxuICBpZDogc3RyaW5nO1xyXG4gIHRpdGxlOiBzdHJpbmc7XHJcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XHJcbiAgc3RhcnREYXRlOiBEYXRlO1xyXG4gIGVuZERhdGU6IERhdGU7XHJcbiAgY2F0ZWdvcnlJZDogc3RyaW5nO1xyXG4gIG9yZ2FuaXplcklkOiBzdHJpbmc7XHJcbn1cclxuXHJcblxuY29uc3QgZ2V0UmVkaXNDb25maWcgPSAoKSA9PiB7XHJcbiAgXG4gIGlmIChwcm9jZXNzLmVudi5SRURJU19VUkwpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGNvbm5lY3Rpb25OYW1lOiAndmVyY2VsLXJlZGlzJyxcclxuICAgICAgbGF6eUNvbm5lY3Q6IHRydWUsXHJcbiAgICAgIHJldHJ5RGVsYXlPbkZhaWxvdmVyOiAxMDAsXHJcbiAgICAgIGVuYWJsZVJlYWR5Q2hlY2s6IGZhbHNlLFxyXG4gICAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdDogMyxcclxuICAgICAgXG4gICAgICBjb25uZWN0VGltZW91dDogNjAwMDAsXHJcbiAgICAgIGNvbW1hbmRUaW1lb3V0OiA1MDAwLFxyXG4gICAgICBrZWVwQWxpdmU6IDMwMDAwLFxyXG4gICAgICBcbiAgICAgIGZhbWlseTogNCxcclxuICAgICAgXG4gICAgICBlbmFibGVBdXRvUGlwZWxpbmluZzogdHJ1ZSxcclxuICAgICAgXG4gICAgICBjb21wcmVzc2lvbjogJ2d6aXAnLFxyXG4gICAgfTtcclxuICB9XHJcbiAgXHJcbiAgXG4gIHJldHVybiB7XHJcbiAgICBob3N0OiBwcm9jZXNzLmVudi5SRURJU19IT1NUIHx8ICdsb2NhbGhvc3QnLFxyXG4gICAgcG9ydDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfUE9SVCB8fCAnNjM3OScpLFxyXG4gICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LlJFRElTX1BBU1NXT1JELFxyXG4gICAgZGI6IHBhcnNlSW50KHByb2Nlc3MuZW52LlJFRElTX0RCIHx8ICcwJyksXHJcbiAgICByZXRyeURlbGF5T25GYWlsb3ZlcjogMTAwLFxyXG4gICAgZW5hYmxlUmVhZHlDaGVjazogZmFsc2UsXHJcbiAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdDogMyxcclxuICAgIGxhenlDb25uZWN0OiB0cnVlLFxyXG4gICAgXG4gICAgY29ubmVjdFRpbWVvdXQ6IDYwMDAwLFxyXG4gICAgY29tbWFuZFRpbWVvdXQ6IDUwMDAsXHJcbiAgICBrZWVwQWxpdmU6IDMwMDAwLFxyXG4gICAgXG4gICAgZmFtaWx5OiA0LFxyXG4gICAgXG4gICAgZW5hYmxlQXV0b1BpcGVsaW5pbmc6IHRydWUsXHJcbiAgfTtcclxufTtcclxuXHJcblxuY29uc3QgcmVkaXMgPSBwcm9jZXNzLmVudi5SRURJU19VUkwgXHJcbiAgPyBuZXcgUmVkaXMocHJvY2Vzcy5lbnYuUkVESVNfVVJMLCBnZXRSZWRpc0NvbmZpZygpKVxyXG4gIDogbmV3IFJlZGlzKGdldFJlZGlzQ29uZmlnKCkpO1xyXG5cclxuXG5yZWRpcy5vbignY29ubmVjdCcsICgpID0+IHtcclxuICBsb2dnZXIuaW5mbygn4pyFIFJlZGlzIGNvbm5lY3RlZCBzdWNjZXNzZnVsbHknKTtcclxufSk7XHJcblxyXG5yZWRpcy5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcclxuICBsb2dnZXIuZXJyb3IoJ+KdjCBSZWRpcyBjb25uZWN0aW9uIGVycm9yJywgZXJyb3IpO1xyXG59KTtcclxuXHJcbnJlZGlzLm9uKCdjbG9zZScsICgpID0+IHtcclxuICBsb2dnZXIuaW5mbygn8J+UjCBSZWRpcyBjb25uZWN0aW9uIGNsb3NlZCcpO1xyXG59KTtcclxuXHJcblxuZXhwb3J0IGNsYXNzIENhY2hlU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IENhY2hlU2VydmljZTtcclxuICBwcml2YXRlIHJlZGlzOiBSZWRpcztcclxuXHJcbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMucmVkaXMgPSByZWRpcztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogQ2FjaGVTZXJ2aWNlIHtcclxuICAgIGlmICghQ2FjaGVTZXJ2aWNlLmluc3RhbmNlKSB7XHJcbiAgICAgIENhY2hlU2VydmljZS5pbnN0YW5jZSA9IG5ldyBDYWNoZVNlcnZpY2UoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBDYWNoZVNlcnZpY2UuaW5zdGFuY2U7XHJcbiAgfVxyXG5cclxuICBcbiAgYXN5bmMgZ2V0PFQ+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgdGhpcy5yZWRpcy5nZXQoa2V5KTtcclxuICAgICAgcmV0dXJuIGNhY2hlZCA/IEpTT04ucGFyc2UoY2FjaGVkKSA6IG51bGw7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcihgRXJyb3IgZ2V0dGluZyBjYWNoZSBrZXkgJHtrZXl9YCwgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHNldChrZXk6IHN0cmluZywgdmFsdWU6IHVua25vd24sIHR0bFNlY29uZHM/OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XHJcbiAgICAgIGlmICh0dGxTZWNvbmRzKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpcy5zZXRleChrZXksIHR0bFNlY29uZHMsIHNlcmlhbGl6ZWQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXMuc2V0KGtleSwgc2VyaWFsaXplZCk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgbG9nZ2VyLmVycm9yKGBFcnJvciBzZXR0aW5nIGNhY2hlIGtleSAke2tleX1gLCBlcnJvciBhcyBFcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBkZWwoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMucmVkaXMuZGVsKGtleSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcihgRXJyb3IgZGVsZXRpbmcgY2FjaGUga2V5ICR7a2V5fWAsIGVycm9yIGFzIEVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGludmFsaWRhdGVQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMucmVkaXMua2V5cyhwYXR0ZXJuKTtcclxuICAgICAgaWYgKGtleXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXMuZGVsKC4uLmtleXMpO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcihgRXJyb3IgaW52YWxpZGF0aW5nIHBhdHRlcm4gJHtwYXR0ZXJufWAsIGVycm9yIGFzIEVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIFxuICBhc3luYyBnZXRVc2VyUm9sZShjbGVya0lkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcclxuICAgIHJldHVybiB0aGlzLmdldChgdXNlcjpyb2xlOiR7Y2xlcmtJZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldFVzZXJSb2xlKGNsZXJrSWQ6IHN0cmluZywgcm9sZTogc3RyaW5nLCB0dGwgPSAzNjAwKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLnNldChgdXNlcjpyb2xlOiR7Y2xlcmtJZH1gLCByb2xlLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VXNlclByb2ZpbGUoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyUHJvZmlsZSB8IG51bGw+IHtcclxuICAgIHJldHVybiB0aGlzLmdldChgdXNlcjpwcm9maWxlOiR7Y2xlcmtJZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldFVzZXJQcm9maWxlKGNsZXJrSWQ6IHN0cmluZywgcHJvZmlsZTogVXNlclByb2ZpbGUsIHR0bCA9IDE4MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGB1c2VyOnByb2ZpbGU6JHtjbGVya0lkfWAsIHByb2ZpbGUsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBcbiAgYXN5bmMgZ2V0VXNlckZ1bGxEYXRhKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclByb2ZpbGUgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHVzZXI6ZnVsbDoke2NsZXJrSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXRVc2VyRnVsbERhdGEoY2xlcmtJZDogc3RyaW5nLCB1c2VyRGF0YTogVXNlclByb2ZpbGUsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGB1c2VyOmZ1bGw6JHtjbGVya0lkfWAsIHVzZXJEYXRhLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VXNlclBlcm1pc3Npb25zKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclBlcm1pc3Npb25zIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGB1c2VyOnBlcm1pc3Npb25zOiR7Y2xlcmtJZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldFVzZXJQZXJtaXNzaW9ucyhjbGVya0lkOiBzdHJpbmcsIHBlcm1pc3Npb25zOiBVc2VyUGVybWlzc2lvbnMsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGB1c2VyOnBlcm1pc3Npb25zOiR7Y2xlcmtJZH1gLCBwZXJtaXNzaW9ucywgdHRsKTtcclxuICB9XHJcblxyXG4gIFxuICBhc3luYyBzZXRVc2VyQmF0Y2goY2xlcmtJZDogc3RyaW5nLCB1c2VyRGF0YTogVXNlclByb2ZpbGUsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHBpcGVsaW5lID0gdGhpcy5yZWRpcy5waXBlbGluZSgpO1xyXG4gICAgcGlwZWxpbmUuc2V0ZXgoYHVzZXI6ZnVsbDoke2NsZXJrSWR9YCwgdHRsLCBKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpO1xyXG4gICAgcGlwZWxpbmUuc2V0ZXgoYHVzZXI6cm9sZToke2NsZXJrSWR9YCwgdHRsLCB1c2VyRGF0YS5yb2xlKTtcclxuICAgIHBpcGVsaW5lLnNldGV4KGB1c2VyOnByb2ZpbGU6JHtjbGVya0lkfWAsIHR0bCwgSlNPTi5zdHJpbmdpZnkodXNlckRhdGEpKTtcclxuICAgIGF3YWl0IHBpcGVsaW5lLmV4ZWMoKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGludmFsaWRhdGVVc2VyQ2FjaGUoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVQYXR0ZXJuKGB1c2VyOio6JHtjbGVya0lkfWApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RXZlbnRzKHF1ZXJ5OiBzdHJpbmcpOiBQcm9taXNlPEV2ZW50RGF0YVtdIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGBldmVudHM6JHtxdWVyeX1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldEV2ZW50cyhxdWVyeTogc3RyaW5nLCBldmVudHM6IEV2ZW50RGF0YVtdLCB0dGwgPSA2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGBldmVudHM6JHtxdWVyeX1gLCBldmVudHMsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbnZhbGlkYXRlRXZlbnRzQ2FjaGUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVQYXR0ZXJuKCdldmVudHM6KicpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RGFzaGJvYXJkU3RhdHModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPERhc2hib2FyZFN0YXRzIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGBkYXNoYm9hcmQ6c3RhdHM6JHt1c2VySWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXREYXNoYm9hcmRTdGF0cyh1c2VySWQ6IHN0cmluZywgc3RhdHM6IERhc2hib2FyZFN0YXRzLCB0dGwgPSAzMDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGBkYXNoYm9hcmQ6c3RhdHM6JHt1c2VySWR9YCwgc3RhdHMsIHR0bCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbnZhbGlkYXRlRGFzaGJvYXJkU3RhdHModXNlcklkPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAodXNlcklkKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuZGVsKGBkYXNoYm9hcmQ6c3RhdHM6JHt1c2VySWR9YCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVQYXR0ZXJuKCdkYXNoYm9hcmQ6c3RhdHM6KicpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgXG4gIGFzeW5jIGluY3JlbWVudFJhdGVMaW1pdChrZXk6IHN0cmluZywgd2luZG93U2Vjb25kczogbnVtYmVyLCBsaW1pdDogbnVtYmVyKTogUHJvbWlzZTx7IGFsbG93ZWQ6IGJvb2xlYW47IHJlbWFpbmluZzogbnVtYmVyIH0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSBhd2FpdCB0aGlzLnJlZGlzLmluY3Ioa2V5KTtcclxuICAgICAgaWYgKGN1cnJlbnQgPT09IDEpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLmV4cGlyZShrZXksIHdpbmRvd1NlY29uZHMpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGFsbG93ZWQ6IGN1cnJlbnQgPD0gbGltaXQsXHJcbiAgICAgICAgcmVtYWluaW5nOiBNYXRoLm1heCgwLCBsaW1pdCAtIGN1cnJlbnQpXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcihgRXJyb3IgY2hlY2tpbmcgcmF0ZSBsaW1pdCBmb3IgJHtrZXl9YCwgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgICByZXR1cm4geyBhbGxvd2VkOiB0cnVlLCByZW1haW5pbmc6IGxpbWl0IH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBcbiAgYXN5bmMgc2V0U2Vzc2lvbihzZXNzaW9uSWQ6IHN0cmluZywgZGF0YTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sIHR0bCA9IDg2NDAwKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLnNldChgc2Vzc2lvbjoke3Nlc3Npb25JZH1gLCBkYXRhLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0U2Vzc2lvbihzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgdW5rbm93bj4gfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHNlc3Npb246JHtzZXNzaW9uSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBkZWxldGVTZXNzaW9uKHNlc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLmRlbChgc2Vzc2lvbjoke3Nlc3Npb25JZH1gKTtcclxuICB9XHJcblxyXG4gIFxuICBhc3luYyBwaW5nKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnJlZGlzLnBpbmcoKTtcclxuICAgICAgcmV0dXJuIHJlc3BvbnNlID09PSAnUE9ORyc7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcignUmVkaXMgcGluZyBmYWlsZWQnLCBlcnJvciBhcyBFcnJvcik7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIFxuICBhc3luYyBkaXNjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5xdWl0KCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gIGxvZ2dlci5lcnJvcignRXJyb3IgZGlzY29ubmVjdGluZyBmcm9tIFJlZGlzOicsIGVycm9yIGFzIEVycm9yKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcblxuZXhwb3J0IGNvbnN0IGNhY2hlID0gQ2FjaGVTZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbmV4cG9ydCBkZWZhdWx0IHJlZGlzO1xyXG4iXSwidmVyc2lvbiI6M30=