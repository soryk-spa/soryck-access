7f5d7e3849f9b35b673c113e864bd4bd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.usePromoCodeManagement = usePromoCodeManagement;
exports.usePromoCodeFilters = usePromoCodeFilters;
exports.usePromoCodeStats = usePromoCodeStats;
exports.usePromoCodeSharing = usePromoCodeSharing;
const react_1 = require("react");
const sonner_1 = require("sonner");
function usePromoCodeManagement(initialPromoCodes) {
    const [promoCodes, setPromoCodes] = (0, react_1.useState)(initialPromoCodes);
    const [loadingStates, setLoadingStates] = (0, react_1.useState)({});
    const togglePromoCodeStatus = async (promoCode) => {
        const newStatus = promoCode.status === "ACTIVE" ? "INACTIVE" : "ACTIVE";
        const action = newStatus === "ACTIVE" ? "activar" : "desactivar";
        setLoadingStates(prev => (Object.assign(Object.assign({}, prev), { [promoCode.id]: true })));
        try {
            const response = await fetch(`/api/promo-codes/${promoCode.id}/toggle-status`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
            });
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || `Error al ${action} el código promocional`);
            }
            setPromoCodes(prev => prev.map(code => code.id === promoCode.id
                ? Object.assign(Object.assign({}, code), { status: newStatus }) : code));
            sonner_1.toast.success(`Código promocional ${action === "activar" ? "activado" : "desactivado"} exitosamente`);
        }
        catch (error) {
            console.error(`Error ${action} promo code:`, error);
            sonner_1.toast.error(error instanceof Error ? error.message : `Error al ${action} el código promocional`);
        }
        finally {
            setLoadingStates(prev => (Object.assign(Object.assign({}, prev), { [promoCode.id]: false })));
        }
    };
    const copyToClipboard = (code) => {
        navigator.clipboard.writeText(code);
        sonner_1.toast.success("Código copiado al portapapeles");
    };
    return {
        promoCodes,
        loadingStates,
        togglePromoCodeStatus,
        copyToClipboard,
    };
}
function usePromoCodeFilters(promoCodes) {
    const [filters, setFilters] = (0, react_1.useState)({
        search: "",
        status: "all",
    });
    const filteredPromoCodes = (0, react_1.useMemo)(() => {
        return promoCodes.filter((code) => {
            const matchesSearch = !filters.search ||
                code.code.toLowerCase().includes(filters.search.toLowerCase()) ||
                code.name.toLowerCase().includes(filters.search.toLowerCase());
            const matchesStatus = filters.status === "all" || code.status === filters.status;
            return matchesSearch && matchesStatus;
        });
    }, [promoCodes, filters]);
    const updateFilter = (key, value) => {
        setFilters(prev => (Object.assign(Object.assign({}, prev), { [key]: value })));
    };
    const clearFilters = () => {
        setFilters({ search: "", status: "all" });
    };
    return {
        filters,
        filteredPromoCodes,
        updateFilter,
        clearFilters,
    };
}
function usePromoCodeStats(promoCodes) {
    const stats = (0, react_1.useMemo)(() => {
        const total = promoCodes.length;
        const active = promoCodes.filter(code => code.status === "ACTIVE").length;
        const totalUsages = promoCodes.reduce((sum, code) => sum + code.usedCount, 0);
        const expired = promoCodes.filter(code => code.status === "EXPIRED").length;
        const inactive = promoCodes.filter(code => code.status === "INACTIVE").length;
        const usedUp = promoCodes.filter(code => code.status === "USED_UP").length;
        return {
            total,
            active,
            inactive,
            expired,
            usedUp,
            totalUsages,
            activePercentage: total > 0 ? (active / total) * 100 : 0,
            usageRate: total > 0 ? (totalUsages / total) : 0,
        };
    }, [promoCodes]);
    return stats;
}
function usePromoCodeSharing() {
    const sharePromoCode = (code, formatDiscount) => {
        const shareText = `🎫 ¡Descuento especial! Usa el código ${code.code} y obtén ${formatDiscount(code.type, code.value)} en tu próxima compra.`;
        if (navigator.share) {
            navigator.share({
                title: `Código promocional: ${code.name}`,
                text: shareText,
            });
        }
        else {
            navigator.clipboard.writeText(shareText);
            sonner_1.toast.success("Texto de promoción copiado al portapapeles");
        }
    };
    const exportPromoCodes = (promoCodes) => {
        const csv = generatePromoCodeCSV(promoCodes);
        downloadCSV(csv, 'codigos-promocionales.csv');
        sonner_1.toast.success("Códigos promocionales exportados exitosamente");
    };
    return {
        sharePromoCode,
        exportPromoCodes,
    };
}
function generatePromoCodeCSV(promoCodes) {
    const headers = ['Código', 'Nombre', 'Tipo', 'Valor', 'Estado', 'Usado', 'Límite', 'Válido Desde', 'Válido Hasta'];
    const rows = promoCodes.map(code => {
        var _a;
        return [
            code.code,
            code.name,
            code.type,
            code.value.toString(),
            code.status,
            code.usedCount.toString(),
            ((_a = code.usageLimit) === null || _a === void 0 ? void 0 : _a.toString()) || 'Sin límite',
            code.validFrom,
            code.validUntil || 'Sin fecha límite'
        ];
    });
    return [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
}
function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxob29rc1xcdXNlUHJvbW9Db2RlLnRzIiwibWFwcGluZ3MiOiI7O0FBVUEsd0RBbURDO0FBTUQsa0RBbUNDO0FBTUQsOENBc0JDO0FBTUQsa0RBMEJDO0FBaEtELGlDQUEwQztBQUMxQyxtQ0FBK0I7QUFPL0IsU0FBZ0Isc0JBQXNCLENBQUMsaUJBQThCO0lBQ25FLE1BQU0sQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFjLGlCQUFpQixDQUFDLENBQUM7SUFDN0UsTUFBTSxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBMEIsRUFBRSxDQUFDLENBQUM7SUFFaEYsTUFBTSxxQkFBcUIsR0FBRyxLQUFLLEVBQUUsU0FBb0IsRUFBRSxFQUFFO1FBQzNELE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUN4RSxNQUFNLE1BQU0sR0FBRyxTQUFTLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztRQUVqRSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGlDQUFNLElBQUksS0FBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLElBQUcsQ0FBQyxDQUFDO1FBRTlELElBQUksQ0FBQztZQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLG9CQUFvQixTQUFTLENBQUMsRUFBRSxnQkFBZ0IsRUFBRTtnQkFDN0UsTUFBTSxFQUFFLE9BQU87Z0JBQ2YsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO2dCQUMvQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxTQUFT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O0FBQ2hCLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUFlLEVBQUUsUUFBZ0I7SUFDcEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSx5QkFBeUIsRUFBRSxDQUFDLENBQUM7SUFDdEUsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV6QyxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDaEMsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUM7UUFDakMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEMsQ0FBQztBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxob29rc1xcdXNlUHJvbW9Db2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIlxyXG5cclxuaW1wb3J0IHsgdXNlU3RhdGUsIHVzZU1lbW8gfSBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCB7IHRvYXN0IH0gZnJvbSAnc29ubmVyJztcclxuaW1wb3J0IHR5cGUgeyBQcm9tb0NvZGUsIFByb21vQ29kZUZpbHRlcnMgfSBmcm9tICdAL3R5cGVzJztcclxuXHJcblxuXG5cblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlUHJvbW9Db2RlTWFuYWdlbWVudChpbml0aWFsUHJvbW9Db2RlczogUHJvbW9Db2RlW10pIHtcclxuICBjb25zdCBbcHJvbW9Db2Rlcywgc2V0UHJvbW9Db2Rlc10gPSB1c2VTdGF0ZTxQcm9tb0NvZGVbXT4oaW5pdGlhbFByb21vQ29kZXMpO1xyXG4gIGNvbnN0IFtsb2FkaW5nU3RhdGVzLCBzZXRMb2FkaW5nU3RhdGVzXSA9IHVzZVN0YXRlPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+Pih7fSk7XHJcblxyXG4gIGNvbnN0IHRvZ2dsZVByb21vQ29kZVN0YXR1cyA9IGFzeW5jIChwcm9tb0NvZGU6IFByb21vQ29kZSkgPT4ge1xyXG4gICAgY29uc3QgbmV3U3RhdHVzID0gcHJvbW9Db2RlLnN0YXR1cyA9PT0gXCJBQ1RJVkVcIiA/IFwiSU5BQ1RJVkVcIiA6IFwiQUNUSVZFXCI7XHJcbiAgICBjb25zdCBhY3Rpb24gPSBuZXdTdGF0dXMgPT09IFwiQUNUSVZFXCIgPyBcImFjdGl2YXJcIiA6IFwiZGVzYWN0aXZhclwiO1xyXG4gICAgXHJcbiAgICBzZXRMb2FkaW5nU3RhdGVzKHByZXYgPT4gKHsgLi4ucHJldiwgW3Byb21vQ29kZS5pZF06IHRydWUgfSkpO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYC9hcGkvcHJvbW8tY29kZXMvJHtwcm9tb0NvZGUuaWR9L3RvZ2dsZS1zdGF0dXNgLCB7XHJcbiAgICAgICAgbWV0aG9kOiBcIlBBVENIXCIsXHJcbiAgICAgICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgc3RhdHVzOiBuZXdTdGF0dXMgfSksXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGRhdGEuZXJyb3IgfHwgYEVycm9yIGFsICR7YWN0aW9ufSBlbCBjw7NkaWdvIHByb21vY2lvbmFsYCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIFxuICAgICAgc2V0UHJvbW9Db2RlcyhwcmV2ID0+IFxyXG4gICAgICAgIHByZXYubWFwKGNvZGUgPT4gXHJcbiAgICAgICAgICBjb2RlLmlkID09PSBwcm9tb0NvZGUuaWQgXHJcbiAgICAgICAgICAgID8geyAuLi5jb2RlLCBzdGF0dXM6IG5ld1N0YXR1cyB9XHJcbiAgICAgICAgICAgIDogY29kZVxyXG4gICAgICAgIClcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHRvYXN0LnN1Y2Nlc3MoYEPDs2RpZ28gcHJvbW9jaW9uYWwgJHthY3Rpb24gPT09IFwiYWN0aXZhclwiID8gXCJhY3RpdmFkb1wiIDogXCJkZXNhY3RpdmFkb1wifSBleGl0b3NhbWVudGVgKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yICR7YWN0aW9ufSBwcm9tbyBjb2RlOmAsIGVycm9yKTtcclxuICAgICAgdG9hc3QuZXJyb3IoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBgRXJyb3IgYWwgJHthY3Rpb259IGVsIGPDs2RpZ28gcHJvbW9jaW9uYWxgKTtcclxuICAgIH0gZmluYWxseSB7XHJcbiAgICAgIHNldExvYWRpbmdTdGF0ZXMocHJldiA9PiAoeyAuLi5wcmV2LCBbcHJvbW9Db2RlLmlkXTogZmFsc2UgfSkpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGNvbnN0IGNvcHlUb0NsaXBib2FyZCA9IChjb2RlOiBzdHJpbmcpID0+IHtcclxuICAgIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KGNvZGUpO1xyXG4gICAgdG9hc3Quc3VjY2VzcyhcIkPDs2RpZ28gY29waWFkbyBhbCBwb3J0YXBhcGVsZXNcIik7XHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHByb21vQ29kZXMsXHJcbiAgICBsb2FkaW5nU3RhdGVzLFxyXG4gICAgdG9nZ2xlUHJvbW9Db2RlU3RhdHVzLFxyXG4gICAgY29weVRvQ2xpcGJvYXJkLFxyXG4gIH07XHJcbn1cclxuXHJcblxuXG5cblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlUHJvbW9Db2RlRmlsdGVycyhwcm9tb0NvZGVzOiBQcm9tb0NvZGVbXSkge1xyXG4gIGNvbnN0IFtmaWx0ZXJzLCBzZXRGaWx0ZXJzXSA9IHVzZVN0YXRlPFByb21vQ29kZUZpbHRlcnM+KHtcclxuICAgIHNlYXJjaDogXCJcIixcclxuICAgIHN0YXR1czogXCJhbGxcIixcclxuICB9KTtcclxuXHJcbiAgY29uc3QgZmlsdGVyZWRQcm9tb0NvZGVzID0gdXNlTWVtbygoKSA9PiB7XHJcbiAgICByZXR1cm4gcHJvbW9Db2Rlcy5maWx0ZXIoKGNvZGUpID0+IHtcclxuICAgICAgY29uc3QgbWF0Y2hlc1NlYXJjaCA9ICFmaWx0ZXJzLnNlYXJjaCB8fCBcclxuICAgICAgICBjb2RlLmNvZGUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXJzLnNlYXJjaC50b0xvd2VyQ2FzZSgpKSB8fFxyXG4gICAgICAgIGNvZGUubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZpbHRlcnMuc2VhcmNoLnRvTG93ZXJDYXNlKCkpO1xyXG5cclxuICAgICAgY29uc3QgbWF0Y2hlc1N0YXR1cyA9IGZpbHRlcnMuc3RhdHVzID09PSBcImFsbFwiIHx8IGNvZGUuc3RhdHVzID09PSBmaWx0ZXJzLnN0YXR1cztcclxuXHJcbiAgICAgIHJldHVybiBtYXRjaGVzU2VhcmNoICYmIG1hdGNoZXNTdGF0dXM7XHJcbiAgICB9KTtcclxuICB9LCBbcHJvbW9Db2RlcywgZmlsdGVyc10pO1xyXG5cclxuICBjb25zdCB1cGRhdGVGaWx0ZXIgPSA8SyBleHRlbmRzIGtleW9mIFByb21vQ29kZUZpbHRlcnM+KFxyXG4gICAga2V5OiBLLCBcclxuICAgIHZhbHVlOiBQcm9tb0NvZGVGaWx0ZXJzW0tdXHJcbiAgKSA9PiB7XHJcbiAgICBzZXRGaWx0ZXJzKHByZXYgPT4gKHsgLi4ucHJldiwgW2tleV06IHZhbHVlIH0pKTtcclxuICB9O1xyXG5cclxuICBjb25zdCBjbGVhckZpbHRlcnMgPSAoKSA9PiB7XHJcbiAgICBzZXRGaWx0ZXJzKHsgc2VhcmNoOiBcIlwiLCBzdGF0dXM6IFwiYWxsXCIgfSk7XHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGZpbHRlcnMsXHJcbiAgICBmaWx0ZXJlZFByb21vQ29kZXMsXHJcbiAgICB1cGRhdGVGaWx0ZXIsXHJcbiAgICBjbGVhckZpbHRlcnMsXHJcbiAgfTtcclxufVxyXG5cclxuXG5cblxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2VQcm9tb0NvZGVTdGF0cyhwcm9tb0NvZGVzOiBQcm9tb0NvZGVbXSkge1xyXG4gIGNvbnN0IHN0YXRzID0gdXNlTWVtbygoKSA9PiB7XHJcbiAgICBjb25zdCB0b3RhbCA9IHByb21vQ29kZXMubGVuZ3RoO1xyXG4gICAgY29uc3QgYWN0aXZlID0gcHJvbW9Db2Rlcy5maWx0ZXIoY29kZSA9PiBjb2RlLnN0YXR1cyA9PT0gXCJBQ1RJVkVcIikubGVuZ3RoO1xyXG4gICAgY29uc3QgdG90YWxVc2FnZXMgPSBwcm9tb0NvZGVzLnJlZHVjZSgoc3VtLCBjb2RlKSA9PiBzdW0gKyBjb2RlLnVzZWRDb3VudCwgMCk7XHJcbiAgICBjb25zdCBleHBpcmVkID0gcHJvbW9Db2Rlcy5maWx0ZXIoY29kZSA9PiBjb2RlLnN0YXR1cyA9PT0gXCJFWFBJUkVEXCIpLmxlbmd0aDtcclxuICAgIGNvbnN0IGluYWN0aXZlID0gcHJvbW9Db2Rlcy5maWx0ZXIoY29kZSA9PiBjb2RlLnN0YXR1cyA9PT0gXCJJTkFDVElWRVwiKS5sZW5ndGg7XHJcbiAgICBjb25zdCB1c2VkVXAgPSBwcm9tb0NvZGVzLmZpbHRlcihjb2RlID0+IGNvZGUuc3RhdHVzID09PSBcIlVTRURfVVBcIikubGVuZ3RoO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRvdGFsLFxyXG4gICAgICBhY3RpdmUsXHJcbiAgICAgIGluYWN0aXZlLFxyXG4gICAgICBleHBpcmVkLFxyXG4gICAgICB1c2VkVXAsXHJcbiAgICAgIHRvdGFsVXNhZ2VzLFxyXG4gICAgICBhY3RpdmVQZXJjZW50YWdlOiB0b3RhbCA+IDAgPyAoYWN0aXZlIC8gdG90YWwpICogMTAwIDogMCxcclxuICAgICAgdXNhZ2VSYXRlOiB0b3RhbCA+IDAgPyAodG90YWxVc2FnZXMgLyB0b3RhbCkgOiAwLFxyXG4gICAgfTtcclxuICB9LCBbcHJvbW9Db2Rlc10pO1xyXG5cclxuICByZXR1cm4gc3RhdHM7XHJcbn1cclxuXHJcblxuXG5cblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlUHJvbW9Db2RlU2hhcmluZygpIHtcclxuICBjb25zdCBzaGFyZVByb21vQ29kZSA9IChjb2RlOiBQcm9tb0NvZGUsIGZvcm1hdERpc2NvdW50OiAodHlwZTogc3RyaW5nLCB2YWx1ZTogbnVtYmVyKSA9PiBzdHJpbmcpID0+IHtcclxuICAgIGNvbnN0IHNoYXJlVGV4dCA9IGDwn46rIMKhRGVzY3VlbnRvIGVzcGVjaWFsISBVc2EgZWwgY8OzZGlnbyAke2NvZGUuY29kZX0geSBvYnTDqW4gJHtmb3JtYXREaXNjb3VudChjb2RlLnR5cGUsIGNvZGUudmFsdWUpfSBlbiB0dSBwcsOzeGltYSBjb21wcmEuYDtcclxuXHJcbiAgICBpZiAobmF2aWdhdG9yLnNoYXJlKSB7XHJcbiAgICAgIG5hdmlnYXRvci5zaGFyZSh7XHJcbiAgICAgICAgdGl0bGU6IGBDw7NkaWdvIHByb21vY2lvbmFsOiAke2NvZGUubmFtZX1gLFxyXG4gICAgICAgIHRleHQ6IHNoYXJlVGV4dCxcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChzaGFyZVRleHQpO1xyXG4gICAgICB0b2FzdC5zdWNjZXNzKFwiVGV4dG8gZGUgcHJvbW9jacOzbiBjb3BpYWRvIGFsIHBvcnRhcGFwZWxlc1wiKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBleHBvcnRQcm9tb0NvZGVzID0gKHByb21vQ29kZXM6IFByb21vQ29kZVtdKSA9PiB7XHJcbiAgICBcbiAgICBjb25zdCBjc3YgPSBnZW5lcmF0ZVByb21vQ29kZUNTVihwcm9tb0NvZGVzKTtcclxuICAgIGRvd25sb2FkQ1NWKGNzdiwgJ2NvZGlnb3MtcHJvbW9jaW9uYWxlcy5jc3YnKTtcclxuICAgIHRvYXN0LnN1Y2Nlc3MoXCJDw7NkaWdvcyBwcm9tb2Npb25hbGVzIGV4cG9ydGFkb3MgZXhpdG9zYW1lbnRlXCIpO1xyXG4gIH07XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzaGFyZVByb21vQ29kZSxcclxuICAgIGV4cG9ydFByb21vQ29kZXMsXHJcbiAgfTtcclxufVxyXG5cclxuXG5cblxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlUHJvbW9Db2RlQ1NWKHByb21vQ29kZXM6IFByb21vQ29kZVtdKTogc3RyaW5nIHtcclxuICBjb25zdCBoZWFkZXJzID0gWydDw7NkaWdvJywgJ05vbWJyZScsICdUaXBvJywgJ1ZhbG9yJywgJ0VzdGFkbycsICdVc2FkbycsICdMw61taXRlJywgJ1bDoWxpZG8gRGVzZGUnLCAnVsOhbGlkbyBIYXN0YSddO1xyXG4gIFxyXG4gIGNvbnN0IHJvd3MgPSBwcm9tb0NvZGVzLm1hcChjb2RlID0+IFtcclxuICAgIGNvZGUuY29kZSxcclxuICAgIGNvZGUubmFtZSxcclxuICAgIGNvZGUudHlwZSxcclxuICAgIGNvZGUudmFsdWUudG9TdHJpbmcoKSxcclxuICAgIGNvZGUuc3RhdHVzLFxyXG4gICAgY29kZS51c2VkQ291bnQudG9TdHJpbmcoKSxcclxuICAgIGNvZGUudXNhZ2VMaW1pdD8udG9TdHJpbmcoKSB8fCAnU2luIGzDrW1pdGUnLFxyXG4gICAgY29kZS52YWxpZEZyb20sXHJcbiAgICBjb2RlLnZhbGlkVW50aWwgfHwgJ1NpbiBmZWNoYSBsw61taXRlJ1xyXG4gIF0pO1xyXG5cclxuICByZXR1cm4gW2hlYWRlcnMsIC4uLnJvd3NdXHJcbiAgICAubWFwKHJvdyA9PiByb3cubWFwKGNlbGwgPT4gYFwiJHtjZWxsfVwiYCkuam9pbignLCcpKVxyXG4gICAgLmpvaW4oJ1xcbicpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZENTVihjb250ZW50OiBzdHJpbmcsIGZpbGVuYW1lOiBzdHJpbmcpIHtcclxuICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2NvbnRlbnRdLCB7IHR5cGU6ICd0ZXh0L2NzdjtjaGFyc2V0PXV0Zi04OycgfSk7XHJcbiAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICBcclxuICBpZiAobGluay5kb3dubG9hZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xyXG4gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCB1cmwpO1xyXG4gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2Rvd25sb2FkJywgZmlsZW5hbWUpO1xyXG4gICAgbGluay5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XHJcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspO1xyXG4gICAgbGluay5jbGljaygpO1xyXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChsaW5rKTtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9