f48d35cb74cb9c99422e1414548036d3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GET = GET;
exports.POST = POST;
const server_1 = require("next/server");
const auth_1 = require("@/lib/auth");
const prisma_1 = require("@/lib/prisma");
const qr_1 = require("@/lib/qr");
const roles_1 = require("@/lib/roles");
async function GET(request, { params }) {
    var _a, _b;
    try {
        const { qrCode } = await params;
        if (!(0, qr_1.validateQRCode)(qrCode)) {
            return server_1.NextResponse.json({ error: "C칩digo QR inv치lido" }, { status: 400 });
        }
        const ticket = await prisma_1.prisma.ticket.findUnique({
            where: { qrCode },
            include: {
                event: {
                    select: {
                        id: true,
                        title: true,
                        startDate: true,
                        endDate: true,
                        location: true,
                        organizer: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                email: true,
                            },
                        },
                    },
                },
                user: {
                    select: {
                        firstName: true,
                        lastName: true,
                        email: true,
                    },
                },
                order: {
                    select: {
                        orderNumber: true,
                        totalAmount: true,
                        currency: true,
                    },
                },
            },
        });
        if (!ticket) {
            return server_1.NextResponse.json({ error: "Ticket no encontrado" }, { status: 404 });
        }
        const attendeeName = ticket.user.firstName
            ? `${ticket.user.firstName} ${ticket.user.lastName || ""}`.trim()
            : ticket.user.email;
        return server_1.NextResponse.json({
            ticket: {
                id: ticket.id,
                qrCode: ticket.qrCode,
                isUsed: ticket.isUsed,
                usedAt: ((_a = ticket.usedAt) === null || _a === void 0 ? void 0 : _a.toISOString()) || null,
                status: ticket.status,
                attendeeName,
                attendeeEmail: ticket.user.email,
                event: Object.assign(Object.assign({}, ticket.event), { startDate: ticket.event.startDate.toISOString(), endDate: ((_b = ticket.event.endDate) === null || _b === void 0 ? void 0 : _b.toISOString()) || null }),
                order: ticket.order,
                createdAt: ticket.createdAt.toISOString(),
            },
            canUse: ticket.status === "ACTIVE" && !ticket.isUsed,
            isEventDay: new Date().toDateString() ===
                new Date(ticket.event.startDate).toDateString(),
        });
    }
    catch (error) {
        console.error("Error verifying ticket:", error);
        return server_1.NextResponse.json({ error: "Error interno del servidor" }, { status: 500 });
    }
}
async function POST(request, { params }) {
    var _a, _b;
    try {
        const { qrCode } = await params;
        const user = await (0, auth_1.requireAuth)();
        if (!(0, qr_1.validateQRCode)(qrCode)) {
            return server_1.NextResponse.json({ error: "C칩digo QR inv치lido" }, { status: 400 });
        }
        if (!(0, roles_1.canScanTickets)(user.role)) {
            return server_1.NextResponse.json({ error: "No tienes permisos para validar tickets" }, { status: 403 });
        }
        const ticket = await prisma_1.prisma.ticket.findUnique({
            where: { qrCode },
            include: {
                event: {
                    select: {
                        id: true,
                        title: true,
                        organizerId: true,
                        startDate: true,
                    },
                },
            },
        });
        if (!ticket) {
            return server_1.NextResponse.json({ error: "Ticket no encontrado" }, { status: 404 });
        }
        const hasPermission = await checkScanPermission(user.id, user.role, ticket.event.id, ticket.event.organizerId);
        if (!hasPermission) {
            return server_1.NextResponse.json({ error: "No tienes permisos para validar tickets de este evento" }, { status: 403 });
        }
        if (ticket.isUsed) {
            return server_1.NextResponse.json({
                error: "Este ticket ya fue usado",
                usedAt: (_a = ticket.usedAt) === null || _a === void 0 ? void 0 : _a.toISOString(),
            }, { status: 400 });
        }
        if (ticket.status !== "ACTIVE") {
            return server_1.NextResponse.json({ error: `Ticket ${ticket.status.toLowerCase()}` }, { status: 400 });
        }
        const updatedTicket = await prisma_1.prisma.ticket.update({
            where: { id: ticket.id },
            data: {
                isUsed: true,
                usedAt: new Date(),
            },
            include: {
                user: {
                    select: {
                        firstName: true,
                        lastName: true,
                        email: true,
                    },
                },
            },
        });
        const attendeeName = updatedTicket.user.firstName
            ? `${updatedTicket.user.firstName} ${updatedTicket.user.lastName || ""}`.trim()
            : updatedTicket.user.email;
        return server_1.NextResponse.json({
            message: "Ticket validado exitosamente",
            ticket: {
                id: updatedTicket.id,
                qrCode: updatedTicket.qrCode,
                isUsed: updatedTicket.isUsed,
                usedAt: (_b = updatedTicket.usedAt) === null || _b === void 0 ? void 0 : _b.toISOString(),
                attendeeName,
                attendeeEmail: updatedTicket.user.email,
                eventTitle: ticket.event.title,
            },
        });
    }
    catch (error) {
        console.error("Error using ticket:", error);
        return server_1.NextResponse.json({ error: "Error interno del servidor" }, { status: 500 });
    }
}
async function checkScanPermission(userId, userRole, eventId, eventOrganizerId) {
    if (userRole === "ADMIN") {
        return true;
    }
    if (userRole === "ORGANIZER" && eventOrganizerId === userId) {
        return true;
    }
    if (userRole === "SCANNER") {
        const assignment = await prisma_1.prisma.eventScanner.findFirst({
            where: {
                eventId: eventId,
                scannerId: userId,
                isActive: true,
            },
        });
        return !!assignment;
    }
    return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxcdmVyaWZ5XFxbcXJDb2RlXVxccm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7QUFNQSxrQkE0RkM7QUFFRCxvQkFvSEM7QUF4TkQsd0NBQXdEO0FBQ3hELHFDQUF5QztBQUN6Qyx5Q0FBc0M7QUFDdEMsaUNBQTBDO0FBQzFDLHVDQUE2QztBQUV0QyxLQUFLLFVBQVUsR0FBRyxDQUN2QixPQUFvQixFQUNwQixFQUFFLE1BQU0sRUFBMkM7O0lBRW5ELElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxNQUFNLE1BQU0sQ0FBQztRQUdoQyxJQUFJLENBQUMsSUFBQSxtQkFBYyxFQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDNUIsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsRUFDL0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxlQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUM1QyxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDakIsT0FBTyxFQUFFO2dCQUNQLEtBQUssRUFBRTtvQkFDTCxNQUFNLEVBQUU7d0JBQ04sRUFBRSxFQUFFLElBQUk7d0JBQ1IsS0FBSyxFQUFFLElBQUk7d0JBQ1gsU0FBUyxFQUFFLElBQUk7d0JBQ2YsT0FBTyxFQUFFLElBQUk7d0JBQ2IsUUFBUSxFQUFFLElBQUk7d0JBQ2QsU0FBUyxFQUFFOzRCQUNULE1BQU0sRUFBRTtnQ0FDTixFQUFFLEVBQUUsSUFBSTtnQ0FDUixTQUFTLEVBQUUsSUFBSTtnQ0FDZixRQUFRLEVBQUUsSUFBSTtnQ0FDZCxLQUFLLEVBQUUsSUFBSTs2QkFDWjt5QkFDRjtxQkFDRjtpQkFDRjtnQkFDRCxJQUFJLEVBQUU7b0JBQ0os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LEVBQUUsTUFBTTtnQkFDakIsUUFBUSxFQUFFLElBQUk7YUFDZjtTQUNGLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQztJQUN0QixDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQmlsdXJcXERvY3VtZW50c1xcRGV2ZWxvcG1lbnRcXE5leHRcXHNvcnljay1hY2Nlc3NcXHNyY1xcYXBwXFxhcGlcXHZlcmlmeVxcW3FyQ29kZV1cXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIjtcclxuaW1wb3J0IHsgcmVxdWlyZUF1dGggfSBmcm9tIFwiQC9saWIvYXV0aFwiO1xyXG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tIFwiQC9saWIvcHJpc21hXCI7XHJcbmltcG9ydCB7IHZhbGlkYXRlUVJDb2RlIH0gZnJvbSBcIkAvbGliL3FyXCI7XHJcbmltcG9ydCB7IGNhblNjYW5UaWNrZXRzIH0gZnJvbSBcIkAvbGliL3JvbGVzXCI7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gR0VUKFxyXG4gIHJlcXVlc3Q6IE5leHRSZXF1ZXN0LFxyXG4gIHsgcGFyYW1zIH06IHsgcGFyYW1zOiBQcm9taXNlPHsgcXJDb2RlOiBzdHJpbmcgfT4gfVxyXG4pIHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBxckNvZGUgfSA9IGF3YWl0IHBhcmFtcztcclxuXHJcbiAgICBcbiAgICBpZiAoIXZhbGlkYXRlUVJDb2RlKHFyQ29kZSkpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgIHsgZXJyb3I6IFwiQ8OzZGlnbyBRUiBpbnbDoWxpZG9cIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRpY2tldCA9IGF3YWl0IHByaXNtYS50aWNrZXQuZmluZFVuaXF1ZSh7XHJcbiAgICAgIHdoZXJlOiB7IHFyQ29kZSB9LFxyXG4gICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgZXZlbnQ6IHtcclxuICAgICAgICAgIHNlbGVjdDoge1xyXG4gICAgICAgICAgICBpZDogdHJ1ZSxcclxuICAgICAgICAgICAgdGl0bGU6IHRydWUsXHJcbiAgICAgICAgICAgIHN0YXJ0RGF0ZTogdHJ1ZSxcclxuICAgICAgICAgICAgZW5kRGF0ZTogdHJ1ZSxcclxuICAgICAgICAgICAgbG9jYXRpb246IHRydWUsXHJcbiAgICAgICAgICAgIG9yZ2FuaXplcjoge1xyXG4gICAgICAgICAgICAgIHNlbGVjdDoge1xyXG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgdXNlcjoge1xyXG4gICAgICAgICAgc2VsZWN0OiB7XHJcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcclxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXHJcbiAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9yZGVyOiB7XHJcbiAgICAgICAgICBzZWxlY3Q6IHtcclxuICAgICAgICAgICAgb3JkZXJOdW1iZXI6IHRydWUsXHJcbiAgICAgICAgICAgIHRvdGFsQW1vdW50OiB0cnVlLFxyXG4gICAgICAgICAgICBjdXJyZW5jeTogdHJ1ZSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghdGlja2V0KSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBcIlRpY2tldCBubyBlbmNvbnRyYWRvXCIgfSxcclxuICAgICAgICB7IHN0YXR1czogNDA0IH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhdHRlbmRlZU5hbWUgPSB0aWNrZXQudXNlci5maXJzdE5hbWVcclxuICAgICAgPyBgJHt0aWNrZXQudXNlci5maXJzdE5hbWV9ICR7dGlja2V0LnVzZXIubGFzdE5hbWUgfHwgXCJcIn1gLnRyaW0oKVxyXG4gICAgICA6IHRpY2tldC51c2VyLmVtYWlsO1xyXG5cclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XHJcbiAgICAgIHRpY2tldDoge1xyXG4gICAgICAgIGlkOiB0aWNrZXQuaWQsXHJcbiAgICAgICAgcXJDb2RlOiB0aWNrZXQucXJDb2RlLFxyXG4gICAgICAgIGlzVXNlZDogdGlja2V0LmlzVXNlZCxcclxuICAgICAgICB1c2VkQXQ6IHRpY2tldC51c2VkQXQ/LnRvSVNPU3RyaW5nKCkgfHwgbnVsbCxcclxuICAgICAgICBzdGF0dXM6IHRpY2tldC5zdGF0dXMsXHJcbiAgICAgICAgYXR0ZW5kZWVOYW1lLFxyXG4gICAgICAgIGF0dGVuZGVlRW1haWw6IHRpY2tldC51c2VyLmVtYWlsLFxyXG4gICAgICAgIGV2ZW50OiB7XHJcbiAgICAgICAgICAuLi50aWNrZXQuZXZlbnQsXHJcbiAgICAgICAgICBzdGFydERhdGU6IHRpY2tldC5ldmVudC5zdGFydERhdGUudG9JU09TdHJpbmcoKSxcclxuICAgICAgICAgIGVuZERhdGU6IHRpY2tldC5ldmVudC5lbmREYXRlPy50b0lTT1N0cmluZygpIHx8IG51bGwsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvcmRlcjogdGlja2V0Lm9yZGVyLFxyXG4gICAgICAgIGNyZWF0ZWRBdDogdGlja2V0LmNyZWF0ZWRBdC50b0lTT1N0cmluZygpLFxyXG4gICAgICB9LFxyXG4gICAgICBjYW5Vc2U6IHRpY2tldC5zdGF0dXMgPT09IFwiQUNUSVZFXCIgJiYgIXRpY2tldC5pc1VzZWQsXHJcbiAgICAgIGlzRXZlbnREYXk6XHJcbiAgICAgICAgbmV3IERhdGUoKS50b0RhdGVTdHJpbmcoKSA9PT1cclxuICAgICAgICBuZXcgRGF0ZSh0aWNrZXQuZXZlbnQuc3RhcnREYXRlKS50b0RhdGVTdHJpbmcoKSxcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgdmVyaWZ5aW5nIHRpY2tldDpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICB7IGVycm9yOiBcIkVycm9yIGludGVybm8gZGVsIHNlcnZpZG9yXCIgfSxcclxuICAgICAgeyBzdGF0dXM6IDUwMCB9XHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QoXHJcbiAgcmVxdWVzdDogTmV4dFJlcXVlc3QsXHJcbiAgeyBwYXJhbXMgfTogeyBwYXJhbXM6IFByb21pc2U8eyBxckNvZGU6IHN0cmluZyB9PiB9XHJcbikge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IHFyQ29kZSB9ID0gYXdhaXQgcGFyYW1zO1xyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHJlcXVpcmVBdXRoKCk7XHJcblxyXG4gICAgaWYgKCF2YWxpZGF0ZVFSQ29kZShxckNvZGUpKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBcIkPDs2RpZ28gUVIgaW52w6FsaWRvXCIgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWNhblNjYW5UaWNrZXRzKHVzZXIucm9sZSkpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgIHsgZXJyb3I6IFwiTm8gdGllbmVzIHBlcm1pc29zIHBhcmEgdmFsaWRhciB0aWNrZXRzXCIgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAzIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB0aWNrZXQgPSBhd2FpdCBwcmlzbWEudGlja2V0LmZpbmRVbmlxdWUoe1xyXG4gICAgICB3aGVyZTogeyBxckNvZGUgfSxcclxuICAgICAgaW5jbHVkZToge1xyXG4gICAgICAgIGV2ZW50OiB7XHJcbiAgICAgICAgICBzZWxlY3Q6IHtcclxuICAgICAgICAgICAgaWQ6IHRydWUsXHJcbiAgICAgICAgICAgIHRpdGxlOiB0cnVlLFxyXG4gICAgICAgICAgICBvcmdhbml6ZXJJZDogdHJ1ZSxcclxuICAgICAgICAgICAgc3RhcnREYXRlOiB0cnVlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCF0aWNrZXQpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgIHsgZXJyb3I6IFwiVGlja2V0IG5vIGVuY29udHJhZG9cIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDQgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBhd2FpdCBjaGVja1NjYW5QZXJtaXNzaW9uKFxyXG4gICAgICB1c2VyLmlkLFxyXG4gICAgICB1c2VyLnJvbGUsXHJcbiAgICAgIHRpY2tldC5ldmVudC5pZCxcclxuICAgICAgdGlja2V0LmV2ZW50Lm9yZ2FuaXplcklkXHJcbiAgICApO1xyXG5cclxuICAgIGlmICghaGFzUGVybWlzc2lvbikge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJObyB0aWVuZXMgcGVybWlzb3MgcGFyYSB2YWxpZGFyIHRpY2tldHMgZGUgZXN0ZSBldmVudG9cIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDMgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aWNrZXQuaXNVc2VkKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7XHJcbiAgICAgICAgICBlcnJvcjogXCJFc3RlIHRpY2tldCB5YSBmdWUgdXNhZG9cIixcclxuICAgICAgICAgIHVzZWRBdDogdGlja2V0LnVzZWRBdD8udG9JU09TdHJpbmcoKSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aWNrZXQuc3RhdHVzICE9PSBcIkFDVElWRVwiKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBgVGlja2V0ICR7dGlja2V0LnN0YXR1cy50b0xvd2VyQ2FzZSgpfWAgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1cGRhdGVkVGlja2V0ID0gYXdhaXQgcHJpc21hLnRpY2tldC51cGRhdGUoe1xyXG4gICAgICB3aGVyZTogeyBpZDogdGlja2V0LmlkIH0sXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBpc1VzZWQ6IHRydWUsXHJcbiAgICAgICAgdXNlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9LFxyXG4gICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgdXNlcjoge1xyXG4gICAgICAgICAgc2VsZWN0OiB7XHJcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcclxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXHJcbiAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgYXR0ZW5kZWVOYW1lID0gdXBkYXRlZFRpY2tldC51c2VyLmZpcnN0TmFtZVxyXG4gICAgICA/IGAke3VwZGF0ZWRUaWNrZXQudXNlci5maXJzdE5hbWV9ICR7XHJcbiAgICAgICAgICB1cGRhdGVkVGlja2V0LnVzZXIubGFzdE5hbWUgfHwgXCJcIlxyXG4gICAgICAgIH1gLnRyaW0oKVxyXG4gICAgICA6IHVwZGF0ZWRUaWNrZXQudXNlci5lbWFpbDtcclxuXHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICBtZXNzYWdlOiBcIlRpY2tldCB2YWxpZGFkbyBleGl0b3NhbWVudGVcIixcclxuICAgICAgdGlja2V0OiB7XHJcbiAgICAgICAgaWQ6IHVwZGF0ZWRUaWNrZXQuaWQsXHJcbiAgICAgICAgcXJDb2RlOiB1cGRhdGVkVGlja2V0LnFyQ29kZSxcclxuICAgICAgICBpc1VzZWQ6IHVwZGF0ZWRUaWNrZXQuaXNVc2VkLFxyXG4gICAgICAgIHVzZWRBdDogdXBkYXRlZFRpY2tldC51c2VkQXQ/LnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgYXR0ZW5kZWVOYW1lLFxyXG4gICAgICAgIGF0dGVuZGVlRW1haWw6IHVwZGF0ZWRUaWNrZXQudXNlci5lbWFpbCxcclxuICAgICAgICBldmVudFRpdGxlOiB0aWNrZXQuZXZlbnQudGl0bGUsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIHVzaW5nIHRpY2tldDpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICB7IGVycm9yOiBcIkVycm9yIGludGVybm8gZGVsIHNlcnZpZG9yXCIgfSxcclxuICAgICAgeyBzdGF0dXM6IDUwMCB9XHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gY2hlY2tTY2FuUGVybWlzc2lvbihcclxuICB1c2VySWQ6IHN0cmluZyxcclxuICB1c2VyUm9sZTogc3RyaW5nLFxyXG4gIGV2ZW50SWQ6IHN0cmluZyxcclxuICBldmVudE9yZ2FuaXplcklkOiBzdHJpbmdcclxuKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgaWYgKHVzZXJSb2xlID09PSBcIkFETUlOXCIpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgaWYgKHVzZXJSb2xlID09PSBcIk9SR0FOSVpFUlwiICYmIGV2ZW50T3JnYW5pemVySWQgPT09IHVzZXJJZCkge1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBpZiAodXNlclJvbGUgPT09IFwiU0NBTk5FUlwiKSB7XHJcbiAgICBjb25zdCBhc3NpZ25tZW50ID0gYXdhaXQgcHJpc21hLmV2ZW50U2Nhbm5lci5maW5kRmlyc3Qoe1xyXG4gICAgICB3aGVyZToge1xyXG4gICAgICAgIGV2ZW50SWQ6IGV2ZW50SWQsXHJcbiAgICAgICAgc2Nhbm5lcklkOiB1c2VySWQsXHJcbiAgICAgICAgaXNBY3RpdmU6IHRydWUsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gISFhc3NpZ25tZW50O1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==