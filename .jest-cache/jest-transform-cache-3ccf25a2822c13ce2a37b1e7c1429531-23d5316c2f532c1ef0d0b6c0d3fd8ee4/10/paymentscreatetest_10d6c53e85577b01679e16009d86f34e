c77f6620ddf80c130b9183fe5d286f22
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable @typescript-eslint/no-explicit-any */
jest.mock('next/server', () => ({ NextResponse: { json: (body, opts) => ({ status: (opts === null || opts === void 0 ? void 0 : opts.status) || 200, body }) } }));
jest.mock('@/lib/auth', () => ({ requireAuth: jest.fn().mockResolvedValue(mockUser) }));
jest.mock('@/lib/transbank', () => ({ webpayPlus: mockWebpay }));
jest.mock('@/lib/commission', () => mockCalculate);
jest.mock('@/lib/discount-codes', () => mockDiscount);
jest.mock('@/lib/prisma', () => ({ prisma: mockPrisma }));
jest.mock('@/lib/qr', () => ({ generateUniqueQRCode: jest.fn().mockReturnValue('QR123') }));
jest.mock('@/lib/email', () => ({ sendTicketEmail: jest.fn() }));
// Mocks
const mockUser = { id: 'user_1', email: 'u@u.com', firstName: 'U' };
const mockWebpay = { create: jest.fn() };
const mockCalculate = {
    calculatePriceBreakdown: jest.fn(),
    calculatePriceBreakdownWithDiscount: jest.fn()
};
const mockDiscount = {
    DiscountCodeService: {
        validateDiscountCode: jest.fn(),
        applyCodeUsage: jest.fn()
    }
};
const mockPrisma = {
    ticketType: { findUnique: jest.fn() },
    ticket: { count: jest.fn() },
    event: { findUnique: jest.fn() },
    order: { create: jest.fn(), update: jest.fn(), findUnique: jest.fn() },
    payment: { create: jest.fn() },
    $transaction: jest.fn()
};
describe('POST /api/payments/create', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    it('returns 400 when body is invalid', async () => {
        // requireAuth will resolve to mockUser
        const req = { json: async () => ({ quantity: 2 }) };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        expect(res.status).toBe(400);
        expect(res.body.error).toBeDefined();
    });
    it('creates a payment and returns transbank url and token for paid order', async () => {
        // Setup ticket type and event
        const ticketType = {
            id: 'tt1',
            price: 5000,
            ticketsGenerated: 1,
            capacity: 100,
            event: { id: 'e1', isPublished: true, currency: 'CLP' }
        };
        mockPrisma.ticketType.findUnique.mockResolvedValue(ticketType);
        mockPrisma.ticket.count.mockResolvedValue(0);
        // Price breakdown
        mockCalculate.calculatePriceBreakdown.mockReturnValue({ basePrice: 5000, commission: 0, totalPrice: 5000, originalAmount: 5000, discountAmount: 0 });
        // Order creation
        const createdOrder = { id: 'order_1', orderNumber: 'SP123', quantity: 1 };
        mockPrisma.order.create.mockResolvedValue(createdOrder);
        // Webpay responds
        mockWebpay.create.mockResolvedValue({ url: 'https://webpay.test/checkout', token: 'tok_123' });
        // Payment create
        mockPrisma.payment.create.mockResolvedValue({ id: 'pay_1' });
        const reqBody = { ticketTypeId: 'tt1', quantity: 1 };
        const req = { json: async () => reqBody };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        expect(res.status).toBe(200);
        expect(res.body.success).toBe(true);
        expect(res.body.paymentUrl).toBe('https://webpay.test/checkout');
        expect(res.body.token).toBe('tok_123');
        expect(mockWebpay.create).toHaveBeenCalled();
        expect(mockPrisma.payment.create).toHaveBeenCalled();
    });
    it('applies promo code for a discounted paid order', async () => {
        const ticketType = {
            id: 'tt1',
            price: 5000,
            ticketsGenerated: 1,
            capacity: 100,
            event: { id: 'e1', isPublished: true, currency: 'CLP' }
        };
        mockPrisma.ticketType.findUnique.mockResolvedValueOnce(ticketType);
        mockPrisma.ticket.count.mockResolvedValueOnce(0);
        // promo gives 1000 CLP off
        const discountAmount = 1000;
        mockDiscount.DiscountCodeService.validateDiscountCode.mockResolvedValueOnce({ isValid: true, discountAmount, code: 'PROMO1', type: 'FIXED' });
        mockCalculate.calculatePriceBreakdownWithDiscount.mockReturnValueOnce({ basePrice: 4000, commission: 0, totalPrice: 4000, originalAmount: 5000, discountAmount });
        const createdOrder = { id: 'order_2', orderNumber: 'SP124', quantity: 1 };
        mockPrisma.order.create.mockResolvedValueOnce(createdOrder);
        mockWebpay.create.mockResolvedValueOnce({ url: 'https://webpay.test/checkout2', token: 'tok_456' });
        mockPrisma.payment.create.mockResolvedValueOnce({ id: 'pay_2' });
        const reqBody = { ticketTypeId: 'tt1', quantity: 1, promoCode: 'PROMO1' };
        const req = { json: async () => reqBody };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        expect(res.status).toBe(200);
        expect(res.body.success).toBe(true);
        expect(res.body.priceBreakdown.promoCode).toBe('PROMO1');
        expect(mockDiscount.DiscountCodeService.validateDiscountCode).toHaveBeenCalled();
        expect(mockWebpay.create).toHaveBeenCalled();
    });
    it('processes free-ticket flow (final total 0) and generates tickets', async () => {
        const ticketType = {
            id: 'tt_free',
            price: 5000,
            ticketsGenerated: 1,
            capacity: 100,
            event: { id: 'e_free', isPublished: true, currency: 'CLP' }
        };
        mockPrisma.ticketType.findUnique.mockResolvedValueOnce(ticketType);
        mockPrisma.ticket.count.mockResolvedValueOnce(0);
        const baseTotal = 5000;
        // promo gives full discount so final total 0
        mockDiscount.DiscountCodeService.validateDiscountCode.mockResolvedValueOnce({ isValid: true, discountAmount: baseTotal, code: 'FREE100', type: 'FIXED' });
        mockCalculate.calculatePriceBreakdownWithDiscount.mockReturnValueOnce({ basePrice: 0, commission: 0, totalPrice: 0, originalAmount: baseTotal, discountAmount: baseTotal });
        const createdOrder = { id: 'order_free', orderNumber: 'SPFREE', quantity: 1 };
        mockPrisma.order.create.mockResolvedValueOnce(createdOrder);
        // $transaction returns [resultOfCreateMany, updatedOrder]
        const updatedOrder = { id: createdOrder.id, tickets: [{ qrCode: 'QR1' }] };
        mockPrisma.$transaction.mockResolvedValueOnce([null, updatedOrder]);
        const reqBody = { ticketTypeId: 'tt_free', quantity: 1, promoCode: 'FREE100' };
        const req = { json: async () => reqBody };
        const { POST } = await Promise.resolve().then(() => __importStar(require('../../../src/app/api/payments/create/route')));
        const res = (await POST(req));
        // Mock event lookup used in handleAndGenerateTickets
        const eventWithOrganizer = {
            id: ticketType.event.id,
            title: 'Free Event',
            startDate: new Date(),
            location: 'Online',
            organizer: { id: 'org1', name: 'Org' }
        };
        // ensure prisma.event.findUnique exists on the mock
        mockPrisma.event = { findUnique: jest.fn().mockResolvedValueOnce(eventWithOrganizer) };
        expect(res.status).toBe(200);
        expect(res.body.isFree).toBe(true);
        expect(res.body.ticketsGenerated).toBeGreaterThan(0);
        expect(mockDiscount.DiscountCodeService.applyCodeUsage).toHaveBeenCalled();
        expect(mockPrisma.$transaction).toHaveBeenCalled();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxfX3Rlc3RzX19cXGFwaVxccGF5bWVudHMuY3JlYXRlLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1REFBdUQ7QUFDdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLElBQVMsRUFBRSxJQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsTUFBTSxLQUFJLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFJaEksSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFHdkYsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQU1oRSxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBUWxELElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUE7QUFVckQsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFFekQsSUFBSSxDQUFDLElB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RTtZQUN2QixLQUFLLEVBQUUsWUFBWTtZQUNuQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsU0FBUyxFQUFFLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFO1NBQ3ZDLENBQUE7UUFDRCxvREFBb0Q7UUFDcEQsVUFBVSxDQUFDLEtBQUssR0FBRyxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFBO1FBRXRGLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzlCLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNsQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNwRCxNQUFNLENBQUMsWUFBWSxDQUFDLG1CQUFtQixDQUFDLGNBQWMsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUE7UUFDMUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO0lBQ2xELENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxfX3Rlc3RzX19cXGFwaVxccGF5bWVudHMuY3JlYXRlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xyXG5qZXN0Lm1vY2soJ25leHQvc2VydmVyJywgKCkgPT4gKHsgTmV4dFJlc3BvbnNlOiB7IGpzb246IChib2R5OiBhbnksIG9wdHM/OiBhbnkpID0+ICh7IHN0YXR1czogb3B0cz8uc3RhdHVzIHx8IDIwMCwgYm9keSB9KSB9IH0pKVxyXG5cclxuLy8gTW9ja3NcclxuY29uc3QgbW9ja1VzZXIgPSB7IGlkOiAndXNlcl8xJywgZW1haWw6ICd1QHUuY29tJywgZmlyc3ROYW1lOiAnVScgfVxyXG5qZXN0Lm1vY2soJ0AvbGliL2F1dGgnLCAoKSA9PiAoeyByZXF1aXJlQXV0aDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKSB9KSlcclxuXHJcbmNvbnN0IG1vY2tXZWJwYXkgPSB7IGNyZWF0ZTogamVzdC5mbigpIH1cclxuamVzdC5tb2NrKCdAL2xpYi90cmFuc2JhbmsnLCAoKSA9PiAoeyB3ZWJwYXlQbHVzOiBtb2NrV2VicGF5IH0pKVxyXG5cclxuY29uc3QgbW9ja0NhbGN1bGF0ZSA9IHtcclxuICBjYWxjdWxhdGVQcmljZUJyZWFrZG93bjogamVzdC5mbigpLFxyXG4gIGNhbGN1bGF0ZVByaWNlQnJlYWtkb3duV2l0aERpc2NvdW50OiBqZXN0LmZuKClcclxufVxyXG5qZXN0Lm1vY2soJ0AvbGliL2NvbW1pc3Npb24nLCAoKSA9PiBtb2NrQ2FsY3VsYXRlKVxyXG5cclxuY29uc3QgbW9ja0Rpc2NvdW50ID0ge1xyXG4gIERpc2NvdW50Q29kZVNlcnZpY2U6IHtcclxuICAgIHZhbGlkYXRlRGlzY291bnRDb2RlOiBqZXN0LmZuKCksXHJcbiAgICBhcHBseUNvZGVVc2FnZTogamVzdC5mbigpXHJcbiAgfVxyXG59XHJcbmplc3QubW9jaygnQC9saWIvZGlzY291bnQtY29kZXMnLCAoKSA9PiBtb2NrRGlzY291bnQpXHJcblxyXG5jb25zdCBtb2NrUHJpc21hID0ge1xyXG4gIHRpY2tldFR5cGU6IHsgZmluZFVuaXF1ZTogamVzdC5mbigpIH0sXHJcbiAgdGlja2V0OiB7IGNvdW50OiBqZXN0LmZuKCkgfSxcclxuICBldmVudDogeyBmaW5kVW5pcXVlOiBqZXN0LmZuKCkgfSxcclxuICBvcmRlcjogeyBjcmVhdGU6IGplc3QuZm4oKSwgdXBkYXRlOiBqZXN0LmZuKCksIGZpbmRVbmlxdWU6IGplc3QuZm4oKSB9LFxyXG4gIHBheW1lbnQ6IHsgY3JlYXRlOiBqZXN0LmZuKCkgfSxcclxuICAkdHJhbnNhY3Rpb246IGplc3QuZm4oKVxyXG59XHJcbmplc3QubW9jaygnQC9saWIvcHJpc21hJywgKCkgPT4gKHsgcHJpc21hOiBtb2NrUHJpc21hIH0pKVxyXG5cclxuamVzdC5tb2NrKCdAL2xpYi9xcicsICgpID0+ICh7IGdlbmVyYXRlVW5pcXVlUVJDb2RlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKCdRUjEyMycpIH0pKVxyXG5qZXN0Lm1vY2soJ0AvbGliL2VtYWlsJywgKCkgPT4gKHsgc2VuZFRpY2tldEVtYWlsOiBqZXN0LmZuKCkgfSkpXHJcblxyXG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gJ0AvbGliL2F1dGgnXHJcbmltcG9ydCB0eXBlIHsgTmV4dFJlcXVlc3QgfSBmcm9tICduZXh0L3NlcnZlcidcclxuXHJcbi8vIE1pbmltYWwgcmVzcG9uc2Ugc2hhcGUgdXNlZCBieSB0aGUgbW9ja2VkIE5leHRSZXNwb25zZSBpbiB0ZXN0c1xyXG50eXBlIFJlc3BvbnNlTGlrZSA9IHsgc3RhdHVzOiBudW1iZXI7IGJvZHk6IGFueSB9XHJcblxyXG5kZXNjcmliZSgnUE9TVCAvYXBpL3BheW1lbnRzL2NyZWF0ZScsICgpID0+IHtcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXHJcbiAgfSlcclxuXHJcbiAgaXQoJ3JldHVybnMgNDAwIHdoZW4gYm9keSBpcyBpbnZhbGlkJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgLy8gcmVxdWlyZUF1dGggd2lsbCByZXNvbHZlIHRvIG1vY2tVc2VyXHJcbiAgICBjb25zdCByZXEgPSB7IGpzb246IGFzeW5jICgpID0+ICh7IHF1YW50aXR5OiAyIH0pIH1cclxuICBjb25zdCB7IFBPU1QgfSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vLi4vc3JjL2FwcC9hcGkvcGF5bWVudHMvY3JlYXRlL3JvdXRlJylcclxuICBjb25zdCByZXMgPSAoYXdhaXQgUE9TVChyZXEgYXMgdW5rbm93biBhcyBOZXh0UmVxdWVzdCkpIGFzIHVua25vd24gYXMgUmVzcG9uc2VMaWtlXHJcbiAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoNDAwKVxyXG4gIGV4cGVjdChyZXMuYm9keS5lcnJvcikudG9CZURlZmluZWQoKVxyXG4gIH0pXHJcblxyXG4gIGl0KCdjcmVhdGVzIGEgcGF5bWVudCBhbmQgcmV0dXJucyB0cmFuc2JhbmsgdXJsIGFuZCB0b2tlbiBmb3IgcGFpZCBvcmRlcicsIGFzeW5jICgpID0+IHtcclxuICAgIC8vIFNldHVwIHRpY2tldCB0eXBlIGFuZCBldmVudFxyXG4gICAgY29uc3QgdGlja2V0VHlwZSA9IHtcclxuICAgICAgaWQ6ICd0dDEnLFxyXG4gICAgICBwcmljZTogNTAwMCxcclxuICAgICAgdGlja2V0c0dlbmVyYXRlZDogMSxcclxuICAgICAgY2FwYWNpdHk6IDEwMCxcclxuICAgICAgZXZlbnQ6IHsgaWQ6ICdlMScsIGlzUHVibGlzaGVkOiB0cnVlLCBjdXJyZW5jeTogJ0NMUCcgfVxyXG4gICAgfVxyXG4gICAgbW9ja1ByaXNtYS50aWNrZXRUeXBlLmZpbmRVbmlxdWUubW9ja1Jlc29sdmVkVmFsdWUodGlja2V0VHlwZSlcclxuICAgIG1vY2tQcmlzbWEudGlja2V0LmNvdW50Lm1vY2tSZXNvbHZlZFZhbHVlKDApXHJcblxyXG4gICAgLy8gUHJpY2UgYnJlYWtkb3duXHJcbiAgICBtb2NrQ2FsY3VsYXRlLmNhbGN1bGF0ZVByaWNlQnJlYWtkb3duLm1vY2tSZXR1cm5WYWx1ZSh7IGJhc2VQcmljZTogNTAwMCwgY29tbWlzc2lvbjogMCwgdG90YWxQcmljZTogNTAwMCwgb3JpZ2luYWxBbW91bnQ6IDUwMDAsIGRpc2NvdW50QW1vdW50OiAwIH0pXHJcblxyXG4gICAgLy8gT3JkZXIgY3JlYXRpb25cclxuICAgIGNvbnN0IGNyZWF0ZWRPcmRlciA9IHsgaWQ6ICdvcmRlcl8xJywgb3JkZXJOdW1iZXI6ICdTUDEyMycsIHF1YW50aXR5OiAxIH1cclxuICAgIG1vY2tQcmlzbWEub3JkZXIuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlKGNyZWF0ZWRPcmRlcilcclxuXHJcbiAgICAvLyBXZWJwYXkgcmVzcG9uZHNcclxuICAgIG1vY2tXZWJwYXkuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlKHsgdXJsOiAnaHR0cHM6Ly93ZWJwYXkudGVzdC9jaGVja291dCcsIHRva2VuOiAndG9rXzEyMycgfSlcclxuXHJcbiAgICAvLyBQYXltZW50IGNyZWF0ZVxyXG4gICAgbW9ja1ByaXNtYS5wYXltZW50LmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAncGF5XzEnIH0pXHJcblxyXG4gICAgY29uc3QgcmVxQm9keSA9IHsgdGlja2V0VHlwZUlkOiAndHQxJywgcXVhbnRpdHk6IDEgfVxyXG4gICAgY29uc3QgcmVxID0geyBqc29uOiBhc3luYyAoKSA9PiByZXFCb2R5IH1cclxuXHJcbiAgICBjb25zdCB7IFBPU1QgfSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vLi4vc3JjL2FwcC9hcGkvcGF5bWVudHMvY3JlYXRlL3JvdXRlJylcclxuICBjb25zdCByZXMgPSAoYXdhaXQgUE9TVChyZXEgYXMgdW5rbm93biBhcyBOZXh0UmVxdWVzdCkpIGFzIHVua25vd24gYXMgUmVzcG9uc2VMaWtlXHJcblxyXG4gIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMClcclxuICBleHBlY3QocmVzLmJvZHkuc3VjY2VzcykudG9CZSh0cnVlKVxyXG4gIGV4cGVjdChyZXMuYm9keS5wYXltZW50VXJsKS50b0JlKCdodHRwczovL3dlYnBheS50ZXN0L2NoZWNrb3V0JylcclxuICBleHBlY3QocmVzLmJvZHkudG9rZW4pLnRvQmUoJ3Rva18xMjMnKVxyXG4gIGV4cGVjdChtb2NrV2VicGF5LmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZCgpXHJcbiAgZXhwZWN0KG1vY2tQcmlzbWEucGF5bWVudC5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKVxyXG4gIH0pXHJcblxyXG4gIGl0KCdhcHBsaWVzIHByb21vIGNvZGUgZm9yIGEgZGlzY291bnRlZCBwYWlkIG9yZGVyJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgdGlja2V0VHlwZSA9IHtcclxuICAgICAgaWQ6ICd0dDEnLFxyXG4gICAgICBwcmljZTogNTAwMCxcclxuICAgICAgdGlja2V0c0dlbmVyYXRlZDogMSxcclxuICAgICAgY2FwYWNpdHk6IDEwMCxcclxuICAgICAgZXZlbnQ6IHsgaWQ6ICdlMScsIGlzUHVibGlzaGVkOiB0cnVlLCBjdXJyZW5jeTogJ0NMUCcgfVxyXG4gICAgfVxyXG4gICAgbW9ja1ByaXNtYS50aWNrZXRUeXBlLmZpbmRVbmlxdWUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHRpY2tldFR5cGUpXHJcbiAgICBtb2NrUHJpc21hLnRpY2tldC5jb3VudC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoMClcclxuXHJcbiAgICAvLyBwcm9tbyBnaXZlcyAxMDAwIENMUCBvZmZcclxuICAgIGNvbnN0IGRpc2NvdW50QW1vdW50ID0gMTAwMFxyXG4gICAgbW9ja0Rpc2NvdW50LkRpc2NvdW50Q29kZVNlcnZpY2UudmFsaWRhdGVEaXNjb3VudENvZGUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgaXNWYWxpZDogdHJ1ZSwgZGlzY291bnRBbW91bnQsIGNvZGU6ICdQUk9NTzEnLCB0eXBlOiAnRklYRUQnIH0pXHJcbiAgICBtb2NrQ2FsY3VsYXRlLmNhbGN1bGF0ZVByaWNlQnJlYWtkb3duV2l0aERpc2NvdW50Lm1vY2tSZXR1cm5WYWx1ZU9uY2UoeyBiYXNlUHJpY2U6IDQwMDAsIGNvbW1pc3Npb246IDAsIHRvdGFsUHJpY2U6IDQwMDAsIG9yaWdpbmFsQW1vdW50OiA1MDAwLCBkaXNjb3VudEFtb3VudCB9KVxyXG5cclxuICAgIGNvbnN0IGNyZWF0ZWRPcmRlciA9IHsgaWQ6ICdvcmRlcl8yJywgb3JkZXJOdW1iZXI6ICdTUDEyNCcsIHF1YW50aXR5OiAxIH1cclxuICAgIG1vY2tQcmlzbWEub3JkZXIuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlT25jZShjcmVhdGVkT3JkZXIpXHJcblxyXG4gICAgbW9ja1dlYnBheS5jcmVhdGUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgdXJsOiAnaHR0cHM6Ly93ZWJwYXkudGVzdC9jaGVja291dDInLCB0b2tlbjogJ3Rva180NTYnIH0pXHJcbiAgICBtb2NrUHJpc21hLnBheW1lbnQuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGlkOiAncGF5XzInIH0pXHJcblxyXG4gICAgY29uc3QgcmVxQm9keSA9IHsgdGlja2V0VHlwZUlkOiAndHQxJywgcXVhbnRpdHk6IDEsIHByb21vQ29kZTogJ1BST01PMScgfVxyXG4gICAgY29uc3QgcmVxID0geyBqc29uOiBhc3luYyAoKSA9PiByZXFCb2R5IH1cclxuXHJcbiAgICBjb25zdCB7IFBPU1QgfSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vLi4vc3JjL2FwcC9hcGkvcGF5bWVudHMvY3JlYXRlL3JvdXRlJylcclxuICBjb25zdCByZXMgPSAoYXdhaXQgUE9TVChyZXEgYXMgdW5rbm93biBhcyBOZXh0UmVxdWVzdCkpIGFzIHVua25vd24gYXMgUmVzcG9uc2VMaWtlXHJcblxyXG4gIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMClcclxuICBleHBlY3QocmVzLmJvZHkuc3VjY2VzcykudG9CZSh0cnVlKVxyXG4gIGV4cGVjdChyZXMuYm9keS5wcmljZUJyZWFrZG93bi5wcm9tb0NvZGUpLnRvQmUoJ1BST01PMScpXHJcbiAgZXhwZWN0KG1vY2tEaXNjb3VudC5EaXNjb3VudENvZGVTZXJ2aWNlLnZhbGlkYXRlRGlzY291bnRDb2RlKS50b0hhdmVCZWVuQ2FsbGVkKClcclxuICBleHBlY3QobW9ja1dlYnBheS5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKVxyXG4gIH0pXHJcblxyXG4gIGl0KCdwcm9jZXNzZXMgZnJlZS10aWNrZXQgZmxvdyAoZmluYWwgdG90YWwgMCkgYW5kIGdlbmVyYXRlcyB0aWNrZXRzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgdGlja2V0VHlwZSA9IHtcclxuICAgICAgaWQ6ICd0dF9mcmVlJyxcclxuICAgICAgcHJpY2U6IDUwMDAsXHJcbiAgICAgIHRpY2tldHNHZW5lcmF0ZWQ6IDEsXHJcbiAgICAgIGNhcGFjaXR5OiAxMDAsXHJcbiAgICAgIGV2ZW50OiB7IGlkOiAnZV9mcmVlJywgaXNQdWJsaXNoZWQ6IHRydWUsIGN1cnJlbmN5OiAnQ0xQJyB9XHJcbiAgICB9XHJcbiAgICBtb2NrUHJpc21hLnRpY2tldFR5cGUuZmluZFVuaXF1ZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UodGlja2V0VHlwZSlcclxuICAgIG1vY2tQcmlzbWEudGlja2V0LmNvdW50Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSgwKVxyXG5cclxuICAgIGNvbnN0IGJhc2VUb3RhbCA9IDUwMDBcclxuICAgIC8vIHByb21vIGdpdmVzIGZ1bGwgZGlzY291bnQgc28gZmluYWwgdG90YWwgMFxyXG4gICAgbW9ja0Rpc2NvdW50LkRpc2NvdW50Q29kZVNlcnZpY2UudmFsaWRhdGVEaXNjb3VudENvZGUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgaXNWYWxpZDogdHJ1ZSwgZGlzY291bnRBbW91bnQ6IGJhc2VUb3RhbCwgY29kZTogJ0ZSRUUxMDAnLCB0eXBlOiAnRklYRUQnIH0pXHJcbiAgICBtb2NrQ2FsY3VsYXRlLmNhbGN1bGF0ZVByaWNlQnJlYWtkb3duV2l0aERpc2NvdW50Lm1vY2tSZXR1cm5WYWx1ZU9uY2UoeyBiYXNlUHJpY2U6IDAsIGNvbW1pc3Npb246IDAsIHRvdGFsUHJpY2U6IDAsIG9yaWdpbmFsQW1vdW50OiBiYXNlVG90YWwsIGRpc2NvdW50QW1vdW50OiBiYXNlVG90YWwgfSlcclxuXHJcbiAgICBjb25zdCBjcmVhdGVkT3JkZXIgPSB7IGlkOiAnb3JkZXJfZnJlZScsIG9yZGVyTnVtYmVyOiAnU1BGUkVFJywgcXVhbnRpdHk6IDEgfVxyXG4gICAgbW9ja1ByaXNtYS5vcmRlci5jcmVhdGUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKGNyZWF0ZWRPcmRlcilcclxuXHJcbiAgICAvLyAkdHJhbnNhY3Rpb24gcmV0dXJucyBbcmVzdWx0T2ZDcmVhdGVNYW55LCB1cGRhdGVkT3JkZXJdXHJcbiAgICBjb25zdCB1cGRhdGVkT3JkZXIgPSB7IGlkOiBjcmVhdGVkT3JkZXIuaWQsIHRpY2tldHM6IFt7IHFyQ29kZTogJ1FSMScgfV0gfVxyXG4gICAgbW9ja1ByaXNtYS4kdHJhbnNhY3Rpb24ubW9ja1Jlc29sdmVkVmFsdWVPbmNlKFtudWxsLCB1cGRhdGVkT3JkZXJdKVxyXG5cclxuICAgIGNvbnN0IHJlcUJvZHkgPSB7IHRpY2tldFR5cGVJZDogJ3R0X2ZyZWUnLCBxdWFudGl0eTogMSwgcHJvbW9Db2RlOiAnRlJFRTEwMCcgfVxyXG4gICAgY29uc3QgcmVxID0geyBqc29uOiBhc3luYyAoKSA9PiByZXFCb2R5IH1cclxuXHJcbiAgICBjb25zdCB7IFBPU1QgfSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vLi4vc3JjL2FwcC9hcGkvcGF5bWVudHMvY3JlYXRlL3JvdXRlJylcclxuICBjb25zdCByZXMgPSAoYXdhaXQgUE9TVChyZXEgYXMgdW5rbm93biBhcyBOZXh0UmVxdWVzdCkpIGFzIHVua25vd24gYXMgUmVzcG9uc2VMaWtlXHJcblxyXG4gICAgLy8gTW9jayBldmVudCBsb29rdXAgdXNlZCBpbiBoYW5kbGVBbmRHZW5lcmF0ZVRpY2tldHNcclxuICAgIGNvbnN0IGV2ZW50V2l0aE9yZ2FuaXplciA9IHtcclxuICAgICAgaWQ6IHRpY2tldFR5cGUuZXZlbnQuaWQsXHJcbiAgICAgIHRpdGxlOiAnRnJlZSBFdmVudCcsXHJcbiAgICAgIHN0YXJ0RGF0ZTogbmV3IERhdGUoKSxcclxuICAgICAgbG9jYXRpb246ICdPbmxpbmUnLFxyXG4gICAgICBvcmdhbml6ZXI6IHsgaWQ6ICdvcmcxJywgbmFtZTogJ09yZycgfVxyXG4gICAgfVxyXG4gICAgLy8gZW5zdXJlIHByaXNtYS5ldmVudC5maW5kVW5pcXVlIGV4aXN0cyBvbiB0aGUgbW9ja1xyXG4gICAgbW9ja1ByaXNtYS5ldmVudCA9IHsgZmluZFVuaXF1ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlT25jZShldmVudFdpdGhPcmdhbml6ZXIpIH1cclxuXHJcbiAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDApXHJcbiAgZXhwZWN0KHJlcy5ib2R5LmlzRnJlZSkudG9CZSh0cnVlKVxyXG4gIGV4cGVjdChyZXMuYm9keS50aWNrZXRzR2VuZXJhdGVkKS50b0JlR3JlYXRlclRoYW4oMClcclxuICBleHBlY3QobW9ja0Rpc2NvdW50LkRpc2NvdW50Q29kZVNlcnZpY2UuYXBwbHlDb2RlVXNhZ2UpLnRvSGF2ZUJlZW5DYWxsZWQoKVxyXG4gIGV4cGVjdChtb2NrUHJpc21hLiR0cmFuc2FjdGlvbikudG9IYXZlQmVlbkNhbGxlZCgpXHJcbiAgfSlcclxufSlcclxuIl0sInZlcnNpb24iOjN9