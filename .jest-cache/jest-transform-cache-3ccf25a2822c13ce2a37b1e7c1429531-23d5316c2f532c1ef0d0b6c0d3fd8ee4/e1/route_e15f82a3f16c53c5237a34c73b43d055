193353b9fa066b47cf1c6e45cbbf4b6b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.POST = POST;
const server_1 = require("next/server");
const auth_1 = require("@/lib/auth");
const prisma_1 = require("@/lib/prisma");
const transbank_1 = require("@/lib/transbank");
const qr_1 = require("@/lib/qr");
const commission_1 = require("@/lib/commission");
const discount_codes_1 = require("@/lib/discount-codes");
const email_1 = require("@/lib/email");
const zod_1 = require("zod");
const createPaymentSchema = zod_1.z.object({
    ticketTypeId: zod_1.z.string().min(1, "Se requiere el tipo de ticket"),
    quantity: zod_1.z.number().min(1, "La cantidad debe ser al menos 1").max(10, "No puedes comprar más de 10 tickets a la vez."),
    promoCode: zod_1.z.string().optional(),
});
function generateShortBuyOrder(prefix = "SP") {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const hour = String(now.getHours()).padStart(2, "0");
    const minute = String(now.getMinutes()).padStart(2, "0");
    const second = String(now.getSeconds()).padStart(2, "0");
    const ms = String(now.getMilliseconds()).padStart(3, "0").slice(0, 2);
    const random = Math.random().toString(36).substr(2, 2).toUpperCase();
    const buyOrder = `${prefix}${year}${month}${day}${hour}${minute}${second}${ms}${random}`;
    return buyOrder.substring(0, 26);
}
function generateShortSessionId(prefix = "sess") {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 4);
    const sessionId = `${prefix}-${timestamp}-${random}`;
    return sessionId.substring(0, 61);
}
async function POST(request) {
    try {
        console.log("=== INICIO DE CREACIÓN DE PAGO CON PROMO CODES ===");
        const user = await (0, auth_1.requireAuth)();
        const body = await request.json();
        const validation = createPaymentSchema.safeParse(body);
        if (!validation.success) {
            return server_1.NextResponse.json({ error: "Datos inválidos", details: validation.error.issues }, { status: 400 });
        }
        const { ticketTypeId, quantity, promoCode } = validation.data;
        const ticketType = await prisma_1.prisma.ticketType.findUnique({
            where: { id: ticketTypeId },
            include: {
                event: true
            },
        });
        if (!ticketType || !ticketType.event.isPublished) {
            return server_1.NextResponse.json({ error: "Tipo de entrada no encontrado o el evento no está publicado" }, { status: 404 });
        }
        const event = ticketType.event;
        const ticketsSoldForType = await prisma_1.prisma.ticket.count({
            where: { ticketTypeId: ticketTypeId },
        });
        const ticketsGeneratedPerPurchase = ticketType.ticketsGenerated;
        const capacityInTickets = ticketType.capacity * ticketsGeneratedPerPurchase;
        const availableTickets = capacityInTickets - ticketsSoldForType;
        if ((quantity * ticketsGeneratedPerPurchase) > availableTickets) {
            return server_1.NextResponse.json({ error: `No hay suficientes tickets disponibles. Solo quedan ${Math.floor(availableTickets / ticketsGeneratedPerPurchase)}.` }, { status: 400 });
        }
        let discountCodeValidation = null;
        let finalPriceBreakdown = null;
        const basePrice = ticketType.price;
        const baseTotalAmount = basePrice * quantity;
        if (promoCode && promoCode.trim()) {
            console.log(`[DISCOUNT] Validando código de descuento: ${promoCode}`);
            discountCodeValidation = await discount_codes_1.DiscountCodeService.validateDiscountCode(promoCode.trim(), user.id, ticketTypeId, quantity);
            if (!discountCodeValidation.isValid) {
                return server_1.NextResponse.json({ error: discountCodeValidation.error }, { status: 400 });
            }
            console.log(`[DISCOUNT] ✅ Código válido (${discountCodeValidation.type}). Descuento: ${discountCodeValidation.discountAmount}`);
            finalPriceBreakdown = (0, commission_1.calculatePriceBreakdownWithDiscount)(baseTotalAmount, discountCodeValidation.discountAmount || 0, event.currency);
            finalPriceBreakdown.promoCode = discountCodeValidation.code;
        }
        else {
            finalPriceBreakdown = (0, commission_1.calculatePriceBreakdown)(baseTotalAmount, event.currency);
            finalPriceBreakdown.originalAmount = baseTotalAmount;
            finalPriceBreakdown.discountAmount = 0;
        }
        const finalTotalAmount = finalPriceBreakdown.totalPrice;
        console.log(`[PAYMENT] Resumen de precios:`, {
            baseAmount: baseTotalAmount,
            discountAmount: finalPriceBreakdown.discountAmount,
            afterDiscount: finalPriceBreakdown.basePrice,
            commission: finalPriceBreakdown.commission,
            finalTotal: finalTotalAmount,
            hasPromoCode: !!promoCode,
            originalAmount: finalPriceBreakdown.originalAmount
        });
        console.log(`[WEBPAY] Monto que será enviado a WebPay: $${finalTotalAmount} ${event.currency}`);
        const orderNumber = generateShortBuyOrder("SP");
        const order = await prisma_1.prisma.order.create({
            data: {
                orderNumber,
                totalAmount: finalTotalAmount,
                baseAmount: finalPriceBreakdown.basePrice,
                commissionAmount: finalPriceBreakdown.commission,
                originalAmount: finalPriceBreakdown.originalAmount,
                discountAmount: finalPriceBreakdown.discountAmount,
                currency: event.currency,
                quantity,
                status: "PENDING",
                userId: user.id,
                eventId: event.id,
            },
        });
        console.log("Orden creada:", {
            orderId: order.id,
            total: finalTotalAmount,
            discount: finalPriceBreakdown.discountAmount,
            promoApplied: !!promoCode
        });
        const isFree = finalTotalAmount === 0;
        if (isFree) {
            console.log("Entrada gratuita o con descuento del 100%, procesando directamente...");
            if (discountCodeValidation && discountCodeValidation.isValid) {
                await discount_codes_1.DiscountCodeService.applyCodeUsage(discountCodeValidation, user.id, order.id, finalPriceBreakdown.originalAmount || 0, finalTotalAmount);
            }
            return await handleAndGenerateTickets(order, event, user, ticketType);
        }
        const sessionId = generateShortSessionId("sess");
        const returnUrl = `${process.env.NEXT_PUBLIC_APP_URL}/api/transbank/return`;
        const transbankResponse = await transbank_1.webpayPlus.create(order.orderNumber, sessionId, finalTotalAmount, returnUrl);
        await prisma_1.prisma.payment.create({
            data: {
                orderId: order.id,
                transactionId: sessionId,
                token: transbankResponse.token,
                amount: finalTotalAmount,
                currency: event.currency,
                status: "PENDING",
            },
        });
        if (discountCodeValidation && discountCodeValidation.isValid) {
            console.log(`[DISCOUNT] Código ${promoCode} (${discountCodeValidation.type}) quedará pendiente para aplicar tras pago exitoso`);
        }
        return server_1.NextResponse.json({
            success: true,
            orderId: order.id,
            paymentUrl: transbankResponse.url,
            token: transbankResponse.token,
            priceBreakdown: {
                originalAmount: finalPriceBreakdown.originalAmount,
                discountAmount: finalPriceBreakdown.discountAmount,
                baseAmount: finalPriceBreakdown.basePrice,
                commission: finalPriceBreakdown.commission,
                totalAmount: finalTotalAmount,
                promoCode: promoCode || null
            }
        });
    }
    catch (error) {
        console.error("=== ERROR GENERAL EN CREACIÓN DE PAGO ===", error);
        return server_1.NextResponse.json({
            error: "Error interno del servidor",
            details: error instanceof Error ? error.message : "Error desconocido",
        }, { status: 500 });
    }
}
async function handleAndGenerateTickets(order, event, user, ticketType) {
    console.log(`Generando tickets para la orden ${order.orderNumber}`);
    const timestamp = Date.now();
    const ticketsData = [];
    const totalTicketsToGenerate = order.quantity * ticketType.ticketsGenerated;
    for (let i = 0; i < totalTicketsToGenerate; i++) {
        const qrCode = (0, qr_1.generateUniqueQRCode)(event.id, user.id, timestamp, i);
        ticketsData.push({
            qrCode,
            eventId: event.id,
            userId: user.id,
            orderId: order.id,
            ticketTypeId: ticketType.id,
        });
    }
    const transactionResult = await prisma_1.prisma.$transaction([
        prisma_1.prisma.ticket.createMany({ data: ticketsData }),
        prisma_1.prisma.order.update({
            where: { id: order.id },
            data: { status: "PAID" },
            include: { tickets: true }
        }),
    ]);
    const updatedOrder = transactionResult[1];
    console.log(`${ticketsData.length} tickets generados.`);
    const eventWithOrganizer = await prisma_1.prisma.event.findUnique({
        where: { id: event.id },
        include: { organizer: true }
    });
    if (eventWithOrganizer && user.firstName) {
        await (0, email_1.sendTicketEmail)({
            userEmail: user.email,
            userName: user.firstName,
            eventTitle: eventWithOrganizer.title,
            eventDate: eventWithOrganizer.startDate.toISOString(),
            eventLocation: eventWithOrganizer.location,
            orderNumber: updatedOrder.id,
            tickets: updatedOrder.tickets.map(ticket => ({
                qrCode: ticket.qrCode,
                qrCodeImage: `data:image/png;base64,${ticket.qrCode}`
            }))
        });
    }
    return server_1.NextResponse.json({
        success: true,
        orderId: order.id,
        isFree: true,
        ticketsGenerated: totalTicketsToGenerate,
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxccGF5bWVudHNcXGNyZWF0ZVxccm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7QUFzQ0Esb0JBc01DO0FBNU9ELHdDQUF3RDtBQUN4RCxxQ0FBeUM7QUFDekMseUNBQXNDO0FBQ3RDLCtDQUE2QztBQUM3QyxpQ0FBZ0Q7QUFDaEQsaURBQWdHO0FBQ2hHLHlEQUEyRDtBQUMzRCx1Q0FBOEM7QUFDOUMsNkJBQXdCO0FBR3hCLE1BQU0sbUJBQW1CLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxZQUFZLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsK0JBQStCLENBQUM7SUFDaEUsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGlDQUFpQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSwrQ0FBK0MsQ0FBQztJQUN2SCxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtDQUNqQyxDQUFDLENBQUM7QUFFSCxTQUFTLHFCQUFxQixDQUFDLFNBQWlCLElBQUk7SUFDbEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN2QixNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25ELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JFLE1BQU0sUUFBUSxHQUFHLEdBQUcsTUFBTSxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksR0FBRyxNQUFNLEdBQUcsTUFBTSxHQUFHLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztJQUN6RixPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ25DLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLFNBQWlCLE1BQU07SUFDckQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFB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QUUsRUFBRTtRQUN2QixPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFO0tBQzdCLENBQUMsQ0FBQztJQUVILElBQUksa0JBQWtCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3pDLE1BQU0sSUFBQSx1QkFBZSxFQUFDO1lBQ3BCLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSztZQUNyQixRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDeEIsVUFBVSxFQUFFLGtCQUFrQixDQUFDLEtBQUs7WUFDcEMsU0FBUyxFQUFFLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDckQsYUFBYSxFQUFFLGtCQUFrQixDQUFDLFFBQVE7WUFDMUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxFQUFFO1lBQzVCLE9BQU8sRUFBRSxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQzNDLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTztnQkFDdEIsV0FBVyxFQUFFLHlCQUF5QixNQUFNLENBQUMsTUFBTSxFQUFFO2FBQ3RELENBQUMsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLE9BQU8sRUFBRSxJQUFJO1FBQ2IsT0FBTyxFQUFFLEtBQUssQ0FBQyxFQUFFO1FBQ2pCLE1BQU0sRUFBRSxJQUFJO1FBQ1osZ0JBQWdCLEVBQUUsc0JBQXNCO0tBQ3pDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxccGF5bWVudHNcXGNyZWF0ZVxccm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xyXG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gXCJAL2xpYi9hdXRoXCI7XHJcbmltcG9ydCB7IHByaXNtYSB9IGZyb20gXCJAL2xpYi9wcmlzbWFcIjtcclxuaW1wb3J0IHsgd2VicGF5UGx1cyB9IGZyb20gXCJAL2xpYi90cmFuc2JhbmtcIjtcclxuaW1wb3J0IHsgZ2VuZXJhdGVVbmlxdWVRUkNvZGUgfSBmcm9tIFwiQC9saWIvcXJcIjtcclxuaW1wb3J0IHsgY2FsY3VsYXRlUHJpY2VCcmVha2Rvd24sIGNhbGN1bGF0ZVByaWNlQnJlYWtkb3duV2l0aERpc2NvdW50IH0gZnJvbSBcIkAvbGliL2NvbW1pc3Npb25cIjtcclxuaW1wb3J0IHsgRGlzY291bnRDb2RlU2VydmljZSB9IGZyb20gXCJAL2xpYi9kaXNjb3VudC1jb2Rlc1wiO1xyXG5pbXBvcnQgeyBzZW5kVGlja2V0RW1haWwgfSBmcm9tICdAL2xpYi9lbWFpbCc7XHJcbmltcG9ydCB7IHogfSBmcm9tIFwiem9kXCI7XHJcbmltcG9ydCB7IE9yZGVyLCBFdmVudCwgVXNlciwgVGlja2V0VHlwZSB9IGZyb20gXCJAcHJpc21hL2NsaWVudFwiO1xyXG5cclxuY29uc3QgY3JlYXRlUGF5bWVudFNjaGVtYSA9IHoub2JqZWN0KHtcclxuICB0aWNrZXRUeXBlSWQ6IHouc3RyaW5nKCkubWluKDEsIFwiU2UgcmVxdWllcmUgZWwgdGlwbyBkZSB0aWNrZXRcIiksXHJcbiAgcXVhbnRpdHk6IHoubnVtYmVyKCkubWluKDEsIFwiTGEgY2FudGlkYWQgZGViZSBzZXIgYWwgbWVub3MgMVwiKS5tYXgoMTAsIFwiTm8gcHVlZGVzIGNvbXByYXIgbcOhcyBkZSAxMCB0aWNrZXRzIGEgbGEgdmV6LlwiKSxcclxuICBwcm9tb0NvZGU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSwgXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZ2VuZXJhdGVTaG9ydEJ1eU9yZGVyKHByZWZpeDogc3RyaW5nID0gXCJTUFwiKTogc3RyaW5nIHtcclxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gIGNvbnN0IHllYXIgPSBub3cuZ2V0RnVsbFllYXIoKS50b1N0cmluZygpLnNsaWNlKC0yKTtcclxuICBjb25zdCBtb250aCA9IFN0cmluZyhub3cuZ2V0TW9udGgoKSArIDEpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcclxuICBjb25zdCBkYXkgPSBTdHJpbmcobm93LmdldERhdGUoKSkucGFkU3RhcnQoMiwgXCIwXCIpO1xyXG4gIGNvbnN0IGhvdXIgPSBTdHJpbmcobm93LmdldEhvdXJzKCkpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcclxuICBjb25zdCBtaW51dGUgPSBTdHJpbmcobm93LmdldE1pbnV0ZXMoKSkucGFkU3RhcnQoMiwgXCIwXCIpO1xyXG4gIGNvbnN0IHNlY29uZCA9IFN0cmluZyhub3cuZ2V0U2Vjb25kcygpKS5wYWRTdGFydCgyLCBcIjBcIik7XHJcbiAgY29uc3QgbXMgPSBTdHJpbmcobm93LmdldE1pbGxpc2Vjb25kcygpKS5wYWRTdGFydCgzLCBcIjBcIikuc2xpY2UoMCwgMik7XHJcbiAgY29uc3QgcmFuZG9tID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDIpLnRvVXBwZXJDYXNlKCk7XHJcbiAgY29uc3QgYnV5T3JkZXIgPSBgJHtwcmVmaXh9JHt5ZWFyfSR7bW9udGh9JHtkYXl9JHtob3VyfSR7bWludXRlfSR7c2Vjb25kfSR7bXN9JHtyYW5kb219YDtcclxuICByZXR1cm4gYnV5T3JkZXIuc3Vic3RyaW5nKDAsIDI2KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2VuZXJhdGVTaG9ydFNlc3Npb25JZChwcmVmaXg6IHN0cmluZyA9IFwic2Vzc1wiKTogc3RyaW5nIHtcclxuICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpLnRvU3RyaW5nKDM2KTtcclxuICBjb25zdCByYW5kb20gPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgNCk7XHJcbiAgY29uc3Qgc2Vzc2lvbklkID0gYCR7cHJlZml4fS0ke3RpbWVzdGFtcH0tJHtyYW5kb219YDtcclxuICByZXR1cm4gc2Vzc2lvbklkLnN1YnN0cmluZygwLCA2MSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnNvbGUubG9nKFwiPT09IElOSUNJTyBERSBDUkVBQ0nDk04gREUgUEFHTyBDT04gUFJPTU8gQ09ERVMgPT09XCIpO1xyXG5cclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCByZXF1aXJlQXV0aCgpO1xyXG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpO1xyXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IGNyZWF0ZVBheW1lbnRTY2hlbWEuc2FmZVBhcnNlKGJvZHkpO1xyXG5cclxuICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBcIkRhdG9zIGludsOhbGlkb3NcIiwgZGV0YWlsczogdmFsaWRhdGlvbi5lcnJvci5pc3N1ZXMgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB7IHRpY2tldFR5cGVJZCwgcXVhbnRpdHksIHByb21vQ29kZSB9ID0gdmFsaWRhdGlvbi5kYXRhO1xyXG5cclxuICAgIGNvbnN0IHRpY2tldFR5cGUgPSBhd2FpdCBwcmlzbWEudGlja2V0VHlwZS5maW5kVW5pcXVlKHtcclxuICAgICAgd2hlcmU6IHsgaWQ6IHRpY2tldFR5cGVJZCB9LFxyXG4gICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgZXZlbnQ6IHRydWVcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghdGlja2V0VHlwZSB8fCAhdGlja2V0VHlwZS5ldmVudC5pc1B1Ymxpc2hlZCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJUaXBvIGRlIGVudHJhZGEgbm8gZW5jb250cmFkbyBvIGVsIGV2ZW50byBubyBlc3TDoSBwdWJsaWNhZG9cIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDQgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGV2ZW50ID0gdGlja2V0VHlwZS5ldmVudDtcclxuXHJcbiAgICBjb25zdCB0aWNrZXRzU29sZEZvclR5cGUgPSBhd2FpdCBwcmlzbWEudGlja2V0LmNvdW50KHtcclxuICAgICAgd2hlcmU6IHsgdGlja2V0VHlwZUlkOiB0aWNrZXRUeXBlSWQgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHRpY2tldHNHZW5lcmF0ZWRQZXJQdXJjaGFzZSA9IHRpY2tldFR5cGUudGlja2V0c0dlbmVyYXRlZDtcclxuICAgIGNvbnN0IGNhcGFjaXR5SW5UaWNrZXRzID0gdGlja2V0VHlwZS5jYXBhY2l0eSAqIHRpY2tldHNHZW5lcmF0ZWRQZXJQdXJjaGFzZTtcclxuICAgIGNvbnN0IGF2YWlsYWJsZVRpY2tldHMgPSBjYXBhY2l0eUluVGlja2V0cyAtIHRpY2tldHNTb2xkRm9yVHlwZTtcclxuXHJcbiAgICBpZiAoKHF1YW50aXR5ICogdGlja2V0c0dlbmVyYXRlZFBlclB1cmNoYXNlKSA+IGF2YWlsYWJsZVRpY2tldHMpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgIHsgZXJyb3I6IGBObyBoYXkgc3VmaWNpZW50ZXMgdGlja2V0cyBkaXNwb25pYmxlcy4gU29sbyBxdWVkYW4gJHtNYXRoLmZsb29yKGF2YWlsYWJsZVRpY2tldHMgLyB0aWNrZXRzR2VuZXJhdGVkUGVyUHVyY2hhc2UpfS5gIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGRpc2NvdW50Q29kZVZhbGlkYXRpb24gPSBudWxsO1xyXG4gICAgbGV0IGZpbmFsUHJpY2VCcmVha2Rvd24gPSBudWxsO1xyXG4gICAgXHJcbiAgICBjb25zdCBiYXNlUHJpY2UgPSB0aWNrZXRUeXBlLnByaWNlO1xyXG4gICAgY29uc3QgYmFzZVRvdGFsQW1vdW50ID0gYmFzZVByaWNlICogcXVhbnRpdHk7XHJcblxyXG4gICAgaWYgKHByb21vQ29kZSAmJiBwcm9tb0NvZGUudHJpbSgpKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBbRElTQ09VTlRdIFZhbGlkYW5kbyBjw7NkaWdvIGRlIGRlc2N1ZW50bzogJHtwcm9tb0NvZGV9YCk7XHJcbiAgICAgIFxyXG4gICAgICBkaXNjb3VudENvZGVWYWxpZGF0aW9uID0gYXdhaXQgRGlzY291bnRDb2RlU2VydmljZS52YWxpZGF0ZURpc2NvdW50Q29kZShcclxuICAgICAgICBwcm9tb0NvZGUudHJpbSgpLFxyXG4gICAgICAgIHVzZXIuaWQsXHJcbiAgICAgICAgdGlja2V0VHlwZUlkLFxyXG4gICAgICAgIHF1YW50aXR5XHJcbiAgICAgICk7XHJcblxyXG4gICAgICBpZiAoIWRpc2NvdW50Q29kZVZhbGlkYXRpb24uaXNWYWxpZCkge1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgIHsgZXJyb3I6IGRpc2NvdW50Q29kZVZhbGlkYXRpb24uZXJyb3IgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGBbRElTQ09VTlRdIOKchSBDw7NkaWdvIHbDoWxpZG8gKCR7ZGlzY291bnRDb2RlVmFsaWRhdGlvbi50eXBlfSkuIERlc2N1ZW50bzogJHtkaXNjb3VudENvZGVWYWxpZGF0aW9uLmRpc2NvdW50QW1vdW50fWApO1xyXG4gICAgICBcclxuICAgICAgXHJcbiAgICAgIGZpbmFsUHJpY2VCcmVha2Rvd24gPSBjYWxjdWxhdGVQcmljZUJyZWFrZG93bldpdGhEaXNjb3VudChcclxuICAgICAgICBiYXNlVG90YWxBbW91bnQsXHJcbiAgICAgICAgZGlzY291bnRDb2RlVmFsaWRhdGlvbi5kaXNjb3VudEFtb3VudCB8fCAwLFxyXG4gICAgICAgIGV2ZW50LmN1cnJlbmN5XHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICBmaW5hbFByaWNlQnJlYWtkb3duLnByb21vQ29kZSA9IGRpc2NvdW50Q29kZVZhbGlkYXRpb24uY29kZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZpbmFsUHJpY2VCcmVha2Rvd24gPSBjYWxjdWxhdGVQcmljZUJyZWFrZG93bihiYXNlVG90YWxBbW91bnQsIGV2ZW50LmN1cnJlbmN5KTtcclxuICAgICAgZmluYWxQcmljZUJyZWFrZG93bi5vcmlnaW5hbEFtb3VudCA9IGJhc2VUb3RhbEFtb3VudDtcclxuICAgICAgZmluYWxQcmljZUJyZWFrZG93bi5kaXNjb3VudEFtb3VudCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmluYWxUb3RhbEFtb3VudCA9IGZpbmFsUHJpY2VCcmVha2Rvd24udG90YWxQcmljZTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhgW1BBWU1FTlRdIFJlc3VtZW4gZGUgcHJlY2lvczpgLCB7XHJcbiAgICAgIGJhc2VBbW91bnQ6IGJhc2VUb3RhbEFtb3VudCxcclxuICAgICAgZGlzY291bnRBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uZGlzY291bnRBbW91bnQsXHJcbiAgICAgIGFmdGVyRGlzY291bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uYmFzZVByaWNlLFxyXG4gICAgICBjb21taXNzaW9uOiBmaW5hbFByaWNlQnJlYWtkb3duLmNvbW1pc3Npb24sXHJcbiAgICAgIGZpbmFsVG90YWw6IGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgIGhhc1Byb21vQ29kZTogISFwcm9tb0NvZGUsXHJcbiAgICAgIG9yaWdpbmFsQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLm9yaWdpbmFsQW1vdW50XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhgW1dFQlBBWV0gTW9udG8gcXVlIHNlcsOhIGVudmlhZG8gYSBXZWJQYXk6ICQke2ZpbmFsVG90YWxBbW91bnR9ICR7ZXZlbnQuY3VycmVuY3l9YCk7XHJcblxyXG4gICAgY29uc3Qgb3JkZXJOdW1iZXIgPSBnZW5lcmF0ZVNob3J0QnV5T3JkZXIoXCJTUFwiKTtcclxuICAgIGNvbnN0IG9yZGVyID0gYXdhaXQgcHJpc21hLm9yZGVyLmNyZWF0ZSh7XHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBvcmRlck51bWJlcixcclxuICAgICAgICB0b3RhbEFtb3VudDogZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgICBiYXNlQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmJhc2VQcmljZSxcclxuICAgICAgICBjb21taXNzaW9uQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmNvbW1pc3Npb24sXHJcbiAgICAgICAgb3JpZ2luYWxBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24ub3JpZ2luYWxBbW91bnQsIFxyXG4gICAgICAgIGRpc2NvdW50QW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmRpc2NvdW50QW1vdW50LCBcclxuICAgICAgICBjdXJyZW5jeTogZXZlbnQuY3VycmVuY3ksXHJcbiAgICAgICAgcXVhbnRpdHksXHJcbiAgICAgICAgc3RhdHVzOiBcIlBFTkRJTkdcIixcclxuICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXHJcbiAgICAgICAgZXZlbnRJZDogZXZlbnQuaWQsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhcIk9yZGVuIGNyZWFkYTpcIiwgeyBcclxuICAgICAgb3JkZXJJZDogb3JkZXIuaWQsIFxyXG4gICAgICB0b3RhbDogZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgZGlzY291bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uZGlzY291bnRBbW91bnQsXHJcbiAgICAgIHByb21vQXBwbGllZDogISFwcm9tb0NvZGVcclxuICAgIH0pO1xyXG5cclxuICAgIFxyXG4gICAgY29uc3QgaXNGcmVlID0gZmluYWxUb3RhbEFtb3VudCA9PT0gMDtcclxuICAgIGlmIChpc0ZyZWUpIHtcclxuICAgICAgY29uc29sZS5sb2coXCJFbnRyYWRhIGdyYXR1aXRhIG8gY29uIGRlc2N1ZW50byBkZWwgMTAwJSwgcHJvY2VzYW5kbyBkaXJlY3RhbWVudGUuLi5cIik7XHJcbiAgICAgIFxyXG4gICAgICBcclxuICAgICAgaWYgKGRpc2NvdW50Q29kZVZhbGlkYXRpb24gJiYgZGlzY291bnRDb2RlVmFsaWRhdGlvbi5pc1ZhbGlkKSB7XHJcbiAgICAgICAgYXdhaXQgRGlzY291bnRDb2RlU2VydmljZS5hcHBseUNvZGVVc2FnZShcclxuICAgICAgICAgIGRpc2NvdW50Q29kZVZhbGlkYXRpb24sXHJcbiAgICAgICAgICB1c2VyLmlkLFxyXG4gICAgICAgICAgb3JkZXIuaWQsXHJcbiAgICAgICAgICBmaW5hbFByaWNlQnJlYWtkb3duLm9yaWdpbmFsQW1vdW50IHx8IDAsXHJcbiAgICAgICAgICBmaW5hbFRvdGFsQW1vdW50XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZUFuZEdlbmVyYXRlVGlja2V0cyhvcmRlciwgZXZlbnQsIHVzZXIsIHRpY2tldFR5cGUpO1xyXG4gICAgfVxyXG5cclxuICAgIFxyXG4gICAgY29uc3Qgc2Vzc2lvbklkID0gZ2VuZXJhdGVTaG9ydFNlc3Npb25JZChcInNlc3NcIik7XHJcbiAgICBjb25zdCByZXR1cm5VcmwgPSBgJHtwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19BUFBfVVJMfS9hcGkvdHJhbnNiYW5rL3JldHVybmA7XHJcblxyXG4gICAgY29uc3QgdHJhbnNiYW5rUmVzcG9uc2UgPSBhd2FpdCB3ZWJwYXlQbHVzLmNyZWF0ZShcclxuICAgICAgb3JkZXIub3JkZXJOdW1iZXIsXHJcbiAgICAgIHNlc3Npb25JZCxcclxuICAgICAgZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgcmV0dXJuVXJsXHJcbiAgICApO1xyXG5cclxuICAgIGF3YWl0IHByaXNtYS5wYXltZW50LmNyZWF0ZSh7XHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBvcmRlcklkOiBvcmRlci5pZCxcclxuICAgICAgICB0cmFuc2FjdGlvbklkOiBzZXNzaW9uSWQsXHJcbiAgICAgICAgdG9rZW46IHRyYW5zYmFua1Jlc3BvbnNlLnRva2VuLFxyXG4gICAgICAgIGFtb3VudDogZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgICBjdXJyZW5jeTogZXZlbnQuY3VycmVuY3ksXHJcbiAgICAgICAgc3RhdHVzOiBcIlBFTkRJTkdcIixcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIFxyXG4gICAgaWYgKGRpc2NvdW50Q29kZVZhbGlkYXRpb24gJiYgZGlzY291bnRDb2RlVmFsaWRhdGlvbi5pc1ZhbGlkKSB7XHJcbiAgICAgIFxyXG4gICAgICBcclxuICAgICAgY29uc29sZS5sb2coYFtESVNDT1VOVF0gQ8OzZGlnbyAke3Byb21vQ29kZX0gKCR7ZGlzY291bnRDb2RlVmFsaWRhdGlvbi50eXBlfSkgcXVlZGFyw6EgcGVuZGllbnRlIHBhcmEgYXBsaWNhciB0cmFzIHBhZ28gZXhpdG9zb2ApO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIG9yZGVySWQ6IG9yZGVyLmlkLFxyXG4gICAgICBwYXltZW50VXJsOiB0cmFuc2JhbmtSZXNwb25zZS51cmwsXHJcbiAgICAgIHRva2VuOiB0cmFuc2JhbmtSZXNwb25zZS50b2tlbixcclxuICAgICAgcHJpY2VCcmVha2Rvd246IHtcclxuICAgICAgICBvcmlnaW5hbEFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5vcmlnaW5hbEFtb3VudCxcclxuICAgICAgICBkaXNjb3VudEFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5kaXNjb3VudEFtb3VudCxcclxuICAgICAgICBiYXNlQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmJhc2VQcmljZSxcclxuICAgICAgICBjb21taXNzaW9uOiBmaW5hbFByaWNlQnJlYWtkb3duLmNvbW1pc3Npb24sXHJcbiAgICAgICAgdG90YWxBbW91bnQ6IGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgICAgcHJvbW9Db2RlOiBwcm9tb0NvZGUgfHwgbnVsbFxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCI9PT0gRVJST1IgR0VORVJBTCBFTiBDUkVBQ0nDk04gREUgUEFHTyA9PT1cIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICB7XHJcbiAgICAgICAgZXJyb3I6IFwiRXJyb3IgaW50ZXJubyBkZWwgc2Vydmlkb3JcIixcclxuICAgICAgICBkZXRhaWxzOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFwiRXJyb3IgZGVzY29ub2NpZG9cIixcclxuICAgICAgfSxcclxuICAgICAgeyBzdGF0dXM6IDUwMCB9XHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlQW5kR2VuZXJhdGVUaWNrZXRzKG9yZGVyOiBPcmRlciwgZXZlbnQ6IEV2ZW50LCB1c2VyOiBVc2VyLCB0aWNrZXRUeXBlOiBUaWNrZXRUeXBlKSB7XHJcbiAgY29uc29sZS5sb2coYEdlbmVyYW5kbyB0aWNrZXRzIHBhcmEgbGEgb3JkZW4gJHtvcmRlci5vcmRlck51bWJlcn1gKTtcclxuXHJcbiAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICBjb25zdCB0aWNrZXRzRGF0YSA9IFtdO1xyXG4gIFxyXG4gIGNvbnN0IHRvdGFsVGlja2V0c1RvR2VuZXJhdGUgPSBvcmRlci5xdWFudGl0eSAqIHRpY2tldFR5cGUudGlja2V0c0dlbmVyYXRlZDtcclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3RhbFRpY2tldHNUb0dlbmVyYXRlOyBpKyspIHtcclxuICAgIGNvbnN0IHFyQ29kZSA9IGdlbmVyYXRlVW5pcXVlUVJDb2RlKGV2ZW50LmlkLCB1c2VyLmlkLCB0aW1lc3RhbXAsIGkpO1xyXG4gICAgdGlja2V0c0RhdGEucHVzaCh7XHJcbiAgICAgIHFyQ29kZSxcclxuICAgICAgZXZlbnRJZDogZXZlbnQuaWQsXHJcbiAgICAgIHVzZXJJZDogdXNlci5pZCxcclxuICAgICAgb3JkZXJJZDogb3JkZXIuaWQsXHJcbiAgICAgIHRpY2tldFR5cGVJZDogdGlja2V0VHlwZS5pZCxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdHJhbnNhY3Rpb25SZXN1bHQgPSBhd2FpdCBwcmlzbWEuJHRyYW5zYWN0aW9uKFtcclxuICAgIHByaXNtYS50aWNrZXQuY3JlYXRlTWFueSh7IGRhdGE6IHRpY2tldHNEYXRhIH0pLFxyXG4gICAgcHJpc21hLm9yZGVyLnVwZGF0ZSh7XHJcbiAgICAgIHdoZXJlOiB7IGlkOiBvcmRlci5pZCB9LFxyXG4gICAgICBkYXRhOiB7IHN0YXR1czogXCJQQUlEXCIgfSxcclxuICAgICAgaW5jbHVkZTogeyB0aWNrZXRzOiB0cnVlIH1cclxuICAgIH0pLFxyXG4gIF0pO1xyXG5cclxuICBjb25zdCB1cGRhdGVkT3JkZXIgPSB0cmFuc2FjdGlvblJlc3VsdFsxXTtcclxuICBjb25zb2xlLmxvZyhgJHt0aWNrZXRzRGF0YS5sZW5ndGh9IHRpY2tldHMgZ2VuZXJhZG9zLmApO1xyXG5cclxuICBjb25zdCBldmVudFdpdGhPcmdhbml6ZXIgPSBhd2FpdCBwcmlzbWEuZXZlbnQuZmluZFVuaXF1ZSh7XHJcbiAgICB3aGVyZTogeyBpZDogZXZlbnQuaWQgfSxcclxuICAgIGluY2x1ZGU6IHsgb3JnYW5pemVyOiB0cnVlIH1cclxuICB9KTtcclxuXHJcbiAgaWYgKGV2ZW50V2l0aE9yZ2FuaXplciAmJiB1c2VyLmZpcnN0TmFtZSkge1xyXG4gICAgYXdhaXQgc2VuZFRpY2tldEVtYWlsKHtcclxuICAgICAgdXNlckVtYWlsOiB1c2VyLmVtYWlsLFxyXG4gICAgICB1c2VyTmFtZTogdXNlci5maXJzdE5hbWUsXHJcbiAgICAgIGV2ZW50VGl0bGU6IGV2ZW50V2l0aE9yZ2FuaXplci50aXRsZSxcclxuICAgICAgZXZlbnREYXRlOiBldmVudFdpdGhPcmdhbml6ZXIuc3RhcnREYXRlLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgIGV2ZW50TG9jYXRpb246IGV2ZW50V2l0aE9yZ2FuaXplci5sb2NhdGlvbixcclxuICAgICAgb3JkZXJOdW1iZXI6IHVwZGF0ZWRPcmRlci5pZCxcclxuICAgICAgdGlja2V0czogdXBkYXRlZE9yZGVyLnRpY2tldHMubWFwKHRpY2tldCA9PiAoe1xyXG4gICAgICAgIHFyQ29kZTogdGlja2V0LnFyQ29kZSEsXHJcbiAgICAgICAgcXJDb2RlSW1hZ2U6IGBkYXRhOmltYWdlL3BuZztiYXNlNjQsJHt0aWNrZXQucXJDb2RlfWAgXHJcbiAgICAgIH0pKVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgc3VjY2VzczogdHJ1ZSxcclxuICAgIG9yZGVySWQ6IG9yZGVyLmlkLFxyXG4gICAgaXNGcmVlOiB0cnVlLFxyXG4gICAgdGlja2V0c0dlbmVyYXRlZDogdG90YWxUaWNrZXRzVG9HZW5lcmF0ZSxcclxuICB9KTtcclxufSJdLCJ2ZXJzaW9uIjozfQ==