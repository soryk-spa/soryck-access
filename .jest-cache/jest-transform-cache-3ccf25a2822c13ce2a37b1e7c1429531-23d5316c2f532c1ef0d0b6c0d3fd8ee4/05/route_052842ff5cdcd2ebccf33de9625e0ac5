3d9517c34cfa36a17e1b77128fde8cda
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.POST = POST;
const server_1 = require("next/server");
const auth_1 = require("@/lib/auth");
const prisma_1 = require("@/lib/prisma");
const transbank_1 = require("@/lib/transbank");
const qr_1 = require("@/lib/qr");
const commission_1 = require("@/lib/commission");
const discount_codes_1 = require("@/lib/discount-codes");
const email_1 = require("@/lib/email");
const zod_1 = require("zod");
const createPaymentSchema = zod_1.z.object({
    ticketTypeId: zod_1.z.string().min(1, "Se requiere el tipo de ticket"),
    quantity: zod_1.z.number().min(1, "La cantidad debe ser al menos 1").max(10, "No puedes comprar más de 10 tickets a la vez."),
    promoCode: zod_1.z.string().optional(), // Ahora incluye códigos de cortesía también
});
function generateShortBuyOrder(prefix = "SP") {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const hour = String(now.getHours()).padStart(2, "0");
    const minute = String(now.getMinutes()).padStart(2, "0");
    const second = String(now.getSeconds()).padStart(2, "0");
    const ms = String(now.getMilliseconds()).padStart(3, "0").slice(0, 2);
    const random = Math.random().toString(36).substr(2, 2).toUpperCase();
    const buyOrder = `${prefix}${year}${month}${day}${hour}${minute}${second}${ms}${random}`;
    return buyOrder.substring(0, 26);
}
function generateShortSessionId(prefix = "sess") {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 4);
    const sessionId = `${prefix}-${timestamp}-${random}`;
    return sessionId.substring(0, 61);
}
async function POST(request) {
    try {
        console.log("=== INICIO DE CREACIÓN DE PAGO CON PROMO CODES ===");
        const user = await (0, auth_1.requireAuth)();
        const body = await request.json();
        const validation = createPaymentSchema.safeParse(body);
        if (!validation.success) {
            return server_1.NextResponse.json({ error: "Datos inválidos", details: validation.error.issues }, { status: 400 });
        }
        const { ticketTypeId, quantity, promoCode } = validation.data;
        const ticketType = await prisma_1.prisma.ticketType.findUnique({
            where: { id: ticketTypeId },
            include: {
                event: true
            },
        });
        if (!ticketType || !ticketType.event.isPublished) {
            return server_1.NextResponse.json({ error: "Tipo de entrada no encontrado o el evento no está publicado" }, { status: 404 });
        }
        const event = ticketType.event;
        const ticketsSoldForType = await prisma_1.prisma.ticket.count({
            where: { ticketTypeId: ticketTypeId },
        });
        const ticketsGeneratedPerPurchase = ticketType.ticketsGenerated;
        const capacityInTickets = ticketType.capacity * ticketsGeneratedPerPurchase;
        const availableTickets = capacityInTickets - ticketsSoldForType;
        if ((quantity * ticketsGeneratedPerPurchase) > availableTickets) {
            return server_1.NextResponse.json({ error: `No hay suficientes tickets disponibles. Solo quedan ${Math.floor(availableTickets / ticketsGeneratedPerPurchase)}.` }, { status: 400 });
        }
        let discountCodeValidation = null;
        let finalPriceBreakdown = null;
        const basePrice = ticketType.price;
        const baseTotalAmount = basePrice * quantity;
        if (promoCode && promoCode.trim()) {
            console.log(`[DISCOUNT] Validando código de descuento: ${promoCode}`);
            discountCodeValidation = await discount_codes_1.DiscountCodeService.validateDiscountCode(promoCode.trim(), user.id, ticketTypeId, quantity);
            if (!discountCodeValidation.isValid) {
                return server_1.NextResponse.json({ error: discountCodeValidation.error }, { status: 400 });
            }
            console.log(`[DISCOUNT] ✅ Código válido (${discountCodeValidation.type}). Descuento: ${discountCodeValidation.discountAmount}`);
            // Usar la función correcta para calcular el breakdown con descuento
            finalPriceBreakdown = (0, commission_1.calculatePriceBreakdownWithDiscount)(baseTotalAmount, discountCodeValidation.discountAmount || 0, event.currency);
            finalPriceBreakdown.promoCode = discountCodeValidation.code;
        }
        else {
            finalPriceBreakdown = (0, commission_1.calculatePriceBreakdown)(baseTotalAmount, event.currency);
            finalPriceBreakdown.originalAmount = baseTotalAmount;
            finalPriceBreakdown.discountAmount = 0;
        }
        const finalTotalAmount = finalPriceBreakdown.totalPrice;
        console.log(`[PAYMENT] Resumen de precios:`, {
            baseAmount: baseTotalAmount,
            discountAmount: finalPriceBreakdown.discountAmount,
            afterDiscount: finalPriceBreakdown.basePrice,
            commission: finalPriceBreakdown.commission,
            finalTotal: finalTotalAmount,
            hasPromoCode: !!promoCode,
            originalAmount: finalPriceBreakdown.originalAmount
        });
        console.log(`[WEBPAY] Monto que será enviado a WebPay: $${finalTotalAmount} ${event.currency}`);
        const orderNumber = generateShortBuyOrder("SP");
        const order = await prisma_1.prisma.order.create({
            data: {
                orderNumber,
                totalAmount: finalTotalAmount,
                baseAmount: finalPriceBreakdown.basePrice,
                commissionAmount: finalPriceBreakdown.commission,
                originalAmount: finalPriceBreakdown.originalAmount, // ✅ NUEVO: Monto original
                discountAmount: finalPriceBreakdown.discountAmount, // ✅ NUEVO: Descuento aplicado
                currency: event.currency,
                quantity,
                status: "PENDING",
                userId: user.id,
                eventId: event.id,
            },
        });
        console.log("Orden creada:", {
            orderId: order.id,
            total: finalTotalAmount,
            discount: finalPriceBreakdown.discountAmount,
            promoApplied: !!promoCode
        });
        // Manejar entrada gratuita (incluyendo 100% de descuento)
        const isFree = finalTotalAmount === 0;
        if (isFree) {
            console.log("Entrada gratuita o con descuento del 100%, procesando directamente...");
            // Si hay código de descuento, registrar su uso
            if (discountCodeValidation && discountCodeValidation.isValid) {
                await discount_codes_1.DiscountCodeService.applyCodeUsage(discountCodeValidation, user.id, order.id, finalPriceBreakdown.originalAmount || 0, finalTotalAmount);
            }
            return await handleAndGenerateTickets(order, event, user, ticketType);
        }
        // Para pagos con monto > 0, proceder con Transbank
        const sessionId = generateShortSessionId("sess");
        const returnUrl = `${process.env.NEXT_PUBLIC_APP_URL}/api/transbank/return`;
        const transbankResponse = await transbank_1.webpayPlus.create(order.orderNumber, sessionId, finalTotalAmount, returnUrl);
        await prisma_1.prisma.payment.create({
            data: {
                orderId: order.id,
                transactionId: sessionId,
                token: transbankResponse.token,
                amount: finalTotalAmount,
                currency: event.currency,
                status: "PENDING",
            },
        });
        // Si hay código de descuento, guardarlo temporalmente en la orden para aplicarlo después del pago
        if (discountCodeValidation && discountCodeValidation.isValid) {
            // Podríamos usar un campo temporal o metadata, pero por simplicidad 
            // lo manejaremos en el return de Transbank
            console.log(`[DISCOUNT] Código ${promoCode} (${discountCodeValidation.type}) quedará pendiente para aplicar tras pago exitoso`);
        }
        return server_1.NextResponse.json({
            success: true,
            orderId: order.id,
            paymentUrl: transbankResponse.url,
            token: transbankResponse.token,
            priceBreakdown: {
                originalAmount: finalPriceBreakdown.originalAmount,
                discountAmount: finalPriceBreakdown.discountAmount,
                baseAmount: finalPriceBreakdown.basePrice,
                commission: finalPriceBreakdown.commission,
                totalAmount: finalTotalAmount,
                promoCode: promoCode || null
            }
        });
    }
    catch (error) {
        console.error("=== ERROR GENERAL EN CREACIÓN DE PAGO ===", error);
        return server_1.NextResponse.json({
            error: "Error interno del servidor",
            details: error instanceof Error ? error.message : "Error desconocido",
        }, { status: 500 });
    }
}
async function handleAndGenerateTickets(order, event, user, ticketType) {
    console.log(`Generando tickets para la orden ${order.orderNumber}`);
    const timestamp = Date.now();
    const ticketsData = [];
    const totalTicketsToGenerate = order.quantity * ticketType.ticketsGenerated;
    for (let i = 0; i < totalTicketsToGenerate; i++) {
        const qrCode = (0, qr_1.generateUniqueQRCode)(event.id, user.id, timestamp, i);
        ticketsData.push({
            qrCode,
            eventId: event.id,
            userId: user.id,
            orderId: order.id,
            ticketTypeId: ticketType.id,
        });
    }
    const transactionResult = await prisma_1.prisma.$transaction([
        prisma_1.prisma.ticket.createMany({ data: ticketsData }),
        prisma_1.prisma.order.update({
            where: { id: order.id },
            data: { status: "PAID" },
            include: { tickets: true }
        }),
    ]);
    const updatedOrder = transactionResult[1];
    console.log(`${ticketsData.length} tickets generados.`);
    const eventWithOrganizer = await prisma_1.prisma.event.findUnique({
        where: { id: event.id },
        include: { organizer: true }
    });
    if (eventWithOrganizer && user.firstName) {
        await (0, email_1.sendTicketEmail)({
            userEmail: user.email,
            userName: user.firstName,
            eventTitle: eventWithOrganizer.title,
            eventDate: eventWithOrganizer.startDate.toISOString(),
            eventLocation: eventWithOrganizer.location,
            orderNumber: updatedOrder.id,
            tickets: updatedOrder.tickets.map(ticket => ({
                qrCode: ticket.qrCode,
                qrCodeImage: `data:image/png;base64,${ticket.qrCode}` // Placeholder for actual QR image
            }))
        });
    }
    return server_1.NextResponse.json({
        success: true,
        orderId: order.id,
        isFree: true,
        ticketsGenerated: totalTicketsToGenerate,
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxccGF5bWVudHNcXGNyZWF0ZVxccm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7QUFzQ0Esb0JBc01DO0FBNU9ELHdDQUF3RDtBQUN4RCxxQ0FBeUM7QUFDekMseUNBQXNDO0FBQ3RDLCtDQUE2QztBQUM3QyxpQ0FBZ0Q7QUFDaEQsaURBQWdHO0FBQ2hHLHlEQUEyRDtBQUMzRCx1Q0FBOEM7QUFDOUMsNkJBQXdCO0FBR3hCLE1BQU0sbUJBQW1CLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxZQUFZLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsK0JBQStCLENBQUM7SUFDaEUsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGlDQUFpQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSwrQ0FBK0MsQ0FBQztJQUN2SCxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLDRDQUE0QztDQUMvRSxDQUFDLENBQUM7QUFFSCxTQUFTLHFCQUFxQixDQUFDLFNBQWlCLElBQUk7SUFDbEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN2QixNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25ELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JFLE1BQU0sUUFBUSxHQUFHLEdBQUcsTUFBTSxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksR0FBRyxNQUFNLEdBQUcsTUFBTSxHQUFHLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztJQUN6RixPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ25DLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLFNBQWlCLE1BQU07SUFDckQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxF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QUFDLE1BQU0scUJBQXFCLENBQUMsQ0FBQztJQUV4RCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sZUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7UUFDdkQsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7UUFDdkIsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRTtLQUM3QixDQUFDLENBQUM7SUFFSCxJQUFJLGtCQUFrQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUN6QyxNQUFNLElBQUEsdUJBQWUsRUFBQztZQUNwQixTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDckIsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3hCLFVBQVUsRUFBRSxrQkFBa0IsQ0FBQyxLQUFLO1lBQ3BDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFO1lBQ3JELGFBQWEsRUFBRSxrQkFBa0IsQ0FBQyxRQUFRO1lBQzFDLFdBQVcsRUFBRSxZQUFZLENBQUMsRUFBRTtZQUM1QixPQUFPLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUMzQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU87Z0JBQ3RCLFdBQVcsRUFBRSx5QkFBeUIsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLGtDQUFrQzthQUN6RixDQUFDLENBQUM7U0FDSixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FBQztRQUN2QixPQUFPLEVBQUUsSUFBSTtRQUNiLE9BQU8sRUFBRSxLQUFLLENBQUMsRUFBRTtRQUNqQixNQUFNLEVBQUUsSUFBSTtRQUNaLGdCQUFnQixFQUFFLHNCQUFzQjtLQUN6QyxDQUFDLENBQUM7QUFDTCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQmlsdXJcXERvY3VtZW50c1xcRGV2ZWxvcG1lbnRcXE5leHRcXHNvcnljay1hY2Nlc3NcXHNyY1xcYXBwXFxhcGlcXHBheW1lbnRzXFxjcmVhdGVcXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIjtcclxuaW1wb3J0IHsgcmVxdWlyZUF1dGggfSBmcm9tIFwiQC9saWIvYXV0aFwiO1xyXG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tIFwiQC9saWIvcHJpc21hXCI7XHJcbmltcG9ydCB7IHdlYnBheVBsdXMgfSBmcm9tIFwiQC9saWIvdHJhbnNiYW5rXCI7XHJcbmltcG9ydCB7IGdlbmVyYXRlVW5pcXVlUVJDb2RlIH0gZnJvbSBcIkAvbGliL3FyXCI7XHJcbmltcG9ydCB7IGNhbGN1bGF0ZVByaWNlQnJlYWtkb3duLCBjYWxjdWxhdGVQcmljZUJyZWFrZG93bldpdGhEaXNjb3VudCB9IGZyb20gXCJAL2xpYi9jb21taXNzaW9uXCI7XHJcbmltcG9ydCB7IERpc2NvdW50Q29kZVNlcnZpY2UgfSBmcm9tIFwiQC9saWIvZGlzY291bnQtY29kZXNcIjtcclxuaW1wb3J0IHsgc2VuZFRpY2tldEVtYWlsIH0gZnJvbSAnQC9saWIvZW1haWwnO1xyXG5pbXBvcnQgeyB6IH0gZnJvbSBcInpvZFwiO1xyXG5pbXBvcnQgeyBPcmRlciwgRXZlbnQsIFVzZXIsIFRpY2tldFR5cGUgfSBmcm9tIFwiQHByaXNtYS9jbGllbnRcIjtcclxuXHJcbmNvbnN0IGNyZWF0ZVBheW1lbnRTY2hlbWEgPSB6Lm9iamVjdCh7XHJcbiAgdGlja2V0VHlwZUlkOiB6LnN0cmluZygpLm1pbigxLCBcIlNlIHJlcXVpZXJlIGVsIHRpcG8gZGUgdGlja2V0XCIpLFxyXG4gIHF1YW50aXR5OiB6Lm51bWJlcigpLm1pbigxLCBcIkxhIGNhbnRpZGFkIGRlYmUgc2VyIGFsIG1lbm9zIDFcIikubWF4KDEwLCBcIk5vIHB1ZWRlcyBjb21wcmFyIG3DoXMgZGUgMTAgdGlja2V0cyBhIGxhIHZlei5cIiksXHJcbiAgcHJvbW9Db2RlOiB6LnN0cmluZygpLm9wdGlvbmFsKCksIC8vIEFob3JhIGluY2x1eWUgY8OzZGlnb3MgZGUgY29ydGVzw61hIHRhbWJpw6luXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZ2VuZXJhdGVTaG9ydEJ1eU9yZGVyKHByZWZpeDogc3RyaW5nID0gXCJTUFwiKTogc3RyaW5nIHtcclxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gIGNvbnN0IHllYXIgPSBub3cuZ2V0RnVsbFllYXIoKS50b1N0cmluZygpLnNsaWNlKC0yKTtcclxuICBjb25zdCBtb250aCA9IFN0cmluZyhub3cuZ2V0TW9udGgoKSArIDEpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcclxuICBjb25zdCBkYXkgPSBTdHJpbmcobm93LmdldERhdGUoKSkucGFkU3RhcnQoMiwgXCIwXCIpO1xyXG4gIGNvbnN0IGhvdXIgPSBTdHJpbmcobm93LmdldEhvdXJzKCkpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcclxuICBjb25zdCBtaW51dGUgPSBTdHJpbmcobm93LmdldE1pbnV0ZXMoKSkucGFkU3RhcnQoMiwgXCIwXCIpO1xyXG4gIGNvbnN0IHNlY29uZCA9IFN0cmluZyhub3cuZ2V0U2Vjb25kcygpKS5wYWRTdGFydCgyLCBcIjBcIik7XHJcbiAgY29uc3QgbXMgPSBTdHJpbmcobm93LmdldE1pbGxpc2Vjb25kcygpKS5wYWRTdGFydCgzLCBcIjBcIikuc2xpY2UoMCwgMik7XHJcbiAgY29uc3QgcmFuZG9tID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDIpLnRvVXBwZXJDYXNlKCk7XHJcbiAgY29uc3QgYnV5T3JkZXIgPSBgJHtwcmVmaXh9JHt5ZWFyfSR7bW9udGh9JHtkYXl9JHtob3VyfSR7bWludXRlfSR7c2Vjb25kfSR7bXN9JHtyYW5kb219YDtcclxuICByZXR1cm4gYnV5T3JkZXIuc3Vic3RyaW5nKDAsIDI2KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2VuZXJhdGVTaG9ydFNlc3Npb25JZChwcmVmaXg6IHN0cmluZyA9IFwic2Vzc1wiKTogc3RyaW5nIHtcclxuICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpLnRvU3RyaW5nKDM2KTtcclxuICBjb25zdCByYW5kb20gPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgNCk7XHJcbiAgY29uc3Qgc2Vzc2lvbklkID0gYCR7cHJlZml4fS0ke3RpbWVzdGFtcH0tJHtyYW5kb219YDtcclxuICByZXR1cm4gc2Vzc2lvbklkLnN1YnN0cmluZygwLCA2MSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnNvbGUubG9nKFwiPT09IElOSUNJTyBERSBDUkVBQ0nDk04gREUgUEFHTyBDT04gUFJPTU8gQ09ERVMgPT09XCIpO1xyXG5cclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCByZXF1aXJlQXV0aCgpO1xyXG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpO1xyXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IGNyZWF0ZVBheW1lbnRTY2hlbWEuc2FmZVBhcnNlKGJvZHkpO1xyXG5cclxuICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBcIkRhdG9zIGludsOhbGlkb3NcIiwgZGV0YWlsczogdmFsaWRhdGlvbi5lcnJvci5pc3N1ZXMgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB7IHRpY2tldFR5cGVJZCwgcXVhbnRpdHksIHByb21vQ29kZSB9ID0gdmFsaWRhdGlvbi5kYXRhO1xyXG5cclxuICAgIGNvbnN0IHRpY2tldFR5cGUgPSBhd2FpdCBwcmlzbWEudGlja2V0VHlwZS5maW5kVW5pcXVlKHtcclxuICAgICAgd2hlcmU6IHsgaWQ6IHRpY2tldFR5cGVJZCB9LFxyXG4gICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgZXZlbnQ6IHRydWVcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghdGlja2V0VHlwZSB8fCAhdGlja2V0VHlwZS5ldmVudC5pc1B1Ymxpc2hlZCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJUaXBvIGRlIGVudHJhZGEgbm8gZW5jb250cmFkbyBvIGVsIGV2ZW50byBubyBlc3TDoSBwdWJsaWNhZG9cIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDQgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGV2ZW50ID0gdGlja2V0VHlwZS5ldmVudDtcclxuXHJcbiAgICBjb25zdCB0aWNrZXRzU29sZEZvclR5cGUgPSBhd2FpdCBwcmlzbWEudGlja2V0LmNvdW50KHtcclxuICAgICAgd2hlcmU6IHsgdGlja2V0VHlwZUlkOiB0aWNrZXRUeXBlSWQgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHRpY2tldHNHZW5lcmF0ZWRQZXJQdXJjaGFzZSA9IHRpY2tldFR5cGUudGlja2V0c0dlbmVyYXRlZDtcclxuICAgIGNvbnN0IGNhcGFjaXR5SW5UaWNrZXRzID0gdGlja2V0VHlwZS5jYXBhY2l0eSAqIHRpY2tldHNHZW5lcmF0ZWRQZXJQdXJjaGFzZTtcclxuICAgIGNvbnN0IGF2YWlsYWJsZVRpY2tldHMgPSBjYXBhY2l0eUluVGlja2V0cyAtIHRpY2tldHNTb2xkRm9yVHlwZTtcclxuXHJcbiAgICBpZiAoKHF1YW50aXR5ICogdGlja2V0c0dlbmVyYXRlZFBlclB1cmNoYXNlKSA+IGF2YWlsYWJsZVRpY2tldHMpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgIHsgZXJyb3I6IGBObyBoYXkgc3VmaWNpZW50ZXMgdGlja2V0cyBkaXNwb25pYmxlcy4gU29sbyBxdWVkYW4gJHtNYXRoLmZsb29yKGF2YWlsYWJsZVRpY2tldHMgLyB0aWNrZXRzR2VuZXJhdGVkUGVyUHVyY2hhc2UpfS5gIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGRpc2NvdW50Q29kZVZhbGlkYXRpb24gPSBudWxsO1xyXG4gICAgbGV0IGZpbmFsUHJpY2VCcmVha2Rvd24gPSBudWxsO1xyXG4gICAgXHJcbiAgICBjb25zdCBiYXNlUHJpY2UgPSB0aWNrZXRUeXBlLnByaWNlO1xyXG4gICAgY29uc3QgYmFzZVRvdGFsQW1vdW50ID0gYmFzZVByaWNlICogcXVhbnRpdHk7XHJcblxyXG4gICAgaWYgKHByb21vQ29kZSAmJiBwcm9tb0NvZGUudHJpbSgpKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBbRElTQ09VTlRdIFZhbGlkYW5kbyBjw7NkaWdvIGRlIGRlc2N1ZW50bzogJHtwcm9tb0NvZGV9YCk7XHJcbiAgICAgIFxyXG4gICAgICBkaXNjb3VudENvZGVWYWxpZGF0aW9uID0gYXdhaXQgRGlzY291bnRDb2RlU2VydmljZS52YWxpZGF0ZURpc2NvdW50Q29kZShcclxuICAgICAgICBwcm9tb0NvZGUudHJpbSgpLFxyXG4gICAgICAgIHVzZXIuaWQsXHJcbiAgICAgICAgdGlja2V0VHlwZUlkLFxyXG4gICAgICAgIHF1YW50aXR5XHJcbiAgICAgICk7XHJcblxyXG4gICAgICBpZiAoIWRpc2NvdW50Q29kZVZhbGlkYXRpb24uaXNWYWxpZCkge1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgIHsgZXJyb3I6IGRpc2NvdW50Q29kZVZhbGlkYXRpb24uZXJyb3IgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGBbRElTQ09VTlRdIOKchSBDw7NkaWdvIHbDoWxpZG8gKCR7ZGlzY291bnRDb2RlVmFsaWRhdGlvbi50eXBlfSkuIERlc2N1ZW50bzogJHtkaXNjb3VudENvZGVWYWxpZGF0aW9uLmRpc2NvdW50QW1vdW50fWApO1xyXG4gICAgICBcclxuICAgICAgLy8gVXNhciBsYSBmdW5jacOzbiBjb3JyZWN0YSBwYXJhIGNhbGN1bGFyIGVsIGJyZWFrZG93biBjb24gZGVzY3VlbnRvXHJcbiAgICAgIGZpbmFsUHJpY2VCcmVha2Rvd24gPSBjYWxjdWxhdGVQcmljZUJyZWFrZG93bldpdGhEaXNjb3VudChcclxuICAgICAgICBiYXNlVG90YWxBbW91bnQsXHJcbiAgICAgICAgZGlzY291bnRDb2RlVmFsaWRhdGlvbi5kaXNjb3VudEFtb3VudCB8fCAwLFxyXG4gICAgICAgIGV2ZW50LmN1cnJlbmN5XHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICBmaW5hbFByaWNlQnJlYWtkb3duLnByb21vQ29kZSA9IGRpc2NvdW50Q29kZVZhbGlkYXRpb24uY29kZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZpbmFsUHJpY2VCcmVha2Rvd24gPSBjYWxjdWxhdGVQcmljZUJyZWFrZG93bihiYXNlVG90YWxBbW91bnQsIGV2ZW50LmN1cnJlbmN5KTtcclxuICAgICAgZmluYWxQcmljZUJyZWFrZG93bi5vcmlnaW5hbEFtb3VudCA9IGJhc2VUb3RhbEFtb3VudDtcclxuICAgICAgZmluYWxQcmljZUJyZWFrZG93bi5kaXNjb3VudEFtb3VudCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmluYWxUb3RhbEFtb3VudCA9IGZpbmFsUHJpY2VCcmVha2Rvd24udG90YWxQcmljZTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhgW1BBWU1FTlRdIFJlc3VtZW4gZGUgcHJlY2lvczpgLCB7XHJcbiAgICAgIGJhc2VBbW91bnQ6IGJhc2VUb3RhbEFtb3VudCxcclxuICAgICAgZGlzY291bnRBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uZGlzY291bnRBbW91bnQsXHJcbiAgICAgIGFmdGVyRGlzY291bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uYmFzZVByaWNlLFxyXG4gICAgICBjb21taXNzaW9uOiBmaW5hbFByaWNlQnJlYWtkb3duLmNvbW1pc3Npb24sXHJcbiAgICAgIGZpbmFsVG90YWw6IGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgIGhhc1Byb21vQ29kZTogISFwcm9tb0NvZGUsXHJcbiAgICAgIG9yaWdpbmFsQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLm9yaWdpbmFsQW1vdW50XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhgW1dFQlBBWV0gTW9udG8gcXVlIHNlcsOhIGVudmlhZG8gYSBXZWJQYXk6ICQke2ZpbmFsVG90YWxBbW91bnR9ICR7ZXZlbnQuY3VycmVuY3l9YCk7XHJcblxyXG4gICAgY29uc3Qgb3JkZXJOdW1iZXIgPSBnZW5lcmF0ZVNob3J0QnV5T3JkZXIoXCJTUFwiKTtcclxuICAgIGNvbnN0IG9yZGVyID0gYXdhaXQgcHJpc21hLm9yZGVyLmNyZWF0ZSh7XHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBvcmRlck51bWJlcixcclxuICAgICAgICB0b3RhbEFtb3VudDogZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgICBiYXNlQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmJhc2VQcmljZSxcclxuICAgICAgICBjb21taXNzaW9uQW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmNvbW1pc3Npb24sXHJcbiAgICAgICAgb3JpZ2luYWxBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24ub3JpZ2luYWxBbW91bnQsIC8vIOKchSBOVUVWTzogTW9udG8gb3JpZ2luYWxcclxuICAgICAgICBkaXNjb3VudEFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5kaXNjb3VudEFtb3VudCwgLy8g4pyFIE5VRVZPOiBEZXNjdWVudG8gYXBsaWNhZG9cclxuICAgICAgICBjdXJyZW5jeTogZXZlbnQuY3VycmVuY3ksXHJcbiAgICAgICAgcXVhbnRpdHksXHJcbiAgICAgICAgc3RhdHVzOiBcIlBFTkRJTkdcIixcclxuICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXHJcbiAgICAgICAgZXZlbnRJZDogZXZlbnQuaWQsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhcIk9yZGVuIGNyZWFkYTpcIiwgeyBcclxuICAgICAgb3JkZXJJZDogb3JkZXIuaWQsIFxyXG4gICAgICB0b3RhbDogZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgZGlzY291bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uZGlzY291bnRBbW91bnQsXHJcbiAgICAgIHByb21vQXBwbGllZDogISFwcm9tb0NvZGVcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIE1hbmVqYXIgZW50cmFkYSBncmF0dWl0YSAoaW5jbHV5ZW5kbyAxMDAlIGRlIGRlc2N1ZW50bylcclxuICAgIGNvbnN0IGlzRnJlZSA9IGZpbmFsVG90YWxBbW91bnQgPT09IDA7XHJcbiAgICBpZiAoaXNGcmVlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiRW50cmFkYSBncmF0dWl0YSBvIGNvbiBkZXNjdWVudG8gZGVsIDEwMCUsIHByb2Nlc2FuZG8gZGlyZWN0YW1lbnRlLi4uXCIpO1xyXG4gICAgICBcclxuICAgICAgLy8gU2kgaGF5IGPDs2RpZ28gZGUgZGVzY3VlbnRvLCByZWdpc3RyYXIgc3UgdXNvXHJcbiAgICAgIGlmIChkaXNjb3VudENvZGVWYWxpZGF0aW9uICYmIGRpc2NvdW50Q29kZVZhbGlkYXRpb24uaXNWYWxpZCkge1xyXG4gICAgICAgIGF3YWl0IERpc2NvdW50Q29kZVNlcnZpY2UuYXBwbHlDb2RlVXNhZ2UoXHJcbiAgICAgICAgICBkaXNjb3VudENvZGVWYWxpZGF0aW9uLFxyXG4gICAgICAgICAgdXNlci5pZCxcclxuICAgICAgICAgIG9yZGVyLmlkLFxyXG4gICAgICAgICAgZmluYWxQcmljZUJyZWFrZG93bi5vcmlnaW5hbEFtb3VudCB8fCAwLFxyXG4gICAgICAgICAgZmluYWxUb3RhbEFtb3VudFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHJldHVybiBhd2FpdCBoYW5kbGVBbmRHZW5lcmF0ZVRpY2tldHMob3JkZXIsIGV2ZW50LCB1c2VyLCB0aWNrZXRUeXBlKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQYXJhIHBhZ29zIGNvbiBtb250byA+IDAsIHByb2NlZGVyIGNvbiBUcmFuc2JhbmtcclxuICAgIGNvbnN0IHNlc3Npb25JZCA9IGdlbmVyYXRlU2hvcnRTZXNzaW9uSWQoXCJzZXNzXCIpO1xyXG4gICAgY29uc3QgcmV0dXJuVXJsID0gYCR7cHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfQVBQX1VSTH0vYXBpL3RyYW5zYmFuay9yZXR1cm5gO1xyXG5cclxuICAgIGNvbnN0IHRyYW5zYmFua1Jlc3BvbnNlID0gYXdhaXQgd2VicGF5UGx1cy5jcmVhdGUoXHJcbiAgICAgIG9yZGVyLm9yZGVyTnVtYmVyLFxyXG4gICAgICBzZXNzaW9uSWQsXHJcbiAgICAgIGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgIHJldHVyblVybFxyXG4gICAgKTtcclxuXHJcbiAgICBhd2FpdCBwcmlzbWEucGF5bWVudC5jcmVhdGUoe1xyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgb3JkZXJJZDogb3JkZXIuaWQsXHJcbiAgICAgICAgdHJhbnNhY3Rpb25JZDogc2Vzc2lvbklkLFxyXG4gICAgICAgIHRva2VuOiB0cmFuc2JhbmtSZXNwb25zZS50b2tlbixcclxuICAgICAgICBhbW91bnQ6IGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgICAgY3VycmVuY3k6IGV2ZW50LmN1cnJlbmN5LFxyXG4gICAgICAgIHN0YXR1czogXCJQRU5ESU5HXCIsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTaSBoYXkgY8OzZGlnbyBkZSBkZXNjdWVudG8sIGd1YXJkYXJsbyB0ZW1wb3JhbG1lbnRlIGVuIGxhIG9yZGVuIHBhcmEgYXBsaWNhcmxvIGRlc3B1w6lzIGRlbCBwYWdvXHJcbiAgICBpZiAoZGlzY291bnRDb2RlVmFsaWRhdGlvbiAmJiBkaXNjb3VudENvZGVWYWxpZGF0aW9uLmlzVmFsaWQpIHtcclxuICAgICAgLy8gUG9kcsOtYW1vcyB1c2FyIHVuIGNhbXBvIHRlbXBvcmFsIG8gbWV0YWRhdGEsIHBlcm8gcG9yIHNpbXBsaWNpZGFkIFxyXG4gICAgICAvLyBsbyBtYW5lamFyZW1vcyBlbiBlbCByZXR1cm4gZGUgVHJhbnNiYW5rXHJcbiAgICAgIGNvbnNvbGUubG9nKGBbRElTQ09VTlRdIEPDs2RpZ28gJHtwcm9tb0NvZGV9ICgke2Rpc2NvdW50Q29kZVZhbGlkYXRpb24udHlwZX0pIHF1ZWRhcsOhIHBlbmRpZW50ZSBwYXJhIGFwbGljYXIgdHJhcyBwYWdvIGV4aXRvc29gKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICBvcmRlcklkOiBvcmRlci5pZCxcclxuICAgICAgcGF5bWVudFVybDogdHJhbnNiYW5rUmVzcG9uc2UudXJsLFxyXG4gICAgICB0b2tlbjogdHJhbnNiYW5rUmVzcG9uc2UudG9rZW4sXHJcbiAgICAgIHByaWNlQnJlYWtkb3duOiB7XHJcbiAgICAgICAgb3JpZ2luYWxBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24ub3JpZ2luYWxBbW91bnQsXHJcbiAgICAgICAgZGlzY291bnRBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uZGlzY291bnRBbW91bnQsXHJcbiAgICAgICAgYmFzZUFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5iYXNlUHJpY2UsXHJcbiAgICAgICAgY29tbWlzc2lvbjogZmluYWxQcmljZUJyZWFrZG93bi5jb21taXNzaW9uLFxyXG4gICAgICAgIHRvdGFsQW1vdW50OiBmaW5hbFRvdGFsQW1vdW50LFxyXG4gICAgICAgIHByb21vQ29kZTogcHJvbW9Db2RlIHx8IG51bGxcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiPT09IEVSUk9SIEdFTkVSQUwgRU4gQ1JFQUNJw5NOIERFIFBBR08gPT09XCIsIGVycm9yKTtcclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAge1xyXG4gICAgICAgIGVycm9yOiBcIkVycm9yIGludGVybm8gZGVsIHNlcnZpZG9yXCIsXHJcbiAgICAgICAgZGV0YWlsczogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIkVycm9yIGRlc2Nvbm9jaWRvXCIsXHJcbiAgICAgIH0sXHJcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUFuZEdlbmVyYXRlVGlja2V0cyhvcmRlcjogT3JkZXIsIGV2ZW50OiBFdmVudCwgdXNlcjogVXNlciwgdGlja2V0VHlwZTogVGlja2V0VHlwZSkge1xyXG4gIGNvbnNvbGUubG9nKGBHZW5lcmFuZG8gdGlja2V0cyBwYXJhIGxhIG9yZGVuICR7b3JkZXIub3JkZXJOdW1iZXJ9YCk7XHJcblxyXG4gIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgY29uc3QgdGlja2V0c0RhdGEgPSBbXTtcclxuICBcclxuICBjb25zdCB0b3RhbFRpY2tldHNUb0dlbmVyYXRlID0gb3JkZXIucXVhbnRpdHkgKiB0aWNrZXRUeXBlLnRpY2tldHNHZW5lcmF0ZWQ7XHJcblxyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdG90YWxUaWNrZXRzVG9HZW5lcmF0ZTsgaSsrKSB7XHJcbiAgICBjb25zdCBxckNvZGUgPSBnZW5lcmF0ZVVuaXF1ZVFSQ29kZShldmVudC5pZCwgdXNlci5pZCwgdGltZXN0YW1wLCBpKTtcclxuICAgIHRpY2tldHNEYXRhLnB1c2goe1xyXG4gICAgICBxckNvZGUsXHJcbiAgICAgIGV2ZW50SWQ6IGV2ZW50LmlkLFxyXG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXHJcbiAgICAgIG9yZGVySWQ6IG9yZGVyLmlkLFxyXG4gICAgICB0aWNrZXRUeXBlSWQ6IHRpY2tldFR5cGUuaWQsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHRyYW5zYWN0aW9uUmVzdWx0ID0gYXdhaXQgcHJpc21hLiR0cmFuc2FjdGlvbihbXHJcbiAgICBwcmlzbWEudGlja2V0LmNyZWF0ZU1hbnkoeyBkYXRhOiB0aWNrZXRzRGF0YSB9KSxcclxuICAgIHByaXNtYS5vcmRlci51cGRhdGUoe1xyXG4gICAgICB3aGVyZTogeyBpZDogb3JkZXIuaWQgfSxcclxuICAgICAgZGF0YTogeyBzdGF0dXM6IFwiUEFJRFwiIH0sXHJcbiAgICAgIGluY2x1ZGU6IHsgdGlja2V0czogdHJ1ZSB9XHJcbiAgICB9KSxcclxuICBdKTtcclxuXHJcbiAgY29uc3QgdXBkYXRlZE9yZGVyID0gdHJhbnNhY3Rpb25SZXN1bHRbMV07XHJcbiAgY29uc29sZS5sb2coYCR7dGlja2V0c0RhdGEubGVuZ3RofSB0aWNrZXRzIGdlbmVyYWRvcy5gKTtcclxuXHJcbiAgY29uc3QgZXZlbnRXaXRoT3JnYW5pemVyID0gYXdhaXQgcHJpc21hLmV2ZW50LmZpbmRVbmlxdWUoe1xyXG4gICAgd2hlcmU6IHsgaWQ6IGV2ZW50LmlkIH0sXHJcbiAgICBpbmNsdWRlOiB7IG9yZ2FuaXplcjogdHJ1ZSB9XHJcbiAgfSk7XHJcblxyXG4gIGlmIChldmVudFdpdGhPcmdhbml6ZXIgJiYgdXNlci5maXJzdE5hbWUpIHtcclxuICAgIGF3YWl0IHNlbmRUaWNrZXRFbWFpbCh7XHJcbiAgICAgIHVzZXJFbWFpbDogdXNlci5lbWFpbCxcclxuICAgICAgdXNlck5hbWU6IHVzZXIuZmlyc3ROYW1lLFxyXG4gICAgICBldmVudFRpdGxlOiBldmVudFdpdGhPcmdhbml6ZXIudGl0bGUsXHJcbiAgICAgIGV2ZW50RGF0ZTogZXZlbnRXaXRoT3JnYW5pemVyLnN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLFxyXG4gICAgICBldmVudExvY2F0aW9uOiBldmVudFdpdGhPcmdhbml6ZXIubG9jYXRpb24sXHJcbiAgICAgIG9yZGVyTnVtYmVyOiB1cGRhdGVkT3JkZXIuaWQsXHJcbiAgICAgIHRpY2tldHM6IHVwZGF0ZWRPcmRlci50aWNrZXRzLm1hcCh0aWNrZXQgPT4gKHtcclxuICAgICAgICBxckNvZGU6IHRpY2tldC5xckNvZGUhLFxyXG4gICAgICAgIHFyQ29kZUltYWdlOiBgZGF0YTppbWFnZS9wbmc7YmFzZTY0LCR7dGlja2V0LnFyQ29kZX1gIC8vIFBsYWNlaG9sZGVyIGZvciBhY3R1YWwgUVIgaW1hZ2VcclxuICAgICAgfSkpXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XHJcbiAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgb3JkZXJJZDogb3JkZXIuaWQsXHJcbiAgICBpc0ZyZWU6IHRydWUsXHJcbiAgICB0aWNrZXRzR2VuZXJhdGVkOiB0b3RhbFRpY2tldHNUb0dlbmVyYXRlLFxyXG4gIH0pO1xyXG59Il0sInZlcnNpb24iOjN9