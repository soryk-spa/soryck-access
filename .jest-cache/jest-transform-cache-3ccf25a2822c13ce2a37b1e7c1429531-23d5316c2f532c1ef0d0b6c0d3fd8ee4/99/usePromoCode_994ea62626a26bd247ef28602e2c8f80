b4105211c5da1e82afbb4f32be090866
"use strict";
/**
 * Hooks personalizados para códigos promocionales
 * Extrae lógica reutilizable del componente
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.usePromoCodeManagement = usePromoCodeManagement;
exports.usePromoCodeFilters = usePromoCodeFilters;
exports.usePromoCodeStats = usePromoCodeStats;
exports.usePromoCodeSharing = usePromoCodeSharing;
const react_1 = require("react");
const sonner_1 = require("sonner");
// ============================================================================
// HOOK PARA MANEJO DE ESTADO DE CÓDIGOS PROMOCIONALES
// ============================================================================
function usePromoCodeManagement(initialPromoCodes) {
    const [promoCodes, setPromoCodes] = (0, react_1.useState)(initialPromoCodes);
    const [loadingStates, setLoadingStates] = (0, react_1.useState)({});
    const togglePromoCodeStatus = async (promoCode) => {
        const newStatus = promoCode.status === "ACTIVE" ? "INACTIVE" : "ACTIVE";
        const action = newStatus === "ACTIVE" ? "activar" : "desactivar";
        setLoadingStates(prev => (Object.assign(Object.assign({}, prev), { [promoCode.id]: true })));
        try {
            const response = await fetch(`/api/promo-codes/${promoCode.id}/toggle-status`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
            });
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || `Error al ${action} el código promocional`);
            }
            // Actualizar el estado local
            setPromoCodes(prev => prev.map(code => code.id === promoCode.id
                ? Object.assign(Object.assign({}, code), { status: newStatus }) : code));
            sonner_1.toast.success(`Código promocional ${action === "activar" ? "activado" : "desactivado"} exitosamente`);
        }
        catch (error) {
            console.error(`Error ${action} promo code:`, error);
            sonner_1.toast.error(error instanceof Error ? error.message : `Error al ${action} el código promocional`);
        }
        finally {
            setLoadingStates(prev => (Object.assign(Object.assign({}, prev), { [promoCode.id]: false })));
        }
    };
    const copyToClipboard = (code) => {
        navigator.clipboard.writeText(code);
        sonner_1.toast.success("Código copiado al portapapeles");
    };
    return {
        promoCodes,
        loadingStates,
        togglePromoCodeStatus,
        copyToClipboard,
    };
}
// ============================================================================
// HOOK PARA FILTRADO DE CÓDIGOS PROMOCIONALES
// ============================================================================
function usePromoCodeFilters(promoCodes) {
    const [filters, setFilters] = (0, react_1.useState)({
        search: "",
        status: "all",
    });
    const filteredPromoCodes = (0, react_1.useMemo)(() => {
        return promoCodes.filter((code) => {
            const matchesSearch = !filters.search ||
                code.code.toLowerCase().includes(filters.search.toLowerCase()) ||
                code.name.toLowerCase().includes(filters.search.toLowerCase());
            const matchesStatus = filters.status === "all" || code.status === filters.status;
            return matchesSearch && matchesStatus;
        });
    }, [promoCodes, filters]);
    const updateFilter = (key, value) => {
        setFilters(prev => (Object.assign(Object.assign({}, prev), { [key]: value })));
    };
    const clearFilters = () => {
        setFilters({ search: "", status: "all" });
    };
    return {
        filters,
        filteredPromoCodes,
        updateFilter,
        clearFilters,
    };
}
// ============================================================================
// HOOK PARA ESTADÍSTICAS DE CÓDIGOS PROMOCIONALES
// ============================================================================
function usePromoCodeStats(promoCodes) {
    const stats = (0, react_1.useMemo)(() => {
        const total = promoCodes.length;
        const active = promoCodes.filter(code => code.status === "ACTIVE").length;
        const totalUsages = promoCodes.reduce((sum, code) => sum + code.usedCount, 0);
        const expired = promoCodes.filter(code => code.status === "EXPIRED").length;
        const inactive = promoCodes.filter(code => code.status === "INACTIVE").length;
        const usedUp = promoCodes.filter(code => code.status === "USED_UP").length;
        return {
            total,
            active,
            inactive,
            expired,
            usedUp,
            totalUsages,
            activePercentage: total > 0 ? (active / total) * 100 : 0,
            usageRate: total > 0 ? (totalUsages / total) : 0,
        };
    }, [promoCodes]);
    return stats;
}
// ============================================================================
// HOOK PARA COMPARTIR CÓDIGOS PROMOCIONALES
// ============================================================================
function usePromoCodeSharing() {
    const sharePromoCode = (code, formatDiscount) => {
        const shareText = `🎫 ¡Descuento especial! Usa el código ${code.code} y obtén ${formatDiscount(code.type, code.value)} en tu próxima compra.`;
        if (navigator.share) {
            navigator.share({
                title: `Código promocional: ${code.name}`,
                text: shareText,
            });
        }
        else {
            navigator.clipboard.writeText(shareText);
            sonner_1.toast.success("Texto de promoción copiado al portapapeles");
        }
    };
    const exportPromoCodes = (promoCodes) => {
        // Lógica para exportar códigos promocionales
        const csv = generatePromoCodeCSV(promoCodes);
        downloadCSV(csv, 'codigos-promocionales.csv');
        sonner_1.toast.success("Códigos promocionales exportados exitosamente");
    };
    return {
        sharePromoCode,
        exportPromoCodes,
    };
}
// ============================================================================
// UTILIDADES AUXILIARES
// ============================================================================
function generatePromoCodeCSV(promoCodes) {
    const headers = ['Código', 'Nombre', 'Tipo', 'Valor', 'Estado', 'Usado', 'Límite', 'Válido Desde', 'Válido Hasta'];
    const rows = promoCodes.map(code => {
        var _a;
        return [
            code.code,
            code.name,
            code.type,
            code.value.toString(),
            code.status,
            code.usedCount.toString(),
            ((_a = code.usageLimit) === null || _a === void 0 ? void 0 : _a.toString()) || 'Sin límite',
            code.validFrom,
            code.validUntil || 'Sin fecha límite'
        ];
    });
    return [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
}
function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxob29rc1xcdXNlUHJvbW9Db2RlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBVUgsd0RBbURDO0FBTUQsa0RBbUNDO0FBTUQsOENBc0JDO0FBTUQsa0RBMEJDO0FBaEtELGlDQUEwQztBQUMxQyxtQ0FBK0I7QUFHL0IsK0VBQStFO0FBQy9FLHNEQUFzRDtBQUN0RCwrRUFBK0U7QUFFL0UsU0FBZ0Isc0JBQXNCLENBQUMsaUJBQThCO0lBQ25FLE1BQU0sQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFjLGlCQUFpQixDQUFDLENBQUM7SUFDN0UsTUFBTSxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBMEIsRUFBRSxDQUFDLENBQUM7SUFFaEYsTUFBTSxxQkFBcUIsR0FBRyxLQUFLLEVBQUUsU0FBb0IsRUFBRSxFQUFFO1FBQzNELE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUN4RSxNQUFNLE1BQU0sR0FBRyxTQUFTLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztRQUVqRSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGlDQUFNLElBQUksS0FBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLElBQUcsQ0FBQyxDQUFDO1FBRTlELElBQUksQ0FBQztZQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLG9CQUFvQixTQUFTLENBQUMsRUFBRSxnQkFBZ0IsRUFBRTtnQkFDN0UsTUFBTSxFQUFFLE9BQU87Z0JBQ2YsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO2dCQUMv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ZXh0XFxzb3J5Y2stYWNjZXNzXFxzcmNcXGhvb2tzXFx1c2VQcm9tb0NvZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEhvb2tzIHBlcnNvbmFsaXphZG9zIHBhcmEgY8OzZGlnb3MgcHJvbW9jaW9uYWxlc1xyXG4gKiBFeHRyYWUgbMOzZ2ljYSByZXV0aWxpemFibGUgZGVsIGNvbXBvbmVudGVcclxuICovXHJcblxyXG5pbXBvcnQgeyB1c2VTdGF0ZSwgdXNlTWVtbyB9IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IHsgdG9hc3QgfSBmcm9tICdzb25uZXInO1xyXG5pbXBvcnQgdHlwZSB7IFByb21vQ29kZSwgUHJvbW9Db2RlRmlsdGVycyB9IGZyb20gJ0AvdHlwZXMnO1xyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4vLyBIT09LIFBBUkEgTUFORUpPIERFIEVTVEFETyBERSBDw5NESUdPUyBQUk9NT0NJT05BTEVTXHJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2VQcm9tb0NvZGVNYW5hZ2VtZW50KGluaXRpYWxQcm9tb0NvZGVzOiBQcm9tb0NvZGVbXSkge1xyXG4gIGNvbnN0IFtwcm9tb0NvZGVzLCBzZXRQcm9tb0NvZGVzXSA9IHVzZVN0YXRlPFByb21vQ29kZVtdPihpbml0aWFsUHJvbW9Db2Rlcyk7XHJcbiAgY29uc3QgW2xvYWRpbmdTdGF0ZXMsIHNldExvYWRpbmdTdGF0ZXNdID0gdXNlU3RhdGU8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KHt9KTtcclxuXHJcbiAgY29uc3QgdG9nZ2xlUHJvbW9Db2RlU3RhdHVzID0gYXN5bmMgKHByb21vQ29kZTogUHJvbW9Db2RlKSA9PiB7XHJcbiAgICBjb25zdCBuZXdTdGF0dXMgPSBwcm9tb0NvZGUuc3RhdHVzID09PSBcIkFDVElWRVwiID8gXCJJTkFDVElWRVwiIDogXCJBQ1RJVkVcIjtcclxuICAgIGNvbnN0IGFjdGlvbiA9IG5ld1N0YXR1cyA9PT0gXCJBQ1RJVkVcIiA/IFwiYWN0aXZhclwiIDogXCJkZXNhY3RpdmFyXCI7XHJcbiAgICBcclxuICAgIHNldExvYWRpbmdTdGF0ZXMocHJldiA9PiAoeyAuLi5wcmV2LCBbcHJvbW9Db2RlLmlkXTogdHJ1ZSB9KSk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgL2FwaS9wcm9tby1jb2Rlcy8ke3Byb21vQ29kZS5pZH0vdG9nZ2xlLXN0YXR1c2AsIHtcclxuICAgICAgICBtZXRob2Q6IFwiUEFUQ0hcIixcclxuICAgICAgICBoZWFkZXJzOiB7IFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXHJcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBzdGF0dXM6IG5ld1N0YXR1cyB9KSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZGF0YS5lcnJvciB8fCBgRXJyb3IgYWwgJHthY3Rpb259IGVsIGPDs2RpZ28gcHJvbW9jaW9uYWxgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQWN0dWFsaXphciBlbCBlc3RhZG8gbG9jYWxcclxuICAgICAgc2V0UHJvbW9Db2RlcyhwcmV2ID0+IFxyXG4gICAgICAgIHByZXYubWFwKGNvZGUgPT4gXHJcbiAgICAgICAgICBjb2RlLmlkID09PSBwcm9tb0NvZGUuaWQgXHJcbiAgICAgICAgICAgID8geyAuLi5jb2RlLCBzdGF0dXM6IG5ld1N0YXR1cyB9XHJcbiAgICAgICAgICAgIDogY29kZVxyXG4gICAgICAgIClcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHRvYXN0LnN1Y2Nlc3MoYEPDs2RpZ28gcHJvbW9jaW9uYWwgJHthY3Rpb24gPT09IFwiYWN0aXZhclwiID8gXCJhY3RpdmFkb1wiIDogXCJkZXNhY3RpdmFkb1wifSBleGl0b3NhbWVudGVgKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yICR7YWN0aW9ufSBwcm9tbyBjb2RlOmAsIGVycm9yKTtcclxuICAgICAgdG9hc3QuZXJyb3IoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBgRXJyb3IgYWwgJHthY3Rpb259IGVsIGPDs2RpZ28gcHJvbW9jaW9uYWxgKTtcclxuICAgIH0gZmluYWxseSB7XHJcbiAgICAgIHNldExvYWRpbmdTdGF0ZXMocHJldiA9PiAoeyAuLi5wcmV2LCBbcHJvbW9Db2RlLmlkXTogZmFsc2UgfSkpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGNvbnN0IGNvcHlUb0NsaXBib2FyZCA9IChjb2RlOiBzdHJpbmcpID0+IHtcclxuICAgIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KGNvZGUpO1xyXG4gICAgdG9hc3Quc3VjY2VzcyhcIkPDs2RpZ28gY29waWFkbyBhbCBwb3J0YXBhcGVsZXNcIik7XHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHByb21vQ29kZXMsXHJcbiAgICBsb2FkaW5nU3RhdGVzLFxyXG4gICAgdG9nZ2xlUHJvbW9Db2RlU3RhdHVzLFxyXG4gICAgY29weVRvQ2xpcGJvYXJkLFxyXG4gIH07XHJcbn1cclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuLy8gSE9PSyBQQVJBIEZJTFRSQURPIERFIEPDk0RJR09TIFBST01PQ0lPTkFMRVNcclxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVzZVByb21vQ29kZUZpbHRlcnMocHJvbW9Db2RlczogUHJvbW9Db2RlW10pIHtcclxuICBjb25zdCBbZmlsdGVycywgc2V0RmlsdGVyc10gPSB1c2VTdGF0ZTxQcm9tb0NvZGVGaWx0ZXJzPih7XHJcbiAgICBzZWFyY2g6IFwiXCIsXHJcbiAgICBzdGF0dXM6IFwiYWxsXCIsXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IGZpbHRlcmVkUHJvbW9Db2RlcyA9IHVzZU1lbW8oKCkgPT4ge1xyXG4gICAgcmV0dXJuIHByb21vQ29kZXMuZmlsdGVyKChjb2RlKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1hdGNoZXNTZWFyY2ggPSAhZmlsdGVycy5zZWFyY2ggfHwgXHJcbiAgICAgICAgY29kZS5jb2RlLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoZmlsdGVycy5zZWFyY2gudG9Mb3dlckNhc2UoKSkgfHxcclxuICAgICAgICBjb2RlLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXJzLnNlYXJjaC50b0xvd2VyQ2FzZSgpKTtcclxuXHJcbiAgICAgIGNvbnN0IG1hdGNoZXNTdGF0dXMgPSBmaWx0ZXJzLnN0YXR1cyA9PT0gXCJhbGxcIiB8fCBjb2RlLnN0YXR1cyA9PT0gZmlsdGVycy5zdGF0dXM7XHJcblxyXG4gICAgICByZXR1cm4gbWF0Y2hlc1NlYXJjaCAmJiBtYXRjaGVzU3RhdHVzO1xyXG4gICAgfSk7XHJcbiAgfSwgW3Byb21vQ29kZXMsIGZpbHRlcnNdKTtcclxuXHJcbiAgY29uc3QgdXBkYXRlRmlsdGVyID0gPEsgZXh0ZW5kcyBrZXlvZiBQcm9tb0NvZGVGaWx0ZXJzPihcclxuICAgIGtleTogSywgXHJcbiAgICB2YWx1ZTogUHJvbW9Db2RlRmlsdGVyc1tLXVxyXG4gICkgPT4ge1xyXG4gICAgc2V0RmlsdGVycyhwcmV2ID0+ICh7IC4uLnByZXYsIFtrZXldOiB2YWx1ZSB9KSk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgY2xlYXJGaWx0ZXJzID0gKCkgPT4ge1xyXG4gICAgc2V0RmlsdGVycyh7IHNlYXJjaDogXCJcIiwgc3RhdHVzOiBcImFsbFwiIH0pO1xyXG4gIH07XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBmaWx0ZXJzLFxyXG4gICAgZmlsdGVyZWRQcm9tb0NvZGVzLFxyXG4gICAgdXBkYXRlRmlsdGVyLFxyXG4gICAgY2xlYXJGaWx0ZXJzLFxyXG4gIH07XHJcbn1cclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuLy8gSE9PSyBQQVJBIEVTVEFEw41TVElDQVMgREUgQ8OTRElHT1MgUFJPTU9DSU9OQUxFU1xyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlUHJvbW9Db2RlU3RhdHMocHJvbW9Db2RlczogUHJvbW9Db2RlW10pIHtcclxuICBjb25zdCBzdGF0cyA9IHVzZU1lbW8oKCkgPT4ge1xyXG4gICAgY29uc3QgdG90YWwgPSBwcm9tb0NvZGVzLmxlbmd0aDtcclxuICAgIGNvbnN0IGFjdGl2ZSA9IHByb21vQ29kZXMuZmlsdGVyKGNvZGUgPT4gY29kZS5zdGF0dXMgPT09IFwiQUNUSVZFXCIpLmxlbmd0aDtcclxuICAgIGNvbnN0IHRvdGFsVXNhZ2VzID0gcHJvbW9Db2Rlcy5yZWR1Y2UoKHN1bSwgY29kZSkgPT4gc3VtICsgY29kZS51c2VkQ291bnQsIDApO1xyXG4gICAgY29uc3QgZXhwaXJlZCA9IHByb21vQ29kZXMuZmlsdGVyKGNvZGUgPT4gY29kZS5zdGF0dXMgPT09IFwiRVhQSVJFRFwiKS5sZW5ndGg7XHJcbiAgICBjb25zdCBpbmFjdGl2ZSA9IHByb21vQ29kZXMuZmlsdGVyKGNvZGUgPT4gY29kZS5zdGF0dXMgPT09IFwiSU5BQ1RJVkVcIikubGVuZ3RoO1xyXG4gICAgY29uc3QgdXNlZFVwID0gcHJvbW9Db2Rlcy5maWx0ZXIoY29kZSA9PiBjb2RlLnN0YXR1cyA9PT0gXCJVU0VEX1VQXCIpLmxlbmd0aDtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0b3RhbCxcclxuICAgICAgYWN0aXZlLFxyXG4gICAgICBpbmFjdGl2ZSxcclxuICAgICAgZXhwaXJlZCxcclxuICAgICAgdXNlZFVwLFxyXG4gICAgICB0b3RhbFVzYWdlcyxcclxuICAgICAgYWN0aXZlUGVyY2VudGFnZTogdG90YWwgPiAwID8gKGFjdGl2ZSAvIHRvdGFsKSAqIDEwMCA6IDAsXHJcbiAgICAgIHVzYWdlUmF0ZTogdG90YWwgPiAwID8gKHRvdGFsVXNhZ2VzIC8gdG90YWwpIDogMCxcclxuICAgIH07XHJcbiAgfSwgW3Byb21vQ29kZXNdKTtcclxuXHJcbiAgcmV0dXJuIHN0YXRzO1xyXG59XHJcblxyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbi8vIEhPT0sgUEFSQSBDT01QQVJUSVIgQ8OTRElHT1MgUFJPTU9DSU9OQUxFU1xyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlUHJvbW9Db2RlU2hhcmluZygpIHtcclxuICBjb25zdCBzaGFyZVByb21vQ29kZSA9IChjb2RlOiBQcm9tb0NvZGUsIGZvcm1hdERpc2NvdW50OiAodHlwZTogc3RyaW5nLCB2YWx1ZTogbnVtYmVyKSA9PiBzdHJpbmcpID0+IHtcclxuICAgIGNvbnN0IHNoYXJlVGV4dCA9IGDwn46rIMKhRGVzY3VlbnRvIGVzcGVjaWFsISBVc2EgZWwgY8OzZGlnbyAke2NvZGUuY29kZX0geSBvYnTDqW4gJHtmb3JtYXREaXNjb3VudChjb2RlLnR5cGUsIGNvZGUudmFsdWUpfSBlbiB0dSBwcsOzeGltYSBjb21wcmEuYDtcclxuXHJcbiAgICBpZiAobmF2aWdhdG9yLnNoYXJlKSB7XHJcbiAgICAgIG5hdmlnYXRvci5zaGFyZSh7XHJcbiAgICAgICAgdGl0bGU6IGBDw7NkaWdvIHByb21vY2lvbmFsOiAke2NvZGUubmFtZX1gLFxyXG4gICAgICAgIHRleHQ6IHNoYXJlVGV4dCxcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChzaGFyZVRleHQpO1xyXG4gICAgICB0b2FzdC5zdWNjZXNzKFwiVGV4dG8gZGUgcHJvbW9jacOzbiBjb3BpYWRvIGFsIHBvcnRhcGFwZWxlc1wiKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBleHBvcnRQcm9tb0NvZGVzID0gKHByb21vQ29kZXM6IFByb21vQ29kZVtdKSA9PiB7XHJcbiAgICAvLyBMw7NnaWNhIHBhcmEgZXhwb3J0YXIgY8OzZGlnb3MgcHJvbW9jaW9uYWxlc1xyXG4gICAgY29uc3QgY3N2ID0gZ2VuZXJhdGVQcm9tb0NvZGVDU1YocHJvbW9Db2Rlcyk7XHJcbiAgICBkb3dubG9hZENTVihjc3YsICdjb2RpZ29zLXByb21vY2lvbmFsZXMuY3N2Jyk7XHJcbiAgICB0b2FzdC5zdWNjZXNzKFwiQ8OzZGlnb3MgcHJvbW9jaW9uYWxlcyBleHBvcnRhZG9zIGV4aXRvc2FtZW50ZVwiKTtcclxuICB9O1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc2hhcmVQcm9tb0NvZGUsXHJcbiAgICBleHBvcnRQcm9tb0NvZGVzLFxyXG4gIH07XHJcbn1cclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuLy8gVVRJTElEQURFUyBBVVhJTElBUkVTXHJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlUHJvbW9Db2RlQ1NWKHByb21vQ29kZXM6IFByb21vQ29kZVtdKTogc3RyaW5nIHtcclxuICBjb25zdCBoZWFkZXJzID0gWydDw7NkaWdvJywgJ05vbWJyZScsICdUaXBvJywgJ1ZhbG9yJywgJ0VzdGFkbycsICdVc2FkbycsICdMw61taXRlJywgJ1bDoWxpZG8gRGVzZGUnLCAnVsOhbGlkbyBIYXN0YSddO1xyXG4gIFxyXG4gIGNvbnN0IHJvd3MgPSBwcm9tb0NvZGVzLm1hcChjb2RlID0+IFtcclxuICAgIGNvZGUuY29kZSxcclxuICAgIGNvZGUubmFtZSxcclxuICAgIGNvZGUudHlwZSxcclxuICAgIGNvZGUudmFsdWUudG9TdHJpbmcoKSxcclxuICAgIGNvZGUuc3RhdHVzLFxyXG4gICAgY29kZS51c2VkQ291bnQudG9TdHJpbmcoKSxcclxuICAgIGNvZGUudXNhZ2VMaW1pdD8udG9TdHJpbmcoKSB8fCAnU2luIGzDrW1pdGUnLFxyXG4gICAgY29kZS52YWxpZEZyb20sXHJcbiAgICBjb2RlLnZhbGlkVW50aWwgfHwgJ1NpbiBmZWNoYSBsw61taXRlJ1xyXG4gIF0pO1xyXG5cclxuICByZXR1cm4gW2hlYWRlcnMsIC4uLnJvd3NdXHJcbiAgICAubWFwKHJvdyA9PiByb3cubWFwKGNlbGwgPT4gYFwiJHtjZWxsfVwiYCkuam9pbignLCcpKVxyXG4gICAgLmpvaW4oJ1xcbicpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZENTVihjb250ZW50OiBzdHJpbmcsIGZpbGVuYW1lOiBzdHJpbmcpIHtcclxuICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2NvbnRlbnRdLCB7IHR5cGU6ICd0ZXh0L2NzdjtjaGFyc2V0PXV0Zi04OycgfSk7XHJcbiAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICBcclxuICBpZiAobGluay5kb3dubG9hZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xyXG4gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCB1cmwpO1xyXG4gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2Rvd25sb2FkJywgZmlsZW5hbWUpO1xyXG4gICAgbGluay5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XHJcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspO1xyXG4gICAgbGluay5jbGljaygpO1xyXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChsaW5rKTtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9