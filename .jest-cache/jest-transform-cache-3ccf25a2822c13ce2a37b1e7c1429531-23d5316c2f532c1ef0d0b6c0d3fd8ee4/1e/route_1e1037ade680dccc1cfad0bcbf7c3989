af3029595165ec9ea0d604a74ba4e46f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.POST = POST;
const server_1 = require("next/server");
const auth_1 = require("@/lib/auth");
const prisma_1 = require("@/lib/prisma");
const transbank_1 = require("@/lib/transbank");
const qr_1 = require("@/lib/qr");
const commission_1 = require("@/lib/commission");
const discount_codes_1 = require("@/lib/discount-codes");
const email_1 = require("@/lib/email");
const zod_1 = require("zod");
const createPaymentSchema = zod_1.z.object({
    ticketTypeId: zod_1.z.string().min(1, "Se requiere el tipo de ticket"),
    quantity: zod_1.z.number().min(1, "La cantidad debe ser al menos 1").max(10, "No puedes comprar más de 10 tickets a la vez."),
    promoCode: zod_1.z.string().optional(),
});
function generateShortBuyOrder(prefix = "SP") {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const hour = String(now.getHours()).padStart(2, "0");
    const minute = String(now.getMinutes()).padStart(2, "0");
    const second = String(now.getSeconds()).padStart(2, "0");
    const ms = String(now.getMilliseconds()).padStart(3, "0").slice(0, 2);
    const random = Math.random().toString(36).substr(2, 2).toUpperCase();
    const buyOrder = `${prefix}${year}${month}${day}${hour}${minute}${second}${ms}${random}`;
    return buyOrder.substring(0, 26);
}
function generateShortSessionId(prefix = "sess") {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 4);
    const sessionId = `${prefix}-${timestamp}-${random}`;
    return sessionId.substring(0, 61);
}
async function POST(request) {
    try {
        console.log("=== INICIO DE CREACIÓN DE PAGO CON PROMO CODES ===");
        const user = await (0, auth_1.requireAuth)();
        const body = await request.json();
        const validation = createPaymentSchema.safeParse(body);
        if (!validation.success) {
            return server_1.NextResponse.json({ error: "Datos inválidos", details: validation.error.issues }, { status: 400 });
        }
        const { ticketTypeId, quantity, promoCode } = validation.data;
        const ticketType = await prisma_1.prisma.ticketType.findUnique({
            where: { id: ticketTypeId },
            include: {
                event: true
            },
        });
        if (!ticketType || !ticketType.event.isPublished) {
            return server_1.NextResponse.json({ error: "Tipo de entrada no encontrado o el evento no está publicado" }, { status: 404 });
        }
        const event = ticketType.event;
        const ticketsSoldForType = await prisma_1.prisma.ticket.count({
            where: { ticketTypeId: ticketTypeId },
        });
        const ticketsGeneratedPerPurchase = ticketType.ticketsGenerated;
        const capacityInTickets = ticketType.capacity * ticketsGeneratedPerPurchase;
        const availableTickets = capacityInTickets - ticketsSoldForType;
        if ((quantity * ticketsGeneratedPerPurchase) > availableTickets) {
            return server_1.NextResponse.json({ error: `No hay suficientes tickets disponibles. Solo quedan ${Math.floor(availableTickets / ticketsGeneratedPerPurchase)}.` }, { status: 400 });
        }
        let discountCodeValidation = null;
        let finalPriceBreakdown = null;
        const basePrice = ticketType.price;
        const baseTotalAmount = basePrice * quantity;
        if (promoCode && promoCode.trim()) {
            console.log(`[DISCOUNT] Validando código de descuento: ${promoCode}`);
            discountCodeValidation = await discount_codes_1.DiscountCodeService.validateDiscountCode(promoCode.trim(), user.id, ticketTypeId, quantity);
            if (!discountCodeValidation.isValid) {
                return server_1.NextResponse.json({ error: discountCodeValidation.error }, { status: 400 });
            }
            console.log(`[DISCOUNT] ✅ Código válido (${discountCodeValidation.type}). Descuento: ${discountCodeValidation.discountAmount}`);
            finalPriceBreakdown = (0, commission_1.calculatePriceBreakdownWithDiscount)(baseTotalAmount, discountCodeValidation.discountAmount || 0, event.currency);
            finalPriceBreakdown.promoCode = discountCodeValidation.code;
        }
        else {
            finalPriceBreakdown = (0, commission_1.calculatePriceBreakdown)(baseTotalAmount, event.currency);
            finalPriceBreakdown.originalAmount = baseTotalAmount;
            finalPriceBreakdown.discountAmount = 0;
        }
        const finalTotalAmount = finalPriceBreakdown.totalPrice;
        console.log(`[PAYMENT] Resumen de precios:`, {
            baseAmount: baseTotalAmount,
            discountAmount: finalPriceBreakdown.discountAmount,
            afterDiscount: finalPriceBreakdown.basePrice,
            commission: finalPriceBreakdown.commission,
            finalTotal: finalTotalAmount,
            hasPromoCode: !!promoCode,
            originalAmount: finalPriceBreakdown.originalAmount
        });
        console.log(`[WEBPAY] Monto que será enviado a WebPay: $${finalTotalAmount} ${event.currency}`);
        const orderNumber = generateShortBuyOrder("SP");
        const order = await prisma_1.prisma.order.create({
            data: {
                orderNumber,
                totalAmount: finalTotalAmount,
                baseAmount: finalPriceBreakdown.basePrice,
                commissionAmount: finalPriceBreakdown.commission,
                originalAmount: finalPriceBreakdown.originalAmount,
                discountAmount: finalPriceBreakdown.discountAmount,
                currency: event.currency,
                quantity,
                status: "PENDING",
                userId: user.id,
                eventId: event.id,
            },
        });
        console.log("Orden creada:", {
            orderId: order.id,
            total: finalTotalAmount,
            discount: finalPriceBreakdown.discountAmount,
            promoApplied: !!promoCode
        });
        const isFree = finalTotalAmount === 0;
        if (isFree) {
            console.log("Entrada gratuita o con descuento del 100%, procesando directamente...");
            if (discountCodeValidation && discountCodeValidation.isValid) {
                await discount_codes_1.DiscountCodeService.applyCodeUsage(discountCodeValidation, user.id, order.id, finalPriceBreakdown.originalAmount || 0, finalTotalAmount);
            }
            return await handleAndGenerateTickets(order, event, user, ticketType);
        }
        const sessionId = generateShortSessionId("sess");
        const returnUrl = `${process.env.NEXT_PUBLIC_APP_URL}/api/transbank/return`;
        const transbankResponse = await transbank_1.webpayPlus.create(order.orderNumber, sessionId, finalTotalAmount, returnUrl);
        await prisma_1.prisma.payment.create({
            data: {
                orderId: order.id,
                transactionId: sessionId,
                token: transbankResponse.token,
                amount: finalTotalAmount,
                currency: event.currency,
                status: "PENDING",
            },
        });
        if (discountCodeValidation && discountCodeValidation.isValid) {
            console.log(`[DISCOUNT] Código ${promoCode} (${discountCodeValidation.type}) quedará pendiente para aplicar tras pago exitoso`);
        }
        return server_1.NextResponse.json({
            success: true,
            orderId: order.id,
            paymentUrl: transbankResponse.url,
            token: transbankResponse.token,
            priceBreakdown: {
                originalAmount: finalPriceBreakdown.originalAmount,
                discountAmount: finalPriceBreakdown.discountAmount,
                baseAmount: finalPriceBreakdown.basePrice,
                commission: finalPriceBreakdown.commission,
                totalAmount: finalTotalAmount,
                promoCode: promoCode || null
            }
        });
    }
    catch (error) {
        console.error("=== ERROR GENERAL EN CREACIÓN DE PAGO ===", error);
        return server_1.NextResponse.json({
            error: "Error interno del servidor",
            details: error instanceof Error ? error.message : "Error desconocido",
        }, { status: 500 });
    }
}
async function handleAndGenerateTickets(order, event, user, ticketType) {
    console.log(`Generando tickets para la orden ${order.orderNumber}`);
    const timestamp = Date.now();
    const ticketsData = [];
    const totalTicketsToGenerate = order.quantity * ticketType.ticketsGenerated;
    for (let i = 0; i < totalTicketsToGenerate; i++) {
        const qrCode = (0, qr_1.generateUniqueQRCode)(event.id, user.id, timestamp, i);
        ticketsData.push({
            qrCode,
            eventId: event.id,
            userId: user.id,
            orderId: order.id,
            ticketTypeId: ticketType.id,
        });
    }
    const transactionResult = await prisma_1.prisma.$transaction([
        prisma_1.prisma.ticket.createMany({ data: ticketsData }),
        prisma_1.prisma.order.update({
            where: { id: order.id },
            data: { status: "PAID" },
            include: { tickets: true }
        }),
    ]);
    const updatedOrder = transactionResult[1];
    console.log(`${ticketsData.length} tickets generados.`);
    const eventWithOrganizer = await prisma_1.prisma.event.findUnique({
        where: { id: event.id },
        include: { organizer: true }
    });
    if (eventWithOrganizer && user.firstName) {
        await (0, email_1.sendTicketEmail)({
            userEmail: user.email,
            userName: user.firstName,
            eventTitle: eventWithOrganizer.title,
            eventDate: eventWithOrganizer.startDate.toISOString(),
            eventLocation: eventWithOrganizer.location,
            orderNumber: updatedOrder.id,
            tickets: updatedOrder.tickets.map(ticket => ({
                qrCode: ticket.qrCode,
                qrCodeImage: `data:image/png;base64,${ticket.qrCode}`
            }))
        });
    }
    return server_1.NextResponse.json({
        success: true,
        orderId: order.id,
        isFree: true,
        ticketsGenerated: totalTicketsToGenerate,
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxccGF5bWVudHNcXGNyZWF0ZVxccm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7QUFzQ0Esb0JBc01DO0FBNU9ELHdDQUF3RDtBQUN4RCxxQ0FBeUM7QUFDekMseUNBQXNDO0FBQ3RDLCtDQUE2QztBQUM3QyxpQ0FBZ0Q7QUFDaEQsaURBQWdHO0FBQ2hHLHlEQUEyRDtBQUMzRCx1Q0FBOEM7QUFDOUMsNkJBQXdCO0FBR3hCLE1BQU0sbUJBQW1CLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxZQUFZLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsK0JBQStCLENBQUM7SUFDaEUsUUFBUSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGlDQUFpQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSwrQ0FBK0MsQ0FBQztJQUN2SCxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtDQUNqQyxDQUFDLENBQUM7QUFFSCxTQUFTLHFCQUFxQixDQUFDLFNBQWlCLElBQUk7SUFDbEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN2QixNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25ELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JFLE1BQU0sUUFBUSxHQUFHLEdBQUcsTUFBTSxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksR0FBRyxNQUFNLEdBQUcsTUFBTSxHQUFHLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztJQUN6RixPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ25DLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLFNBQWlCLE1BQU07SUFDckQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFB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QUUsRUFBRTtRQUN2QixPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFO0tBQzdCLENBQUMsQ0FBQztJQUVILElBQUksa0JBQWtCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3pDLE1BQU0sSUFBQSx1QkFBZSxFQUFDO1lBQ3BCLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSztZQUNyQixRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDeEIsVUFBVSxFQUFFLGtCQUFrQixDQUFDLEtBQUs7WUFDcEMsU0FBUyxFQUFFLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDckQsYUFBYSxFQUFFLGtCQUFrQixDQUFDLFFBQVE7WUFDMUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxFQUFFO1lBQzVCLE9BQU8sRUFBRSxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQzNDLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTztnQkFDdEIsV0FBVyxFQUFFLHlCQUF5QixNQUFNLENBQUMsTUFBTSxFQUFFO2FBQ3RELENBQUMsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLE9BQU8sRUFBRSxJQUFJO1FBQ2IsT0FBTyxFQUFFLEtBQUssQ0FBQyxFQUFFO1FBQ2pCLE1BQU0sRUFBRSxJQUFJO1FBQ1osZ0JBQWdCLEVBQUUsc0JBQXNCO0tBQ3pDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxccGF5bWVudHNcXGNyZWF0ZVxccm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xyXG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gXCJAL2xpYi9hdXRoXCI7XHJcbmltcG9ydCB7IHByaXNtYSB9IGZyb20gXCJAL2xpYi9wcmlzbWFcIjtcclxuaW1wb3J0IHsgd2VicGF5UGx1cyB9IGZyb20gXCJAL2xpYi90cmFuc2JhbmtcIjtcclxuaW1wb3J0IHsgZ2VuZXJhdGVVbmlxdWVRUkNvZGUgfSBmcm9tIFwiQC9saWIvcXJcIjtcclxuaW1wb3J0IHsgY2FsY3VsYXRlUHJpY2VCcmVha2Rvd24sIGNhbGN1bGF0ZVByaWNlQnJlYWtkb3duV2l0aERpc2NvdW50IH0gZnJvbSBcIkAvbGliL2NvbW1pc3Npb25cIjtcclxuaW1wb3J0IHsgRGlzY291bnRDb2RlU2VydmljZSB9IGZyb20gXCJAL2xpYi9kaXNjb3VudC1jb2Rlc1wiO1xyXG5pbXBvcnQgeyBzZW5kVGlja2V0RW1haWwgfSBmcm9tICdAL2xpYi9lbWFpbCc7XHJcbmltcG9ydCB7IHogfSBmcm9tIFwiem9kXCI7XHJcbmltcG9ydCB7IE9yZGVyLCBFdmVudCwgVXNlciwgVGlja2V0VHlwZSB9IGZyb20gXCJAcHJpc21hL2NsaWVudFwiO1xyXG5cclxuY29uc3QgY3JlYXRlUGF5bWVudFNjaGVtYSA9IHoub2JqZWN0KHtcclxuICB0aWNrZXRUeXBlSWQ6IHouc3RyaW5nKCkubWluKDEsIFwiU2UgcmVxdWllcmUgZWwgdGlwbyBkZSB0aWNrZXRcIiksXHJcbiAgcXVhbnRpdHk6IHoubnVtYmVyKCkubWluKDEsIFwiTGEgY2FudGlkYWQgZGViZSBzZXIgYWwgbWVub3MgMVwiKS5tYXgoMTAsIFwiTm8gcHVlZGVzIGNvbXByYXIgbcOhcyBkZSAxMCB0aWNrZXRzIGEgbGEgdmV6LlwiKSxcclxuICBwcm9tb0NvZGU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSwgXG59KTtcclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlU2hvcnRCdXlPcmRlcihwcmVmaXg6IHN0cmluZyA9IFwiU1BcIik6IHN0cmluZyB7XHJcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcclxuICBjb25zdCB5ZWFyID0gbm93LmdldEZ1bGxZZWFyKCkudG9TdHJpbmcoKS5zbGljZSgtMik7XHJcbiAgY29uc3QgbW9udGggPSBTdHJpbmcobm93LmdldE1vbnRoKCkgKyAxKS5wYWRTdGFydCgyLCBcIjBcIik7XHJcbiAgY29uc3QgZGF5ID0gU3RyaW5nKG5vdy5nZXREYXRlKCkpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcclxuICBjb25zdCBob3VyID0gU3RyaW5nKG5vdy5nZXRIb3VycygpKS5wYWRTdGFydCgyLCBcIjBcIik7XHJcbiAgY29uc3QgbWludXRlID0gU3RyaW5nKG5vdy5nZXRNaW51dGVzKCkpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcclxuICBjb25zdCBzZWNvbmQgPSBTdHJpbmcobm93LmdldFNlY29uZHMoKSkucGFkU3RhcnQoMiwgXCIwXCIpO1xyXG4gIGNvbnN0IG1zID0gU3RyaW5nKG5vdy5nZXRNaWxsaXNlY29uZHMoKSkucGFkU3RhcnQoMywgXCIwXCIpLnNsaWNlKDAsIDIpO1xyXG4gIGNvbnN0IHJhbmRvbSA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCAyKS50b1VwcGVyQ2FzZSgpO1xyXG4gIGNvbnN0IGJ1eU9yZGVyID0gYCR7cHJlZml4fSR7eWVhcn0ke21vbnRofSR7ZGF5fSR7aG91cn0ke21pbnV0ZX0ke3NlY29uZH0ke21zfSR7cmFuZG9tfWA7XHJcbiAgcmV0dXJuIGJ1eU9yZGVyLnN1YnN0cmluZygwLCAyNik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlU2hvcnRTZXNzaW9uSWQocHJlZml4OiBzdHJpbmcgPSBcInNlc3NcIik6IHN0cmluZyB7XHJcbiAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKS50b1N0cmluZygzNik7XHJcbiAgY29uc3QgcmFuZG9tID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDQpO1xyXG4gIGNvbnN0IHNlc3Npb25JZCA9IGAke3ByZWZpeH0tJHt0aW1lc3RhbXB9LSR7cmFuZG9tfWA7XHJcbiAgcmV0dXJuIHNlc3Npb25JZC5zdWJzdHJpbmcoMCwgNjEpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChyZXF1ZXN0OiBOZXh0UmVxdWVzdCkge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zb2xlLmxvZyhcIj09PSBJTklDSU8gREUgQ1JFQUNJw5NOIERFIFBBR08gQ09OIFBST01PIENPREVTID09PVwiKTtcclxuXHJcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgcmVxdWlyZUF1dGgoKTtcclxuICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcclxuICAgIGNvbnN0IHZhbGlkYXRpb24gPSBjcmVhdGVQYXltZW50U2NoZW1hLnNhZmVQYXJzZShib2R5KTtcclxuXHJcbiAgICBpZiAoIXZhbGlkYXRpb24uc3VjY2Vzcykge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJEYXRvcyBpbnbDoWxpZG9zXCIsIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3IuaXNzdWVzIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyB0aWNrZXRUeXBlSWQsIHF1YW50aXR5LCBwcm9tb0NvZGUgfSA9IHZhbGlkYXRpb24uZGF0YTtcclxuXHJcbiAgICBjb25zdCB0aWNrZXRUeXBlID0gYXdhaXQgcHJpc21hLnRpY2tldFR5cGUuZmluZFVuaXF1ZSh7XHJcbiAgICAgIHdoZXJlOiB7IGlkOiB0aWNrZXRUeXBlSWQgfSxcclxuICAgICAgaW5jbHVkZToge1xyXG4gICAgICAgIGV2ZW50OiB0cnVlXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoIXRpY2tldFR5cGUgfHwgIXRpY2tldFR5cGUuZXZlbnQuaXNQdWJsaXNoZWQpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgIHsgZXJyb3I6IFwiVGlwbyBkZSBlbnRyYWRhIG5vIGVuY29udHJhZG8gbyBlbCBldmVudG8gbm8gZXN0w6EgcHVibGljYWRvXCIgfSxcclxuICAgICAgICB7IHN0YXR1czogNDA0IH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBldmVudCA9IHRpY2tldFR5cGUuZXZlbnQ7XHJcblxyXG4gICAgY29uc3QgdGlja2V0c1NvbGRGb3JUeXBlID0gYXdhaXQgcHJpc21hLnRpY2tldC5jb3VudCh7XHJcbiAgICAgIHdoZXJlOiB7IHRpY2tldFR5cGVJZDogdGlja2V0VHlwZUlkIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCB0aWNrZXRzR2VuZXJhdGVkUGVyUHVyY2hhc2UgPSB0aWNrZXRUeXBlLnRpY2tldHNHZW5lcmF0ZWQ7XHJcbiAgICBjb25zdCBjYXBhY2l0eUluVGlja2V0cyA9IHRpY2tldFR5cGUuY2FwYWNpdHkgKiB0aWNrZXRzR2VuZXJhdGVkUGVyUHVyY2hhc2U7XHJcbiAgICBjb25zdCBhdmFpbGFibGVUaWNrZXRzID0gY2FwYWNpdHlJblRpY2tldHMgLSB0aWNrZXRzU29sZEZvclR5cGU7XHJcblxyXG4gICAgaWYgKChxdWFudGl0eSAqIHRpY2tldHNHZW5lcmF0ZWRQZXJQdXJjaGFzZSkgPiBhdmFpbGFibGVUaWNrZXRzKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBgTm8gaGF5IHN1ZmljaWVudGVzIHRpY2tldHMgZGlzcG9uaWJsZXMuIFNvbG8gcXVlZGFuICR7TWF0aC5mbG9vcihhdmFpbGFibGVUaWNrZXRzIC8gdGlja2V0c0dlbmVyYXRlZFBlclB1cmNoYXNlKX0uYCB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBkaXNjb3VudENvZGVWYWxpZGF0aW9uID0gbnVsbDtcclxuICAgIGxldCBmaW5hbFByaWNlQnJlYWtkb3duID0gbnVsbDtcclxuICAgIFxyXG4gICAgY29uc3QgYmFzZVByaWNlID0gdGlja2V0VHlwZS5wcmljZTtcclxuICAgIGNvbnN0IGJhc2VUb3RhbEFtb3VudCA9IGJhc2VQcmljZSAqIHF1YW50aXR5O1xyXG5cclxuICAgIGlmIChwcm9tb0NvZGUgJiYgcHJvbW9Db2RlLnRyaW0oKSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhgW0RJU0NPVU5UXSBWYWxpZGFuZG8gY8OzZGlnbyBkZSBkZXNjdWVudG86ICR7cHJvbW9Db2RlfWApO1xyXG4gICAgICBcclxuICAgICAgZGlzY291bnRDb2RlVmFsaWRhdGlvbiA9IGF3YWl0IERpc2NvdW50Q29kZVNlcnZpY2UudmFsaWRhdGVEaXNjb3VudENvZGUoXHJcbiAgICAgICAgcHJvbW9Db2RlLnRyaW0oKSxcclxuICAgICAgICB1c2VyLmlkLFxyXG4gICAgICAgIHRpY2tldFR5cGVJZCxcclxuICAgICAgICBxdWFudGl0eVxyXG4gICAgICApO1xyXG5cclxuICAgICAgaWYgKCFkaXNjb3VudENvZGVWYWxpZGF0aW9uLmlzVmFsaWQpIHtcclxuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgICB7IGVycm9yOiBkaXNjb3VudENvZGVWYWxpZGF0aW9uLmVycm9yIH0sXHJcbiAgICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhgW0RJU0NPVU5UXSDinIUgQ8OzZGlnbyB2w6FsaWRvICgke2Rpc2NvdW50Q29kZVZhbGlkYXRpb24udHlwZX0pLiBEZXNjdWVudG86ICR7ZGlzY291bnRDb2RlVmFsaWRhdGlvbi5kaXNjb3VudEFtb3VudH1gKTtcclxuICAgICAgXHJcbiAgICAgIFxuICAgICAgZmluYWxQcmljZUJyZWFrZG93biA9IGNhbGN1bGF0ZVByaWNlQnJlYWtkb3duV2l0aERpc2NvdW50KFxyXG4gICAgICAgIGJhc2VUb3RhbEFtb3VudCxcclxuICAgICAgICBkaXNjb3VudENvZGVWYWxpZGF0aW9uLmRpc2NvdW50QW1vdW50IHx8IDAsXHJcbiAgICAgICAgZXZlbnQuY3VycmVuY3lcclxuICAgICAgKTtcclxuICAgICAgXHJcbiAgICAgIGZpbmFsUHJpY2VCcmVha2Rvd24ucHJvbW9Db2RlID0gZGlzY291bnRDb2RlVmFsaWRhdGlvbi5jb2RlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZmluYWxQcmljZUJyZWFrZG93biA9IGNhbGN1bGF0ZVByaWNlQnJlYWtkb3duKGJhc2VUb3RhbEFtb3VudCwgZXZlbnQuY3VycmVuY3kpO1xyXG4gICAgICBmaW5hbFByaWNlQnJlYWtkb3duLm9yaWdpbmFsQW1vdW50ID0gYmFzZVRvdGFsQW1vdW50O1xyXG4gICAgICBmaW5hbFByaWNlQnJlYWtkb3duLmRpc2NvdW50QW1vdW50ID0gMDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaW5hbFRvdGFsQW1vdW50ID0gZmluYWxQcmljZUJyZWFrZG93bi50b3RhbFByaWNlO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKGBbUEFZTUVOVF0gUmVzdW1lbiBkZSBwcmVjaW9zOmAsIHtcclxuICAgICAgYmFzZUFtb3VudDogYmFzZVRvdGFsQW1vdW50LFxyXG4gICAgICBkaXNjb3VudEFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5kaXNjb3VudEFtb3VudCxcclxuICAgICAgYWZ0ZXJEaXNjb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5iYXNlUHJpY2UsXHJcbiAgICAgIGNvbW1pc3Npb246IGZpbmFsUHJpY2VCcmVha2Rvd24uY29tbWlzc2lvbixcclxuICAgICAgZmluYWxUb3RhbDogZmluYWxUb3RhbEFtb3VudCxcclxuICAgICAgaGFzUHJvbW9Db2RlOiAhIXByb21vQ29kZSxcclxuICAgICAgb3JpZ2luYWxBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24ub3JpZ2luYWxBbW91bnRcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKGBbV0VCUEFZXSBNb250byBxdWUgc2Vyw6EgZW52aWFkbyBhIFdlYlBheTogJCR7ZmluYWxUb3RhbEFtb3VudH0gJHtldmVudC5jdXJyZW5jeX1gKTtcclxuXHJcbiAgICBjb25zdCBvcmRlck51bWJlciA9IGdlbmVyYXRlU2hvcnRCdXlPcmRlcihcIlNQXCIpO1xyXG4gICAgY29uc3Qgb3JkZXIgPSBhd2FpdCBwcmlzbWEub3JkZXIuY3JlYXRlKHtcclxuICAgICAgZGF0YToge1xyXG4gICAgICAgIG9yZGVyTnVtYmVyLFxyXG4gICAgICAgIHRvdGFsQW1vdW50OiBmaW5hbFRvdGFsQW1vdW50LFxyXG4gICAgICAgIGJhc2VBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uYmFzZVByaWNlLFxyXG4gICAgICAgIGNvbW1pc3Npb25BbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uY29tbWlzc2lvbixcclxuICAgICAgICBvcmlnaW5hbEFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5vcmlnaW5hbEFtb3VudCwgXG4gICAgICAgIGRpc2NvdW50QW1vdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmRpc2NvdW50QW1vdW50LCBcbiAgICAgICAgY3VycmVuY3k6IGV2ZW50LmN1cnJlbmN5LFxyXG4gICAgICAgIHF1YW50aXR5LFxyXG4gICAgICAgIHN0YXR1czogXCJQRU5ESU5HXCIsXHJcbiAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxyXG4gICAgICAgIGV2ZW50SWQ6IGV2ZW50LmlkLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc29sZS5sb2coXCJPcmRlbiBjcmVhZGE6XCIsIHsgXHJcbiAgICAgIG9yZGVySWQ6IG9yZGVyLmlkLCBcclxuICAgICAgdG90YWw6IGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgIGRpc2NvdW50OiBmaW5hbFByaWNlQnJlYWtkb3duLmRpc2NvdW50QW1vdW50LFxyXG4gICAgICBwcm9tb0FwcGxpZWQ6ICEhcHJvbW9Db2RlXHJcbiAgICB9KTtcclxuXHJcbiAgICBcbiAgICBjb25zdCBpc0ZyZWUgPSBmaW5hbFRvdGFsQW1vdW50ID09PSAwO1xyXG4gICAgaWYgKGlzRnJlZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIkVudHJhZGEgZ3JhdHVpdGEgbyBjb24gZGVzY3VlbnRvIGRlbCAxMDAlLCBwcm9jZXNhbmRvIGRpcmVjdGFtZW50ZS4uLlwiKTtcclxuICAgICAgXHJcbiAgICAgIFxuICAgICAgaWYgKGRpc2NvdW50Q29kZVZhbGlkYXRpb24gJiYgZGlzY291bnRDb2RlVmFsaWRhdGlvbi5pc1ZhbGlkKSB7XHJcbiAgICAgICAgYXdhaXQgRGlzY291bnRDb2RlU2VydmljZS5hcHBseUNvZGVVc2FnZShcclxuICAgICAgICAgIGRpc2NvdW50Q29kZVZhbGlkYXRpb24sXHJcbiAgICAgICAgICB1c2VyLmlkLFxyXG4gICAgICAgICAgb3JkZXIuaWQsXHJcbiAgICAgICAgICBmaW5hbFByaWNlQnJlYWtkb3duLm9yaWdpbmFsQW1vdW50IHx8IDAsXHJcbiAgICAgICAgICBmaW5hbFRvdGFsQW1vdW50XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZUFuZEdlbmVyYXRlVGlja2V0cyhvcmRlciwgZXZlbnQsIHVzZXIsIHRpY2tldFR5cGUpO1xyXG4gICAgfVxyXG5cclxuICAgIFxuICAgIGNvbnN0IHNlc3Npb25JZCA9IGdlbmVyYXRlU2hvcnRTZXNzaW9uSWQoXCJzZXNzXCIpO1xyXG4gICAgY29uc3QgcmV0dXJuVXJsID0gYCR7cHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfQVBQX1VSTH0vYXBpL3RyYW5zYmFuay9yZXR1cm5gO1xyXG5cclxuICAgIGNvbnN0IHRyYW5zYmFua1Jlc3BvbnNlID0gYXdhaXQgd2VicGF5UGx1cy5jcmVhdGUoXHJcbiAgICAgIG9yZGVyLm9yZGVyTnVtYmVyLFxyXG4gICAgICBzZXNzaW9uSWQsXHJcbiAgICAgIGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgIHJldHVyblVybFxyXG4gICAgKTtcclxuXHJcbiAgICBhd2FpdCBwcmlzbWEucGF5bWVudC5jcmVhdGUoe1xyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgb3JkZXJJZDogb3JkZXIuaWQsXHJcbiAgICAgICAgdHJhbnNhY3Rpb25JZDogc2Vzc2lvbklkLFxyXG4gICAgICAgIHRva2VuOiB0cmFuc2JhbmtSZXNwb25zZS50b2tlbixcclxuICAgICAgICBhbW91bnQ6IGZpbmFsVG90YWxBbW91bnQsXHJcbiAgICAgICAgY3VycmVuY3k6IGV2ZW50LmN1cnJlbmN5LFxyXG4gICAgICAgIHN0YXR1czogXCJQRU5ESU5HXCIsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBcbiAgICBpZiAoZGlzY291bnRDb2RlVmFsaWRhdGlvbiAmJiBkaXNjb3VudENvZGVWYWxpZGF0aW9uLmlzVmFsaWQpIHtcclxuICAgICAgXG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKGBbRElTQ09VTlRdIEPDs2RpZ28gJHtwcm9tb0NvZGV9ICgke2Rpc2NvdW50Q29kZVZhbGlkYXRpb24udHlwZX0pIHF1ZWRhcsOhIHBlbmRpZW50ZSBwYXJhIGFwbGljYXIgdHJhcyBwYWdvIGV4aXRvc29gKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICBvcmRlcklkOiBvcmRlci5pZCxcclxuICAgICAgcGF5bWVudFVybDogdHJhbnNiYW5rUmVzcG9uc2UudXJsLFxyXG4gICAgICB0b2tlbjogdHJhbnNiYW5rUmVzcG9uc2UudG9rZW4sXHJcbiAgICAgIHByaWNlQnJlYWtkb3duOiB7XHJcbiAgICAgICAgb3JpZ2luYWxBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24ub3JpZ2luYWxBbW91bnQsXHJcbiAgICAgICAgZGlzY291bnRBbW91bnQ6IGZpbmFsUHJpY2VCcmVha2Rvd24uZGlzY291bnRBbW91bnQsXHJcbiAgICAgICAgYmFzZUFtb3VudDogZmluYWxQcmljZUJyZWFrZG93bi5iYXNlUHJpY2UsXHJcbiAgICAgICAgY29tbWlzc2lvbjogZmluYWxQcmljZUJyZWFrZG93bi5jb21taXNzaW9uLFxyXG4gICAgICAgIHRvdGFsQW1vdW50OiBmaW5hbFRvdGFsQW1vdW50LFxyXG4gICAgICAgIHByb21vQ29kZTogcHJvbW9Db2RlIHx8IG51bGxcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiPT09IEVSUk9SIEdFTkVSQUwgRU4gQ1JFQUNJw5NOIERFIFBBR08gPT09XCIsIGVycm9yKTtcclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAge1xyXG4gICAgICAgIGVycm9yOiBcIkVycm9yIGludGVybm8gZGVsIHNlcnZpZG9yXCIsXHJcbiAgICAgICAgZGV0YWlsczogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIkVycm9yIGRlc2Nvbm9jaWRvXCIsXHJcbiAgICAgIH0sXHJcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUFuZEdlbmVyYXRlVGlja2V0cyhvcmRlcjogT3JkZXIsIGV2ZW50OiBFdmVudCwgdXNlcjogVXNlciwgdGlja2V0VHlwZTogVGlja2V0VHlwZSkge1xyXG4gIGNvbnNvbGUubG9nKGBHZW5lcmFuZG8gdGlja2V0cyBwYXJhIGxhIG9yZGVuICR7b3JkZXIub3JkZXJOdW1iZXJ9YCk7XHJcblxyXG4gIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgY29uc3QgdGlja2V0c0RhdGEgPSBbXTtcclxuICBcclxuICBjb25zdCB0b3RhbFRpY2tldHNUb0dlbmVyYXRlID0gb3JkZXIucXVhbnRpdHkgKiB0aWNrZXRUeXBlLnRpY2tldHNHZW5lcmF0ZWQ7XHJcblxyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdG90YWxUaWNrZXRzVG9HZW5lcmF0ZTsgaSsrKSB7XHJcbiAgICBjb25zdCBxckNvZGUgPSBnZW5lcmF0ZVVuaXF1ZVFSQ29kZShldmVudC5pZCwgdXNlci5pZCwgdGltZXN0YW1wLCBpKTtcclxuICAgIHRpY2tldHNEYXRhLnB1c2goe1xyXG4gICAgICBxckNvZGUsXHJcbiAgICAgIGV2ZW50SWQ6IGV2ZW50LmlkLFxyXG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXHJcbiAgICAgIG9yZGVySWQ6IG9yZGVyLmlkLFxyXG4gICAgICB0aWNrZXRUeXBlSWQ6IHRpY2tldFR5cGUuaWQsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHRyYW5zYWN0aW9uUmVzdWx0ID0gYXdhaXQgcHJpc21hLiR0cmFuc2FjdGlvbihbXHJcbiAgICBwcmlzbWEudGlja2V0LmNyZWF0ZU1hbnkoeyBkYXRhOiB0aWNrZXRzRGF0YSB9KSxcclxuICAgIHByaXNtYS5vcmRlci51cGRhdGUoe1xyXG4gICAgICB3aGVyZTogeyBpZDogb3JkZXIuaWQgfSxcclxuICAgICAgZGF0YTogeyBzdGF0dXM6IFwiUEFJRFwiIH0sXHJcbiAgICAgIGluY2x1ZGU6IHsgdGlja2V0czogdHJ1ZSB9XHJcbiAgICB9KSxcclxuICBdKTtcclxuXHJcbiAgY29uc3QgdXBkYXRlZE9yZGVyID0gdHJhbnNhY3Rpb25SZXN1bHRbMV07XHJcbiAgY29uc29sZS5sb2coYCR7dGlja2V0c0RhdGEubGVuZ3RofSB0aWNrZXRzIGdlbmVyYWRvcy5gKTtcclxuXHJcbiAgY29uc3QgZXZlbnRXaXRoT3JnYW5pemVyID0gYXdhaXQgcHJpc21hLmV2ZW50LmZpbmRVbmlxdWUoe1xyXG4gICAgd2hlcmU6IHsgaWQ6IGV2ZW50LmlkIH0sXHJcbiAgICBpbmNsdWRlOiB7IG9yZ2FuaXplcjogdHJ1ZSB9XHJcbiAgfSk7XHJcblxyXG4gIGlmIChldmVudFdpdGhPcmdhbml6ZXIgJiYgdXNlci5maXJzdE5hbWUpIHtcclxuICAgIGF3YWl0IHNlbmRUaWNrZXRFbWFpbCh7XHJcbiAgICAgIHVzZXJFbWFpbDogdXNlci5lbWFpbCxcclxuICAgICAgdXNlck5hbWU6IHVzZXIuZmlyc3ROYW1lLFxyXG4gICAgICBldmVudFRpdGxlOiBldmVudFdpdGhPcmdhbml6ZXIudGl0bGUsXHJcbiAgICAgIGV2ZW50RGF0ZTogZXZlbnRXaXRoT3JnYW5pemVyLnN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLFxyXG4gICAgICBldmVudExvY2F0aW9uOiBldmVudFdpdGhPcmdhbml6ZXIubG9jYXRpb24sXHJcbiAgICAgIG9yZGVyTnVtYmVyOiB1cGRhdGVkT3JkZXIuaWQsXHJcbiAgICAgIHRpY2tldHM6IHVwZGF0ZWRPcmRlci50aWNrZXRzLm1hcCh0aWNrZXQgPT4gKHtcclxuICAgICAgICBxckNvZGU6IHRpY2tldC5xckNvZGUhLFxyXG4gICAgICAgIHFyQ29kZUltYWdlOiBgZGF0YTppbWFnZS9wbmc7YmFzZTY0LCR7dGlja2V0LnFyQ29kZX1gIFxuICAgICAgfSkpXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XHJcbiAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgb3JkZXJJZDogb3JkZXIuaWQsXHJcbiAgICBpc0ZyZWU6IHRydWUsXHJcbiAgICB0aWNrZXRzR2VuZXJhdGVkOiB0b3RhbFRpY2tldHNUb0dlbmVyYXRlLFxyXG4gIH0pO1xyXG59Il0sInZlcnNpb24iOjN9