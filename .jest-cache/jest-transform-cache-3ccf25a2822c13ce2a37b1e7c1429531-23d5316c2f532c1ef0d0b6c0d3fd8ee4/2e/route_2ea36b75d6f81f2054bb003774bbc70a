7ae4546942b61b592f9b67a07e91832d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GET = GET;
exports.POST = POST;
const server_1 = require("next/server");
const prisma_1 = require("@/lib/prisma");
const auth_1 = require("@/lib/auth");
const zod_1 = require("zod");
const createInvitationSchema = zod_1.z.object({
    invitedEmail: zod_1.z.string().email("Email inválido"),
    invitedName: zod_1.z.string().min(1, "Nombre requerido").optional(),
    message: zod_1.z.string().optional(),
});
const bulkCreateInvitationSchema = zod_1.z.object({
    invitations: zod_1.z.array(createInvitationSchema).min(1, "Al menos una invitación es requerida").max(50, "Máximo 50 invitaciones por lote"),
});
async function GET(request, { params }) {
    try {
        const { id: eventId } = await params;
        const user = await (0, auth_1.getCurrentUser)();
        if (!user) {
            return server_1.NextResponse.json({ error: 'No autorizado' }, { status: 401 });
        }
        const event = await prisma_1.prisma.event.findUnique({
            where: { id: eventId },
            include: {
                organizer: true,
            },
        });
        if (!event) {
            return server_1.NextResponse.json({ error: 'Evento no encontrado' }, { status: 404 });
        }
        const isOwner = event.organizerId === user.id;
        const isAdmin = user.role === 'ADMIN';
        if (!isOwner && !isAdmin) {
            return server_1.NextResponse.json({ error: 'No autorizado' }, { status: 403 });
        }
        const invitations = await prisma_1.prisma.courtesyInvitation.findMany({
            where: { eventId },
            include: {
                ticket: {
                    select: {
                        id: true,
                        qrCode: true,
                        isUsed: true,
                        usedAt: true,
                    },
                },
                creator: {
                    select: {
                        firstName: true,
                        lastName: true,
                        email: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
        });
        console.log('Invitations fetched:', invitations.length);
        if (invitations.length > 0) {
            console.log('Sample invitation:', JSON.stringify(invitations[0], null, 2));
        }
        return server_1.NextResponse.json({
            event: {
                id: event.id,
                title: event.title,
            },
            invitations,
        });
    }
    catch (error) {
        console.error("Error fetching courtesy invitations:", error);
        return server_1.NextResponse.json({ error: "Error interno del servidor" }, { status: 500 });
    }
}
async function POST(request, { params }) {
    try {
        const { id: eventId } = await params;
        const user = await (0, auth_1.getCurrentUser)();
        if (!user) {
            return server_1.NextResponse.json({ error: 'No autorizado' }, { status: 401 });
        }
        const event = await prisma_1.prisma.event.findUnique({
            where: { id: eventId },
            include: {
                organizer: true,
            },
        });
        if (!event) {
            return server_1.NextResponse.json({ error: 'Evento no encontrado' }, { status: 404 });
        }
        const isOwner = event.organizerId === user.id;
        const isAdmin = user.role === 'ADMIN';
        if (!isOwner && !isAdmin) {
            return server_1.NextResponse.json({ error: 'No autorizado' }, { status: 403 });
        }
        const body = await request.json();
        let invitationsToCreate = [];
        if (body.invitations) {
            const validation = bulkCreateInvitationSchema.parse(body);
            invitationsToCreate = validation.invitations;
        }
        else {
            const validation = createInvitationSchema.parse(body);
            invitationsToCreate = [validation];
        }
        const existingEmails = await prisma_1.prisma.courtesyInvitation.findMany({
            where: {
                eventId,
                invitedEmail: {
                    in: invitationsToCreate.map(inv => inv.invitedEmail.toLowerCase()),
                },
            },
            select: { invitedEmail: true },
        });
        if (existingEmails.length > 0) {
            const duplicateEmails = existingEmails.map(e => e.invitedEmail);
            return server_1.NextResponse.json({
                error: "Algunos emails ya están invitados a este evento",
                duplicateEmails
            }, { status: 400 });
        }
        const createdInvitations = await prisma_1.prisma.$transaction(invitationsToCreate.map((invitation) => prisma_1.prisma.courtesyInvitation.create({
            data: {
                eventId,
                invitedEmail: invitation.invitedEmail.toLowerCase(),
                invitedName: invitation.invitedName,
                message: invitation.message,
                createdBy: user.id,
                invitationCode: generateInvitationCode(),
                expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
            },
            include: {
                creator: {
                    select: {
                        firstName: true,
                        lastName: true,
                        email: true,
                    },
                },
            },
        })));
        return server_1.NextResponse.json({
            message: `${createdInvitations.length} invitación(es) creada(s) exitosamente`,
            invitations: createdInvitations,
        }, { status: 201 });
    }
    catch (error) {
        if (error instanceof zod_1.z.ZodError) {
            return server_1.NextResponse.json({ error: "Datos inválidos", details: error.issues }, { status: 400 });
        }
        console.error("Error creating courtesy invitations:", error);
        return server_1.NextResponse.json({ error: "Error interno del servidor" }, { status: 500 });
    }
}
function generateInvitationCode() {
    return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxcZXZlbnRzXFxbaWRdXFxpbnZpdGF0aW9uc1xccm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7QUF3QkEsa0JBd0VDO0FBR0Qsb0JBa0hDO0FBck5ELHdDQUF3RDtBQUN4RCx5Q0FBc0M7QUFDdEMscUNBQTRDO0FBQzVDLDZCQUF3QjtBQUd4QixNQUFNLHNCQUFzQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDdEMsWUFBWSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7SUFDaEQsV0FBVyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGtCQUFrQixDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzdELE9BQU8sRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQy9CLENBQUMsQ0FBQztBQUdILE1BQU0sMEJBQTBCLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMxQyxXQUFXLEVBQUUsT0FBQyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsc0NBQXNDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLGlDQUFpQyxDQUFDO0NBQ3ZJLENBQUMsQ0FBQztBQVNJLEtBQUssVUFBVSxHQUFHLENBQUMsT0FBb0IsRUFBRSxFQUFFLE1BQU0sRUFBZTtJQUNyRSxJQUFJLENBQUM7UUFDSCxNQUFNLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sTUFBTSxDQUFDO1FBQ3JDLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBQSxxQkFBYyxHQUFFLENBQUM7UUFFcEMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFB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TSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ25HLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxhcHBcXGFwaVxcZXZlbnRzXFxbaWRdXFxpbnZpdGF0aW9uc1xccm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xyXG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tIFwiQC9saWIvcHJpc21hXCI7XHJcbmltcG9ydCB7IGdldEN1cnJlbnRVc2VyIH0gZnJvbSBcIkAvbGliL2F1dGhcIjtcclxuaW1wb3J0IHsgeiB9IGZyb20gXCJ6b2RcIjtcclxuXHJcblxyXG5jb25zdCBjcmVhdGVJbnZpdGF0aW9uU2NoZW1hID0gei5vYmplY3Qoe1xyXG4gIGludml0ZWRFbWFpbDogei5zdHJpbmcoKS5lbWFpbChcIkVtYWlsIGludsOhbGlkb1wiKSxcclxuICBpbnZpdGVkTmFtZTogei5zdHJpbmcoKS5taW4oMSwgXCJOb21icmUgcmVxdWVyaWRvXCIpLm9wdGlvbmFsKCksXHJcbiAgbWVzc2FnZTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxyXG59KTtcclxuXHJcblxyXG5jb25zdCBidWxrQ3JlYXRlSW52aXRhdGlvblNjaGVtYSA9IHoub2JqZWN0KHtcclxuICBpbnZpdGF0aW9uczogei5hcnJheShjcmVhdGVJbnZpdGF0aW9uU2NoZW1hKS5taW4oMSwgXCJBbCBtZW5vcyB1bmEgaW52aXRhY2nDs24gZXMgcmVxdWVyaWRhXCIpLm1heCg1MCwgXCJNw6F4aW1vIDUwIGludml0YWNpb25lcyBwb3IgbG90ZVwiKSxcclxufSk7XHJcblxyXG5pbnRlcmZhY2UgUm91dGVQYXJhbXMge1xyXG4gIHBhcmFtczogUHJvbWlzZTx7XHJcbiAgICBpZDogc3RyaW5nO1xyXG4gIH0+O1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdFVChyZXF1ZXN0OiBOZXh0UmVxdWVzdCwgeyBwYXJhbXMgfTogUm91dGVQYXJhbXMpIHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBpZDogZXZlbnRJZCB9ID0gYXdhaXQgcGFyYW1zO1xyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IGdldEN1cnJlbnRVc2VyKCk7XHJcblxyXG4gICAgaWYgKCF1c2VyKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnTm8gYXV0b3JpemFkbycgfSwgeyBzdGF0dXM6IDQwMSB9KTtcclxuICAgIH1cclxuXHJcbiAgICBcclxuICAgIGNvbnN0IGV2ZW50ID0gYXdhaXQgcHJpc21hLmV2ZW50LmZpbmRVbmlxdWUoe1xyXG4gICAgICB3aGVyZTogeyBpZDogZXZlbnRJZCB9LFxyXG4gICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgb3JnYW5pemVyOiB0cnVlLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFldmVudCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0V2ZW50byBubyBlbmNvbnRyYWRvJyB9LCB7IHN0YXR1czogNDA0IH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlzT3duZXIgPSBldmVudC5vcmdhbml6ZXJJZCA9PT0gdXNlci5pZDtcclxuICAgIGNvbnN0IGlzQWRtaW4gPSB1c2VyLnJvbGUgPT09ICdBRE1JTic7XHJcblxyXG4gICAgaWYgKCFpc093bmVyICYmICFpc0FkbWluKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnTm8gYXV0b3JpemFkbycgfSwgeyBzdGF0dXM6IDQwMyB9KTtcclxuICAgIH1cclxuXHJcbiAgICBcclxuICAgIGNvbnN0IGludml0YXRpb25zID0gYXdhaXQgcHJpc21hLmNvdXJ0ZXN5SW52aXRhdGlvbi5maW5kTWFueSh7XHJcbiAgICAgIHdoZXJlOiB7IGV2ZW50SWQgfSxcclxuICAgICAgaW5jbHVkZToge1xyXG4gICAgICAgIHRpY2tldDoge1xyXG4gICAgICAgICAgc2VsZWN0OiB7XHJcbiAgICAgICAgICAgIGlkOiB0cnVlLFxyXG4gICAgICAgICAgICBxckNvZGU6IHRydWUsXHJcbiAgICAgICAgICAgIGlzVXNlZDogdHJ1ZSxcclxuICAgICAgICAgICAgdXNlZEF0OiB0cnVlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNyZWF0b3I6IHtcclxuICAgICAgICAgIHNlbGVjdDoge1xyXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXHJcbiAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxyXG4gICAgICAgICAgICBlbWFpbDogdHJ1ZSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgfSxcclxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgXHJcbiAgICBjb25zb2xlLmxvZygnSW52aXRhdGlvbnMgZmV0Y2hlZDonLCBpbnZpdGF0aW9ucy5sZW5ndGgpO1xyXG4gICAgaWYgKGludml0YXRpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc29sZS5sb2coJ1NhbXBsZSBpbnZpdGF0aW9uOicsIEpTT04uc3RyaW5naWZ5KGludml0YXRpb25zWzBdLCBudWxsLCAyKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcclxuICAgICAgZXZlbnQ6IHtcclxuICAgICAgICBpZDogZXZlbnQuaWQsXHJcbiAgICAgICAgdGl0bGU6IGV2ZW50LnRpdGxlLFxyXG4gICAgICB9LFxyXG4gICAgICBpbnZpdGF0aW9ucyxcclxuICAgIH0pO1xyXG5cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGZldGNoaW5nIGNvdXJ0ZXN5IGludml0YXRpb25zOlwiLCBlcnJvcik7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgIHsgZXJyb3I6IFwiRXJyb3IgaW50ZXJubyBkZWwgc2Vydmlkb3JcIiB9LFxyXG4gICAgICB7IHN0YXR1czogNTAwIH1cclxuICAgICk7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxdWVzdDogTmV4dFJlcXVlc3QsIHsgcGFyYW1zIH06IFJvdXRlUGFyYW1zKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgaWQ6IGV2ZW50SWQgfSA9IGF3YWl0IHBhcmFtcztcclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBnZXRDdXJyZW50VXNlcigpO1xyXG5cclxuICAgIGlmICghdXNlcikge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ05vIGF1dG9yaXphZG8nIH0sIHsgc3RhdHVzOiA0MDEgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgXHJcbiAgICBjb25zdCBldmVudCA9IGF3YWl0IHByaXNtYS5ldmVudC5maW5kVW5pcXVlKHtcclxuICAgICAgd2hlcmU6IHsgaWQ6IGV2ZW50SWQgfSxcclxuICAgICAgaW5jbHVkZToge1xyXG4gICAgICAgIG9yZ2FuaXplcjogdHJ1ZSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghZXZlbnQpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdFdmVudG8gbm8gZW5jb250cmFkbycgfSwgeyBzdGF0dXM6IDQwNCB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpc093bmVyID0gZXZlbnQub3JnYW5pemVySWQgPT09IHVzZXIuaWQ7XHJcbiAgICBjb25zdCBpc0FkbWluID0gdXNlci5yb2xlID09PSAnQURNSU4nO1xyXG5cclxuICAgIGlmICghaXNPd25lciAmJiAhaXNBZG1pbikge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ05vIGF1dG9yaXphZG8nIH0sIHsgc3RhdHVzOiA0MDMgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpO1xyXG4gICAgXHJcbiAgICBcclxuICAgIGxldCBpbnZpdGF0aW9uc1RvQ3JlYXRlOiBBcnJheTx7XHJcbiAgICAgIGludml0ZWRFbWFpbDogc3RyaW5nO1xyXG4gICAgICBpbnZpdGVkTmFtZT86IHN0cmluZztcclxuICAgICAgbWVzc2FnZT86IHN0cmluZztcclxuICAgIH0+ID0gW107XHJcblxyXG4gICAgaWYgKGJvZHkuaW52aXRhdGlvbnMpIHtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBidWxrQ3JlYXRlSW52aXRhdGlvblNjaGVtYS5wYXJzZShib2R5KTtcclxuICAgICAgaW52aXRhdGlvbnNUb0NyZWF0ZSA9IHZhbGlkYXRpb24uaW52aXRhdGlvbnM7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBcclxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGNyZWF0ZUludml0YXRpb25TY2hlbWEucGFyc2UoYm9keSk7XHJcbiAgICAgIGludml0YXRpb25zVG9DcmVhdGUgPSBbdmFsaWRhdGlvbl07XHJcbiAgICB9XHJcblxyXG4gICAgXHJcbiAgICBjb25zdCBleGlzdGluZ0VtYWlscyA9IGF3YWl0IHByaXNtYS5jb3VydGVzeUludml0YXRpb24uZmluZE1hbnkoe1xyXG4gICAgICB3aGVyZToge1xyXG4gICAgICAgIGV2ZW50SWQsXHJcbiAgICAgICAgaW52aXRlZEVtYWlsOiB7XHJcbiAgICAgICAgICBpbjogaW52aXRhdGlvbnNUb0NyZWF0ZS5tYXAoaW52ID0+IGludi5pbnZpdGVkRW1haWwudG9Mb3dlckNhc2UoKSksXHJcbiAgICAgICAgfSxcclxuICAgICAgfSxcclxuICAgICAgc2VsZWN0OiB7IGludml0ZWRFbWFpbDogdHJ1ZSB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGV4aXN0aW5nRW1haWxzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgZHVwbGljYXRlRW1haWxzID0gZXhpc3RpbmdFbWFpbHMubWFwKGUgPT4gZS5pbnZpdGVkRW1haWwpO1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBcclxuICAgICAgICAgIGVycm9yOiBcIkFsZ3Vub3MgZW1haWxzIHlhIGVzdMOhbiBpbnZpdGFkb3MgYSBlc3RlIGV2ZW50b1wiLFxyXG4gICAgICAgICAgZHVwbGljYXRlRW1haWxzIFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgXHJcbiAgICBjb25zdCBjcmVhdGVkSW52aXRhdGlvbnMgPSBhd2FpdCBwcmlzbWEuJHRyYW5zYWN0aW9uKFxyXG4gICAgICBpbnZpdGF0aW9uc1RvQ3JlYXRlLm1hcCgoaW52aXRhdGlvbikgPT5cclxuICAgICAgICBwcmlzbWEuY291cnRlc3lJbnZpdGF0aW9uLmNyZWF0ZSh7XHJcbiAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgIGV2ZW50SWQsXHJcbiAgICAgICAgICAgIGludml0ZWRFbWFpbDogaW52aXRhdGlvbi5pbnZpdGVkRW1haWwudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgaW52aXRlZE5hbWU6IGludml0YXRpb24uaW52aXRlZE5hbWUsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IGludml0YXRpb24ubWVzc2FnZSxcclxuICAgICAgICAgICAgY3JlYXRlZEJ5OiB1c2VyLmlkLFxyXG4gICAgICAgICAgICBpbnZpdGF0aW9uQ29kZTogZ2VuZXJhdGVJbnZpdGF0aW9uQ29kZSgpLFxyXG4gICAgICAgICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKERhdGUubm93KCkgKyAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApLCBcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgICAgIGNyZWF0b3I6IHtcclxuICAgICAgICAgICAgICBzZWxlY3Q6IHtcclxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICBtZXNzYWdlOiBgJHtjcmVhdGVkSW52aXRhdGlvbnMubGVuZ3RofSBpbnZpdGFjacOzbihlcykgY3JlYWRhKHMpIGV4aXRvc2FtZW50ZWAsXHJcbiAgICAgIGludml0YXRpb25zOiBjcmVhdGVkSW52aXRhdGlvbnMsXHJcbiAgICB9LCB7IHN0YXR1czogMjAxIH0pO1xyXG5cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2Ygei5ab2RFcnJvcikge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJEYXRvcyBpbnbDoWxpZG9zXCIsIGRldGFpbHM6IGVycm9yLmlzc3VlcyB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBjcmVhdGluZyBjb3VydGVzeSBpbnZpdGF0aW9uczpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICB7IGVycm9yOiBcIkVycm9yIGludGVybm8gZGVsIHNlcnZpZG9yXCIgfSxcclxuICAgICAgeyBzdGF0dXM6IDUwMCB9XHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlSW52aXRhdGlvbkNvZGUoKTogc3RyaW5nIHtcclxuICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDE1KSArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyLCAxNSk7XHJcbn1cclxuIl0sInZlcnNpb24iOjN9