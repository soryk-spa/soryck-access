de1f1c5add745c3c1a907e46b47bc2cf
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cache = exports.CacheService = void 0;
const ioredis_1 = require("ioredis");
const logger_1 = require("./logger");
const getRedisConfig = () => {
    if (process.env.REDIS_URL) {
        return {
            connectionName: 'vercel-redis',
            lazyConnect: true,
            retryDelayOnFailover: 100,
            enableReadyCheck: false,
            maxRetriesPerRequest: 3,
            connectTimeout: 60000,
            commandTimeout: 5000,
            keepAlive: 30000,
            family: 4,
            enableAutoPipelining: true,
            compression: 'gzip',
        };
    }
    return {
        host: process.env.REDIS_HOST || 'localhost',
        port: parseInt(process.env.REDIS_PORT || '6379'),
        password: process.env.REDIS_PASSWORD,
        db: parseInt(process.env.REDIS_DB || '0'),
        retryDelayOnFailover: 100,
        enableReadyCheck: false,
        maxRetriesPerRequest: 3,
        lazyConnect: true,
        connectTimeout: 60000,
        commandTimeout: 5000,
        keepAlive: 30000,
        family: 4,
        enableAutoPipelining: true,
    };
};
const redis = process.env.REDIS_URL
    ? new ioredis_1.Redis(process.env.REDIS_URL, getRedisConfig())
    : new ioredis_1.Redis(getRedisConfig());
redis.on('connect', () => {
    logger_1.logger.info('✅ Redis connected successfully');
});
redis.on('error', (error) => {
    logger_1.logger.error('❌ Redis connection error', error);
});
redis.on('close', () => {
    logger_1.logger.info('🔌 Redis connection closed');
});
class CacheService {
    constructor() {
        this.redis = redis;
    }
    static getInstance() {
        if (!CacheService.instance) {
            CacheService.instance = new CacheService();
        }
        return CacheService.instance;
    }
    async get(key) {
        try {
            const cached = await this.redis.get(key);
            if (!cached)
                return null;
            // Try to parse as JSON, if it fails, return the string directly
            try {
                return JSON.parse(cached);
            }
            catch (_a) {
                // If it's not valid JSON, return the value directly
                return cached;
            }
        }
        catch (error) {
            logger_1.logger.error(`Error getting cache key ${key}`, error);
            return null;
        }
    }
    async set(key, value, ttlSeconds) {
        try {
            const serialized = JSON.stringify(value);
            if (ttlSeconds) {
                await this.redis.setex(key, ttlSeconds, serialized);
            }
            else {
                await this.redis.set(key, serialized);
            }
        }
        catch (error) {
            logger_1.logger.error(`Error setting cache key ${key}`, error);
        }
    }
    async del(key) {
        try {
            await this.redis.del(key);
        }
        catch (error) {
            logger_1.logger.error(`Error deleting cache key ${key}`, error);
        }
    }
    async invalidatePattern(pattern) {
        try {
            const keys = await this.redis.keys(pattern);
            if (keys.length > 0) {
                await this.redis.del(...keys);
            }
        }
        catch (error) {
            logger_1.logger.error(`Error invalidating pattern ${pattern}`, error);
        }
    }
    async getUserRole(clerkId) {
        return this.get(`user:role:${clerkId}`);
    }
    async setUserRole(clerkId, role, ttl = 3600) {
        await this.set(`user:role:${clerkId}`, role, ttl);
    }
    async getUserProfile(clerkId) {
        return this.get(`user:profile:${clerkId}`);
    }
    async setUserProfile(clerkId, profile, ttl = 1800) {
        await this.set(`user:profile:${clerkId}`, profile, ttl);
    }
    async getUserFullData(clerkId) {
        return this.get(`user:full:${clerkId}`);
    }
    async setUserFullData(clerkId, userData, ttl = 3600) {
        await this.set(`user:full:${clerkId}`, userData, ttl);
    }
    async getUserPermissions(clerkId) {
        return this.get(`user:permissions:${clerkId}`);
    }
    async setUserPermissions(clerkId, permissions, ttl = 3600) {
        await this.set(`user:permissions:${clerkId}`, permissions, ttl);
    }
    async setUserBatch(clerkId, userData, ttl = 3600) {
        const pipeline = this.redis.pipeline();
        pipeline.setex(`user:full:${clerkId}`, ttl, JSON.stringify(userData));
        pipeline.setex(`user:role:${clerkId}`, ttl, userData.role);
        pipeline.setex(`user:profile:${clerkId}`, ttl, JSON.stringify(userData));
        await pipeline.exec();
    }
    async invalidateUserCache(clerkId) {
        await this.invalidatePattern(`user:*:${clerkId}`);
    }
    async getEvents(query) {
        return this.get(`events:${query}`);
    }
    async setEvents(query, events, ttl = 600) {
        await this.set(`events:${query}`, events, ttl);
    }
    async invalidateEventsCache() {
        await this.invalidatePattern('events:*');
    }
    async getDashboardStats(userId) {
        return this.get(`dashboard:stats:${userId}`);
    }
    async setDashboardStats(userId, stats, ttl = 300) {
        await this.set(`dashboard:stats:${userId}`, stats, ttl);
    }
    async invalidateDashboardStats(userId) {
        if (userId) {
            await this.del(`dashboard:stats:${userId}`);
        }
        else {
            await this.invalidatePattern('dashboard:stats:*');
        }
    }
    async incrementRateLimit(key, windowSeconds, limit) {
        try {
            const current = await this.redis.incr(key);
            if (current === 1) {
                await this.redis.expire(key, windowSeconds);
            }
            return {
                allowed: current <= limit,
                remaining: Math.max(0, limit - current)
            };
        }
        catch (error) {
            logger_1.logger.error(`Error checking rate limit for ${key}`, error);
            return { allowed: true, remaining: limit };
        }
    }
    async setSession(sessionId, data, ttl = 86400) {
        await this.set(`session:${sessionId}`, data, ttl);
    }
    async getSession(sessionId) {
        return this.get(`session:${sessionId}`);
    }
    async deleteSession(sessionId) {
        await this.del(`session:${sessionId}`);
    }
    async ping() {
        try {
            const response = await this.redis.ping();
            return response === 'PONG';
        }
        catch (error) {
            logger_1.logger.error('Redis ping failed', error);
            return false;
        }
    }
    async disconnect() {
        try {
            await this.redis.quit();
        }
        catch (error) {
            logger_1.logger.error('Error disconnecting from Redis:', error);
        }
    }
}
exports.CacheService = CacheService;
exports.cache = CacheService.getInstance();
exports.default = redis;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxCaWx1clxcRG9jdW1lbnRzXFxEZXZlbG9wbWVudFxcTmV4dFxcc29yeWNrLWFjY2Vzc1xcc3JjXFxsaWJcXHJlZGlzLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFnQztBQUNoQyxxQ0FBa0M7QUE0Q2xDLE1BQU0sY0FBYyxHQUFHLEdBQUcsRUFBRTtJQUUxQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDMUIsT0FBTztZQUNMLGNBQWMsRUFBRSxjQUFjO1lBQzlCLFdBQVcsRUFBRSxJQUFJO1lBQ2pCLG9CQUFvQixFQUFFLEdBQUc7WUFDekIsZ0JBQWdCLEVBQUUsS0FBSztZQUN2QixvQkFBb0IsRUFBRSxDQUFDO1lBRXZCLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLGNBQWMsRUFBRSxJQUFJO1lBQ3BCLFNBQVMsRUFBRSxLQUFLO1lBRWhCLE1BQU0sRUFBRSxDQUFDO1lBRVQsb0JBQW9CLEVBQUUsSUFBSTtZQUUxQixXQUFXLEVBQUUsTUFBTTtTQUNwQixDQUFDO0lBQ0osQ0FBQztJQUdELE9BQU87UUFDTCxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVztRQUMzQyxJQUFJLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQztRQUNoRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1FBQ3BDLEVBQUUsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDO1FBQ3pDLG9CQUFvQixFQUFFLEdBQUc7UUFDekIsZ0JBQWdCLEVBQUUsS0FBSztRQUN2QixvQkFBb0IsRUFBRSxDQUFDO1FBQ3ZCLFdBQVcsRUFBRSxJQUFJO1FBRWpCLGNBQWMsRUFBRSxLQUFLO1FBQ3JCLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLFNBQVMsRUFBRSxLQUFLO1FBRWhCLE1BQU0sRUFBRSxDQUFDO1FBRVQsb0JBQW9CLEVB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QUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBR0QsS0FBSyxDQUFDLElBQUk7UUFDUixJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDekMsT0FBTyxRQUFRLEtBQUssTUFBTSxDQUFDO1FBQzdCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ25CLGVBQU0sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsS0FBYyxDQUFDLENBQUM7WUFDOUMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUdELEtBQUssQ0FBQyxVQUFVO1FBQ2QsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ25CLGVBQU0sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBYyxDQUFDLENBQUM7UUFDOUQsQ0FBQztJQUNILENBQUM7Q0FDRjtBQS9MRCxvQ0ErTEM7QUFHWSxRQUFBLEtBQUssR0FBRyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDaEQsa0JBQWUsS0FBSyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcQmlsdXJcXERvY3VtZW50c1xcRGV2ZWxvcG1lbnRcXE5leHRcXHNvcnljay1hY2Nlc3NcXHNyY1xcbGliXFxyZWRpcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZWRpcyB9IGZyb20gJ2lvcmVkaXMnO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlcic7XHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBVc2VyUHJvZmlsZSB7XHJcbiAgaWQ6IHN0cmluZztcclxuICBjbGVya0lkOiBzdHJpbmc7XHJcbiAgZW1haWw6IHN0cmluZztcclxuICBmaXJzdE5hbWU/OiBzdHJpbmc7XHJcbiAgbGFzdE5hbWU/OiBzdHJpbmc7XHJcbiAgYmlvPzogc3RyaW5nO1xyXG4gIHByb2R1Y2VyTmFtZT86IHN0cmluZztcclxuICB3ZWJzaXRlVXJsPzogc3RyaW5nO1xyXG4gIHR3aXR0ZXJVcmw/OiBzdHJpbmc7XHJcbiAgaW5zdGFncmFtVXJsPzogc3RyaW5nO1xyXG4gIHJvbGU6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBVc2VyUGVybWlzc2lvbnMge1xyXG4gIGNhbkNyZWF0ZUV2ZW50czogYm9vbGVhbjtcclxuICBjYW5BY2Nlc3NBZG1pbjogYm9vbGVhbjtcclxuICBjYW5TY2FuVGlja2V0czogYm9vbGVhbjtcclxuICBjYW5NYW5hZ2VVc2VyczogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBNb250aGx5U3RhdHMge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICBpbmdyZXNvczogbnVtYmVyO1xyXG4gIGV2ZW50b3M6IG51bWJlcjtcclxuICB0aWNrZXRzOiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIERhc2hib2FyZFN0YXRzID0gTW9udGhseVN0YXRzW107XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50RGF0YSB7XHJcbiAgaWQ6IHN0cmluZztcclxuICB0aXRsZTogc3RyaW5nO1xyXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xyXG4gIHN0YXJ0RGF0ZTogRGF0ZTtcclxuICBlbmREYXRlOiBEYXRlO1xyXG4gIGNhdGVnb3J5SWQ6IHN0cmluZztcclxuICBvcmdhbml6ZXJJZDogc3RyaW5nO1xyXG59XHJcblxyXG5cclxuY29uc3QgZ2V0UmVkaXNDb25maWcgPSAoKSA9PiB7XHJcbiAgXHJcbiAgaWYgKHByb2Nlc3MuZW52LlJFRElTX1VSTCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgY29ubmVjdGlvbk5hbWU6ICd2ZXJjZWwtcmVkaXMnLFxyXG4gICAgICBsYXp5Q29ubmVjdDogdHJ1ZSxcclxuICAgICAgcmV0cnlEZWxheU9uRmFpbG92ZXI6IDEwMCxcclxuICAgICAgZW5hYmxlUmVhZHlDaGVjazogZmFsc2UsXHJcbiAgICAgIG1heFJldHJpZXNQZXJSZXF1ZXN0OiAzLFxyXG4gICAgICBcclxuICAgICAgY29ubmVjdFRpbWVvdXQ6IDYwMDAwLFxyXG4gICAgICBjb21tYW5kVGltZW91dDogNTAwMCxcclxuICAgICAga2VlcEFsaXZlOiAzMDAwMCxcclxuICAgICAgXHJcbiAgICAgIGZhbWlseTogNCxcclxuICAgICAgXHJcbiAgICAgIGVuYWJsZUF1dG9QaXBlbGluaW5nOiB0cnVlLFxyXG4gICAgICBcclxuICAgICAgY29tcHJlc3Npb246ICdnemlwJyxcclxuICAgIH07XHJcbiAgfVxyXG4gIFxyXG4gIFxyXG4gIHJldHVybiB7XHJcbiAgICBob3N0OiBwcm9jZXNzLmVudi5SRURJU19IT1NUIHx8ICdsb2NhbGhvc3QnLFxyXG4gICAgcG9ydDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfUE9SVCB8fCAnNjM3OScpLFxyXG4gICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LlJFRElTX1BBU1NXT1JELFxyXG4gICAgZGI6IHBhcnNlSW50KHByb2Nlc3MuZW52LlJFRElTX0RCIHx8ICcwJyksXHJcbiAgICByZXRyeURlbGF5T25GYWlsb3ZlcjogMTAwLFxyXG4gICAgZW5hYmxlUmVhZHlDaGVjazogZmFsc2UsXHJcbiAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdDogMyxcclxuICAgIGxhenlDb25uZWN0OiB0cnVlLFxyXG4gICAgXHJcbiAgICBjb25uZWN0VGltZW91dDogNjAwMDAsXHJcbiAgICBjb21tYW5kVGltZW91dDogNTAwMCxcclxuICAgIGtlZXBBbGl2ZTogMzAwMDAsXHJcbiAgICBcclxuICAgIGZhbWlseTogNCxcclxuICAgIFxyXG4gICAgZW5hYmxlQXV0b1BpcGVsaW5pbmc6IHRydWUsXHJcbiAgfTtcclxufTtcclxuXHJcblxyXG5jb25zdCByZWRpcyA9IHByb2Nlc3MuZW52LlJFRElTX1VSTCBcclxuICA/IG5ldyBSZWRpcyhwcm9jZXNzLmVudi5SRURJU19VUkwsIGdldFJlZGlzQ29uZmlnKCkpXHJcbiAgOiBuZXcgUmVkaXMoZ2V0UmVkaXNDb25maWcoKSk7XHJcblxyXG5cclxucmVkaXMub24oJ2Nvbm5lY3QnLCAoKSA9PiB7XHJcbiAgbG9nZ2VyLmluZm8oJ+KchSBSZWRpcyBjb25uZWN0ZWQgc3VjY2Vzc2Z1bGx5Jyk7XHJcbn0pO1xyXG5cclxucmVkaXMub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XHJcbiAgbG9nZ2VyLmVycm9yKCfinYwgUmVkaXMgY29ubmVjdGlvbiBlcnJvcicsIGVycm9yKTtcclxufSk7XHJcblxyXG5yZWRpcy5vbignY2xvc2UnLCAoKSA9PiB7XHJcbiAgbG9nZ2VyLmluZm8oJ/CflIwgUmVkaXMgY29ubmVjdGlvbiBjbG9zZWQnKTtcclxufSk7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIENhY2hlU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IENhY2hlU2VydmljZTtcclxuICBwcml2YXRlIHJlZGlzOiBSZWRpcztcclxuXHJcbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMucmVkaXMgPSByZWRpcztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogQ2FjaGVTZXJ2aWNlIHtcclxuICAgIGlmICghQ2FjaGVTZXJ2aWNlLmluc3RhbmNlKSB7XHJcbiAgICAgIENhY2hlU2VydmljZS5pbnN0YW5jZSA9IG5ldyBDYWNoZVNlcnZpY2UoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBDYWNoZVNlcnZpY2UuaW5zdGFuY2U7XHJcbiAgfVxyXG5cclxuICBcclxuICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCBudWxsPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCB0aGlzLnJlZGlzLmdldChrZXkpO1xyXG4gICAgICBpZiAoIWNhY2hlZCkgcmV0dXJuIG51bGw7XHJcbiAgICAgIFxyXG4gICAgICAvLyBUcnkgdG8gcGFyc2UgYXMgSlNPTiwgaWYgaXQgZmFpbHMsIHJldHVybiB0aGUgc3RyaW5nIGRpcmVjdGx5XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoY2FjaGVkKTtcclxuICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgLy8gSWYgaXQncyBub3QgdmFsaWQgSlNPTiwgcmV0dXJuIHRoZSB2YWx1ZSBkaXJlY3RseVxyXG4gICAgICAgIHJldHVybiBjYWNoZWQgYXMgVDtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGBFcnJvciBnZXR0aW5nIGNhY2hlIGtleSAke2tleX1gLCBlcnJvciBhcyBFcnJvcik7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2V0KGtleTogc3RyaW5nLCB2YWx1ZTogdW5rbm93biwgdHRsU2Vjb25kcz86IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcclxuICAgICAgaWYgKHR0bFNlY29uZHMpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLnNldGV4KGtleSwgdHRsU2Vjb25kcywgc2VyaWFsaXplZCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpcy5zZXQoa2V5LCBzZXJpYWxpemVkKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoYEVycm9yIHNldHRpbmcgY2FjaGUga2V5ICR7a2V5fWAsIGVycm9yIGFzIEVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGRlbChrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5kZWwoa2V5KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgbG9nZ2VyLmVycm9yKGBFcnJvciBkZWxldGluZyBjYWNoZSBrZXkgJHtrZXl9YCwgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgaW52YWxpZGF0ZVBhdHRlcm4ocGF0dGVybjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5yZWRpcy5rZXlzKHBhdHRlcm4pO1xyXG4gICAgICBpZiAoa2V5cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpcy5kZWwoLi4ua2V5cyk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgbG9nZ2VyLmVycm9yKGBFcnJvciBpbnZhbGlkYXRpbmcgcGF0dGVybiAke3BhdHRlcm59YCwgZXJyb3IgYXMgRXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgXHJcbiAgYXN5bmMgZ2V0VXNlclJvbGUoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHVzZXI6cm9sZToke2NsZXJrSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXRVc2VyUm9sZShjbGVya0lkOiBzdHJpbmcsIHJvbGU6IHN0cmluZywgdHRsID0gMzYwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zZXQoYHVzZXI6cm9sZToke2NsZXJrSWR9YCwgcm9sZSwgdHRsKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFVzZXJQcm9maWxlKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclByb2ZpbGUgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHVzZXI6cHJvZmlsZToke2NsZXJrSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXRVc2VyUHJvZmlsZShjbGVya0lkOiBzdHJpbmcsIHByb2ZpbGU6IFVzZXJQcm9maWxlLCB0dGwgPSAxODAwKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLnNldChgdXNlcjpwcm9maWxlOiR7Y2xlcmtJZH1gLCBwcm9maWxlLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgXHJcbiAgYXN5bmMgZ2V0VXNlckZ1bGxEYXRhKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclByb2ZpbGUgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHVzZXI6ZnVsbDoke2NsZXJrSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZXRVc2VyRnVsbERhdGEoY2xlcmtJZDogc3RyaW5nLCB1c2VyRGF0YTogVXNlclByb2ZpbGUsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGB1c2VyOmZ1bGw6JHtjbGVya0lkfWAsIHVzZXJEYXRhLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VXNlclBlcm1pc3Npb25zKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclBlcm1pc3Npb25zIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KGB1c2VyOnBlcm1pc3Npb25zOiR7Y2xlcmtJZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldFVzZXJQZXJtaXNzaW9ucyhjbGVya0lkOiBzdHJpbmcsIHBlcm1pc3Npb25zOiBVc2VyUGVybWlzc2lvbnMsIHR0bCA9IDM2MDApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuc2V0KGB1c2VyOnBlcm1pc3Npb25zOiR7Y2xlcmtJZH1gLCBwZXJtaXNzaW9ucywgdHRsKTtcclxuICB9XHJcblxyXG4gIFxyXG4gIGFzeW5jIHNldFVzZXJCYXRjaChjbGVya0lkOiBzdHJpbmcsIHVzZXJEYXRhOiBVc2VyUHJvZmlsZSwgdHRsID0gMzYwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgcGlwZWxpbmUgPSB0aGlzLnJlZGlzLnBpcGVsaW5lKCk7XHJcbiAgICBwaXBlbGluZS5zZXRleChgdXNlcjpmdWxsOiR7Y2xlcmtJZH1gLCB0dGwsIEpTT04uc3RyaW5naWZ5KHVzZXJEYXRhKSk7XHJcbiAgICBwaXBlbGluZS5zZXRleChgdXNlcjpyb2xlOiR7Y2xlcmtJZH1gLCB0dGwsIHVzZXJEYXRhLnJvbGUpO1xyXG4gICAgcGlwZWxpbmUuc2V0ZXgoYHVzZXI6cHJvZmlsZToke2NsZXJrSWR9YCwgdHRsLCBKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpO1xyXG4gICAgYXdhaXQgcGlwZWxpbmUuZXhlYygpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgaW52YWxpZGF0ZVVzZXJDYWNoZShjbGVya0lkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZVBhdHRlcm4oYHVzZXI6Kjoke2NsZXJrSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRFdmVudHMocXVlcnk6IHN0cmluZyk6IFByb21pc2U8RXZlbnREYXRhW10gfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYGV2ZW50czoke3F1ZXJ5fWApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2V0RXZlbnRzKHF1ZXJ5OiBzdHJpbmcsIGV2ZW50czogRXZlbnREYXRhW10sIHR0bCA9IDYwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zZXQoYGV2ZW50czoke3F1ZXJ5fWAsIGV2ZW50cywgdHRsKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGludmFsaWRhdGVFdmVudHNDYWNoZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZVBhdHRlcm4oJ2V2ZW50czoqJyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXREYXNoYm9hcmRTdGF0cyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8RGFzaGJvYXJkU3RhdHMgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYGRhc2hib2FyZDpzdGF0czoke3VzZXJJZH1gKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNldERhc2hib2FyZFN0YXRzKHVzZXJJZDogc3RyaW5nLCBzdGF0czogRGFzaGJvYXJkU3RhdHMsIHR0bCA9IDMwMCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zZXQoYGRhc2hib2FyZDpzdGF0czoke3VzZXJJZH1gLCBzdGF0cywgdHRsKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGludmFsaWRhdGVEYXNoYm9hcmRTdGF0cyh1c2VySWQ/OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICh1c2VySWQpIHtcclxuICAgICAgYXdhaXQgdGhpcy5kZWwoYGRhc2hib2FyZDpzdGF0czoke3VzZXJJZH1gKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZVBhdHRlcm4oJ2Rhc2hib2FyZDpzdGF0czoqJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBcclxuICBhc3luYyBpbmNyZW1lbnRSYXRlTGltaXQoa2V5OiBzdHJpbmcsIHdpbmRvd1NlY29uZHM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8eyBhbGxvd2VkOiBib29sZWFuOyByZW1haW5pbmc6IG51bWJlciB9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjdXJyZW50ID0gYXdhaXQgdGhpcy5yZWRpcy5pbmNyKGtleSk7XHJcbiAgICAgIGlmIChjdXJyZW50ID09PSAxKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpcy5leHBpcmUoa2V5LCB3aW5kb3dTZWNvbmRzKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBhbGxvd2VkOiBjdXJyZW50IDw9IGxpbWl0LFxyXG4gICAgICAgIHJlbWFpbmluZzogTWF0aC5tYXgoMCwgbGltaXQgLSBjdXJyZW50KVxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoYEVycm9yIGNoZWNraW5nIHJhdGUgbGltaXQgZm9yICR7a2V5fWAsIGVycm9yIGFzIEVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgYWxsb3dlZDogdHJ1ZSwgcmVtYWluaW5nOiBsaW1pdCB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgXHJcbiAgYXN5bmMgc2V0U2Vzc2lvbihzZXNzaW9uSWQ6IHN0cmluZywgZGF0YTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sIHR0bCA9IDg2NDAwKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLnNldChgc2Vzc2lvbjoke3Nlc3Npb25JZH1gLCBkYXRhLCB0dGwpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0U2Vzc2lvbihzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgdW5rbm93bj4gfCBudWxsPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXQoYHNlc3Npb246JHtzZXNzaW9uSWR9YCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBkZWxldGVTZXNzaW9uKHNlc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCB0aGlzLmRlbChgc2Vzc2lvbjoke3Nlc3Npb25JZH1gKTtcclxuICB9XHJcblxyXG4gIFxyXG4gIGFzeW5jIHBpbmcoKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMucmVkaXMucGluZygpO1xyXG4gICAgICByZXR1cm4gcmVzcG9uc2UgPT09ICdQT05HJztcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgbG9nZ2VyLmVycm9yKCdSZWRpcyBwaW5nIGZhaWxlZCcsIGVycm9yIGFzIEVycm9yKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgXHJcbiAgYXN5bmMgZGlzY29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMucmVkaXMucXVpdCgpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGRpc2Nvbm5lY3RpbmcgZnJvbSBSZWRpczonLCBlcnJvciBhcyBFcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGNhY2hlID0gQ2FjaGVTZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbmV4cG9ydCBkZWZhdWx0IHJlZGlzO1xyXG4iXSwidmVyc2lvbiI6M30=